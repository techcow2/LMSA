<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, viewport-fit=cover, interactive-widget=resizes-content">
    <meta name="description" content="LM Studio Assistant - A modern interface for AI chat interactions">
    <meta name="theme-color" content="#0f172a">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- Basic meta tags -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="renderer" content="webkit">
    <meta name="color-scheme" content="dark light">
    <title>LMSA • AI Assistant</title>
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="stylesheet" href="css/tailwind-local.css">
    <!-- Google Fonts with optimized loading and memory management -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/theme-variables.css">
    <link rel="stylesheet" href="css/modern-ui.css">
    <link rel="stylesheet" href="css/settings-modal.css">
    <link rel="stylesheet" href="css/system-prompt-overlay.css">
    <link rel="stylesheet" href="css/code-blocks.css">
    <link rel="stylesheet" href="css/performance-optimizations.css">
    <link rel="stylesheet" href="css/terms-modal.css">
    <link rel="stylesheet" href="css/age-gate.css">

    <!-- Font Awesome with optimized loading -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    <!-- Marked.js is now lazy-loaded when needed to reduce initial memory footprint -->
    <!-- JSZip Library for DOCX file processing - now lazy-loaded -->
    <script>
        // Lazy load JSZip only when needed
        window.loadJSZipLibrary = function() {
            return new Promise((resolve, reject) => {
                if (window.JSZip) {
                    resolve(window.JSZip);
                    return;
                }
                
                if (window._jsZipLoading) {
                    window._jsZipLoading.then(resolve).catch(reject);
                    return;
                }
                
                window._jsZipLoading = new Promise((loadResolve, loadReject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    script.integrity = 'sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==';
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        console.log('JSZip loaded successfully');
                        loadResolve(window.JSZip);
                    };
                    script.onerror = (e) => {
                        console.error('Failed to load JSZip:', e);
                        loadReject(e);
                    };
                    document.head.appendChild(script);
                });
                
                window._jsZipLoading.then(resolve).catch(reject);
            });
        };
    </script>
    
    <!-- Tesseract.js for OCR functionality - now lazy-loaded -->
    <script>
        // Lazy load Tesseract only when needed
        window.loadTesseractLibrary = function() {
            return new Promise((resolve, reject) => {
                if (window.Tesseract) {
                    resolve(window.Tesseract);
                    return;
                }
                
                if (window._tesseractLoading) {
                    window._tesseractLoading.then(resolve).catch(reject);
                    return;
                }
                
                window._tesseractLoading = new Promise((loadResolve, loadReject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.4/dist/tesseract.min.js';
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        console.log('Tesseract loaded successfully');
                        loadResolve(window.Tesseract);
                    };
                    script.onerror = (e) => {
                        console.error('Failed to load Tesseract:', e);
                        loadReject(e);
                    };
                    document.head.appendChild(script);
                });
                
                window._tesseractLoading.then(resolve).catch(reject);
            });
        };
    </script>
    
    <!-- PDF.js will be loaded directly when needed -->
    <script>
        // Simple PDF.js loader that avoids module conflicts
        window.loadPDFLibrary = function() {
            return new Promise((resolve, reject) => {
                // Check if PDF.js is already available
                if (window.pdfjsLib || window.PDFJS) {
                    console.log('PDF.js already available, skipping load');
                    resolve();
                    return;
                }
                
                // Check if we're already loading PDF.js to prevent duplicate loads
                if (window._pdfJsLoading) {
                    console.log('PDF.js already loading, waiting for completion...');
                    window._pdfJsLoading.then(resolve).catch(reject);
                    return;
                }
                
                console.log('Loading PDF.js via direct script inclusion...');
                
                // Mark that we're loading PDF.js
                window._pdfJsLoading = new Promise((loadResolve, loadReject) => {
                    // Create a unique script element to avoid conflicts
                    const script = document.createElement('script');
                    script.id = 'pdfjs-loader-' + Date.now();
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                    
                    script.onload = function() {
                        console.log('PDF.js script loaded, checking availability...');
                        
                        // Multiple attempts to find the library
                        let attempts = 0;
                        const maxAttempts = 10;
                        
                        const checkLibrary = () => {
                            attempts++;
                            
                            if (window.pdfjsLib) {
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                                console.log('PDF.js found as pdfjsLib and configured successfully');
                                loadResolve();
                            } else if (window.PDFJS) {
                                window.pdfjsLib = window.PDFJS;
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                                console.log('PDF.js found as PDFJS and configured successfully');
                                loadResolve();
                            } else if (attempts < maxAttempts) {
                                console.log(`PDF.js not available yet, attempt ${attempts}/${maxAttempts}, retrying...`);
                                setTimeout(checkLibrary, 100);
                            } else {
                                console.error('PDF.js failed to load after multiple attempts');
                                loadReject(new Error('PDF.js failed to load after multiple attempts'));
                            }
                        };
                        
                        // Start checking immediately
                        checkLibrary();
                    };
                    
                    script.onerror = function(e) {
                        console.error('PDF.js script load error:', e);
                        loadReject(new Error('Failed to load PDF.js script'));
                    };
                    
                    document.head.appendChild(script);
                });
                
                window._pdfJsLoading.then(resolve).catch(reject);
            });
        };
    </script>
    <!-- Simple code highlighting using pre/code -->
    <script>
        // Simple code highlighting function using pre/code
        window.renderCodeWithFallback = function(container, code, language) {
            // Clean up any existing content
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            // Create simple pre/code elements
            const pre = document.createElement('pre');
            pre.className = 'fallback-code';
            pre.style.position = 'relative';

            const codeEl = document.createElement('code');
            if (language) {
                codeEl.className = `language-${language}`;
            }
            codeEl.textContent = code;

            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'fallback-copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.style.position = 'absolute';
            copyBtn.style.top = '5px';
            copyBtn.style.right = '5px';
            copyBtn.style.zIndex = '10';
            copyBtn.style.padding = '5px';
            copyBtn.style.background = 'rgba(30, 30, 30, 0.8)';
            copyBtn.style.border = 'none';
            copyBtn.style.borderRadius = '3px';
            copyBtn.style.cursor = 'pointer';

            copyBtn.addEventListener('click', function() {
                const originalHTML = copyBtn.innerHTML;

                // Use the improved copyToClipboard function if available, otherwise fallback
                const copyFunction = window.copyToClipboard || function(text) {
                    return navigator.clipboard.writeText(text);
                };

                copyFunction(code)
                    .then(() => {
                        // Show copied indication
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('Failed to copy code:', error);
                        copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    });
            });

            pre.appendChild(codeEl);
            pre.appendChild(copyBtn);
            container.appendChild(pre);

            // Mark this container as using fallback
            container.setAttribute('data-using-fallback', 'true');

            return pre;
        };

        // Monaco Editor removed - using fallback code highlighting only
    </script>
    
    <!-- JSZip Library for DOCX file processing - now lazy-loaded -->
    <script>
        // Lazy load JSZip only when needed
        window.loadJSZipLibrary = function() {
            return new Promise((resolve, reject) => {
                if (window.JSZip) {
                    resolve(window.JSZip);
                    return;
                }
                
                if (window._jsZipLoading) {
                    window._jsZipLoading.then(resolve).catch(reject);
                    return;
                }
                
                window._jsZipLoading = new Promise((loadResolve, loadReject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                    script.integrity = 'sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==';
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        console.log('JSZip loaded successfully');
                        loadResolve(window.JSZip);
                    };
                    script.onerror = (e) => {
                        console.error('Failed to load JSZip:', e);
                        loadReject(e);
                    };
                    document.head.appendChild(script);
                });
                
                window._jsZipLoading.then(resolve).catch(reject);
            });
        };
    </script>
    
    <!-- Tesseract.js for OCR functionality - now lazy-loaded -->
    <script>
        // Lazy load Tesseract only when needed
        window.loadTesseractLibrary = function() {
            return new Promise((resolve, reject) => {
                if (window.Tesseract) {
                    resolve(window.Tesseract);
                    return;
                }
                
                if (window._tesseractLoading) {
                    window._tesseractLoading.then(resolve).catch(reject);
                    return;
                }
                
                window._tesseractLoading = new Promise((loadResolve, loadReject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@4.1.4/dist/tesseract.min.js';
                    script.crossOrigin = 'anonymous';
                    script.onload = () => {
                        console.log('Tesseract loaded successfully');
                        loadResolve(window.Tesseract);
                    };
                    script.onerror = (e) => {
                        console.error('Failed to load Tesseract:', e);
                        loadReject(e);
                    };
                    document.head.appendChild(script);
                });
                
                window._tesseractLoading.then(resolve).catch(reject);
            });
        };
    </script>
    
    <!-- PDF.js will be loaded directly when needed -->
    <script>
        // Simple PDF.js loader that avoids module conflicts
        window.loadPDFLibrary = function() {
            return new Promise((resolve, reject) => {
                // Check if PDF.js is already available
                if (window.pdfjsLib || window.PDFJS) {
                    console.log('PDF.js already available, skipping load');
                    resolve();
                    return;
                }
                
                // Check if we're already loading PDF.js to prevent duplicate loads
                if (window._pdfJsLoading) {
                    console.log('PDF.js already loading, waiting for completion...');
                    window._pdfJsLoading.then(resolve).catch(reject);
                    return;
                }
                
                console.log('Loading PDF.js via direct script inclusion...');
                
                // Mark that we're loading PDF.js
                window._pdfJsLoading = new Promise((loadResolve, loadReject) => {
                    // Create a unique script element to avoid conflicts
                    const script = document.createElement('script');
                    script.id = 'pdfjs-loader-' + Date.now();
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                    
                    script.onload = function() {
                        console.log('PDF.js script loaded, checking availability...');
                        
                        // Multiple attempts to find the library
                        let attempts = 0;
                        const maxAttempts = 10;
                        
                        const checkLibrary = () => {
                            attempts++;
                            
                            if (window.pdfjsLib) {
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                                console.log('PDF.js found as pdfjsLib and configured successfully');
                                loadResolve();
                            } else if (window.PDFJS) {
                                window.pdfjsLib = window.PDFJS;
                                window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                                console.log('PDF.js found as PDFJS and configured successfully');
                                loadResolve();
                            } else if (attempts < maxAttempts) {
                                console.log(`PDF.js not available yet, attempt ${attempts}/${maxAttempts}, retrying...`);
                                setTimeout(checkLibrary, 100);
                            } else {
                                console.error('PDF.js failed to load after multiple attempts');
                                loadReject(new Error('PDF.js failed to load after multiple attempts'));
                            }
                        };
                        
                        // Start checking immediately
                        checkLibrary();
                    };
                    
                    script.onerror = function(e) {
                        console.error('PDF.js script load error:', e);
                        loadReject(new Error('Failed to load PDF.js script'));
                    };
                    
                    document.head.appendChild(script);
                });
                
                window._pdfJsLoading.then(resolve).catch(reject);
            });
        };
    </script>
    <!-- Simple code highlighting using pre/code -->
    <script>
        // Simple code highlighting function using pre/code
        window.renderCodeWithFallback = function(container, code, language) {
            // Clean up any existing content
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            // Create simple pre/code elements
            const pre = document.createElement('pre');
            pre.className = 'fallback-code';
            pre.style.position = 'relative';

            const codeEl = document.createElement('code');
            if (language) {
                codeEl.className = `language-${language}`;
            }
            codeEl.textContent = code;

            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'fallback-copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.style.position = 'absolute';
            copyBtn.style.top = '5px';
            copyBtn.style.right = '5px';
            copyBtn.style.zIndex = '10';
            copyBtn.style.padding = '5px';
            copyBtn.style.background = 'rgba(30, 30, 30, 0.8)';
            copyBtn.style.border = 'none';
            copyBtn.style.borderRadius = '3px';
            copyBtn.style.cursor = 'pointer';

            copyBtn.addEventListener('click', function() {
                const originalHTML = copyBtn.innerHTML;

                // Use the improved copyToClipboard function if available, otherwise fallback
                const copyFunction = window.copyToClipboard || function(text) {
                    return navigator.clipboard.writeText(text);
                };

                copyFunction(code)
                    .then(() => {
                        // Show copied indication
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('Failed to copy code:', error);
                        copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    });
            });

            pre.appendChild(codeEl);
            pre.appendChild(copyBtn);
            container.appendChild(pre);

            // Mark this container as using fallback
            container.setAttribute('data-using-fallback', 'true');

            return pre;
        };

        // Monaco Editor removed - using fallback code highlighting only
    </script>
    <style>





        /* Improved styling for the form container */
        .contact-form-container {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }


        /* Button animations */
        #official-website-link.active-scale {
            transform: scale(0.95);
            opacity: 0.9;
        }

        #official-website-link {
            position: relative;
            overflow: hidden;
        }

        .input-glow {
            border-color: #3b82f6 !important;
            outline: none;
        }


        /* Hide scrollbars but keep content scrollable */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }

        /* Exception for settings modal content wrapper - show scrollbar */
        #settings-content-wrapper::-webkit-scrollbar {
            display: block !important;
            width: 8px;
        }

        /* Help modal specific scrollbar styles */
        #help-modal .help-modal-content::-webkit-scrollbar {
            display: block !important;
            width: 8px;
        }

        #help-modal .help-modal-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        #help-modal .help-modal-content::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 4px;
            border: 2px solid var(--scrollbar-track);
        }

        #help-modal .help-modal-content::-webkit-scrollbar-thumb:hover,
        #help-modal .help-modal-content::-webkit-scrollbar-thumb:active {
            background-color: var(--scrollbar-thumb-hover);
        }

        /* Table of Contents styles */
        .toc-link {
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        .toc-link:hover {
            background-color: rgba(59, 130, 246, 0.1) !important;
            transform: translateX(4px);
        }

        .toc-link:active {
            background-color: rgba(59, 130, 246, 0.2) !important;
            transform: scale(0.98);
        }

        /* Light theme adjustments for TOC */
        body.light-theme .toc-link:hover {
            background-color: rgba(59, 130, 246, 0.15) !important;
        }

        body.light-theme .toc-link:active {
            background-color: rgba(59, 130, 246, 0.25) !important;
        }

        /* Scroll to Top Button container animation */
        #help-scroll-to-top-container {
            transition: all 0.3s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #help-scroll-to-top-container.show {
            animation: fadeInDown 0.3s ease-out;
        }

        /* Help Modal Title Gradient - works in both themes */
        #help-title .bg-gradient-to-r {
            background-image: linear-gradient(to right, #3b82f6, #8b5cf6, #3b82f6);
            -webkit-background-clip: text;
            background-clip: text;
        }

        /* Light theme - slightly darker gradient for better visibility */
        body.light-theme #help-title .bg-gradient-to-r {
            background-image: linear-gradient(to right, #2563eb, #7c3aed, #2563eb);
        }
    </style>
</head>
<body class="dark custom-dark-mode" style="min-height: 100vh; min-height: -webkit-fill-available; display: flex; flex-direction: column;">

    <!-- Age Verification Modal -->
    <div id="age-gate-modal" class="age-gate-modal">
    <script>
        // Immediately check verification status to prevent flash on refresh
        (function() {
            var isAgeVerified = localStorage.getItem('lmsa_age_verified') === 'true';
            var termsAccepted = localStorage.getItem('lmsa_terms_accepted') === 'true';
            var termsVersion = localStorage.getItem('lmsa_terms_version');
            var currentTermsVersion = '2025-11-07';

            if (isAgeVerified) {
                document.getElementById('age-gate-modal').style.display = 'none';
            }

            // Also hide terms modal if already accepted current version
            if (termsAccepted && termsVersion === currentTermsVersion) {
                var termsModal = document.getElementById('terms-modal');
                if (termsModal && !termsModal.classList.contains('hidden')) {
                    termsModal.classList.add('hidden');
                }
            }
        })();
    </script>
        <div class="age-gate-content">
            <div class="age-gate-icon">
                <i class="fas fa-shield-alt"></i>
            </div>

            <h2 class="age-gate-title">Age Verification Required</h2>

            <p class="age-gate-description">
                Please verify your age to continue.
            </p>

            <form id="age-gate-form" class="age-gate-form">
                <div class="wheel-picker-container">
                    <div class="wheel-picker-column">
                        <label class="wheel-picker-label">Month</label>
                        <div class="wheel-picker-wrapper">
                            <div class="wheel-picker-wheel" id="month-wheel">
                                <div class="wheel-picker-items">
                                    <!-- Months will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="wheel-picker-centerline"></div>
                            <div class="wheel-picker-fade-top"></div>
                            <div class="wheel-picker-fade-bottom"></div>
                        </div>
                    </div>

                    <div class="wheel-picker-column">
                        <label class="wheel-picker-label">Day</label>
                        <div class="wheel-picker-wrapper">
                            <div class="wheel-picker-wheel" id="day-wheel">
                                <div class="wheel-picker-items">
                                    <!-- Days will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="wheel-picker-centerline"></div>
                            <div class="wheel-picker-fade-top"></div>
                            <div class="wheel-picker-fade-bottom"></div>
                        </div>
                    </div>

                    <div class="wheel-picker-column">
                        <label class="wheel-picker-label">Year</label>
                        <div class="wheel-picker-wrapper">
                            <div class="wheel-picker-wheel" id="year-wheel">
                                <div class="wheel-picker-items">
                                    <!-- Years will be populated by JavaScript -->
                                </div>
                            </div>
                            <div class="wheel-picker-centerline"></div>
                            <div class="wheel-picker-fade-top"></div>
                            <div class="wheel-picker-fade-bottom"></div>
                        </div>
                    </div>
                </div>

                <div id="age-verification-error" class="age-verification-error hidden">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span></span>
                </div>

                <button type="button" id="verify-age-btn" class="verify-age-btn">
                    Verify Age
                </button>
            </form>

            <p class="privacy-note">
                Your date of birth is only used to verify your age and is not stored after verification.
                By continuing, you confirm that you are at least 18 years old.
            </p>
        </div>
    </div>

    <!-- Terms of Service Acceptance Modal -->
    <div id="terms-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Terms of Service</h2>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Effective Date: 11/7/2025</p>
            </div>

            <!-- Terms Content -->
            <div id="terms-content" class="flex-1 overflow-y-auto p-6 text-sm text-gray-700 dark:text-gray-300 leading-relaxed">
                <p class="mb-4">Please read these Terms of Service ("Terms") carefully before using the LMSA: Chat with LM Studio mobile application ("App").</p>

                <p class="mb-4">By clicking "I Agree" or by downloading, installing, or using the App, you ("User") agree to be bound by these Terms. If you do not agree to these Terms, you may not use the App.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">1. Description of Service</h3>

                <p class="mb-4">LMSA: Chat with LM Studio is a mobile application that acts as a client interface and remote control for LM Studio, a separate application that runs on your personal computer ("PC"). The App's sole function is to facilitate communication between your Android device and a local server hosted by LM Studio on your PC. The App allows you to send prompts to, receive responses from, and manage the AI models loaded within your own instance of LM Studio.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">2. Acknowledgment of Local and Private Operation</h3>

                <p class="mb-4">You acknowledge and agree that:</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li>The App does not connect to any external internet servers or services operated by the developer of this App.</li>
                    <li>All communications, including your prompts and the AI model's responses, occur exclusively over your local network between your Android device and your PC.</li>
                    <li>The App's developer has no ability to access, view, store, or intercept any of your communications or chat history. Your chat history is stored locally on your device using browser storage.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">3. Affiliation Disclaimer</h3>

                <p class="mb-4">This application is an independent, third-party product. This app is not developed by, endorsed by, sponsored by, or affiliated in any way with LM Studio or its creators. All product and company names are trademarks™ or registered® trademarks of their respective holders. Use of them does not imply any affiliation with or endorsement by them.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">4. The App as a Conduit; No Control Over AI Models</h3>

                <p class="mb-4">You understand and agree that the App is a tool or interface only. It does not generate, select, modify, or control the content ("AI Responses") produced by the AI models you choose to run in LM Studio. The App is merely a conduit for your requests to be sent to, and responses to be received from, the AI models you have loaded and are running on your own PC. The App's developer is not a provider of the AI service and has no control over the AI models, their training data, or the content they generate.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">5. User Responsibility and Assumption of Risk</h3>

                <p class="mb-4">You are solely and entirely responsible for all AI models you choose to download, load, use, and interact with through the App. Your use of AI models is at your own risk. You acknowledge that AI Responses may be inaccurate, incomplete, biased, offensive, or harmful. The App's developer makes no representation or warranty regarding the accuracy, reliability, or safety of any AI Responses.</p>

                <p class="mb-4">You specifically assume all risks associated with interacting with AI-generated content, including but not limited to:</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li>Reliance on incorrect or misleading information.</li>
                    <li>Exposure to offensive, defamatory, or otherwise objectionable content.</li>
                    <li>Psychological distress or harm caused by AI Responses, including content that may encourage self-harm or other dangerous acts.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">6. Warning on Mental Health and Self-Harm</h3>

                <p class="mb-4"><strong>WARNING:</strong> AI Responses are not a substitute for professional mental health support or therapy. The AI models you interact with are not trained mental health professionals and may provide dangerous, irresponsible, or harmful advice. The App's developer is not responsible for any AI Responses you receive. If you are struggling with suicidal thoughts, self-harm, or any mental health issues, please seek immediate help from a qualified professional. You can find resources by calling or texting 988 in the US & Canada, or by contacting the International Association for Suicide Prevention for global resources. Your use of this App for sensitive mental health topics is done at your own extreme risk.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">7. No Warranty</h3>

                <p class="mb-4">The App is provided on an "AS IS" and "AS AVAILABLE" basis, without any warranties of any kind, either express or implied. The App's developer disclaims all warranties, including, but not limited to, warranties of merchantability, fitness for a particular purpose, and non-infringement. The App's developer does not guarantee that the App will be error-free or uninterrupted.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">8. Limitation of Liability and Indemnification</h3>

                <p class="mb-4">To the fullest extent permitted by law, you agree to indemnify, defend, and hold harmless the App's developer, and its affiliates, officers, directors, employees, and agents, from and against any and all claims, liabilities, damages, losses, or expenses (including but not limited to attorneys' fees) arising from or in any way related to:</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li>Your use of the App.</li>
                    <li>Your choice to download, load, and use any specific AI model accessed through the App.</li>
                    <li>Any AI Responses you receive or act upon.</li>
                    <li>Any harm, whether psychological or physical, that you or any third party may suffer as a result of AI Responses.</li>
                    <li>Your violation of these Terms.</li>
                </ul>

                <p class="mb-4">In no event shall the App's developer be liable for any indirect, incidental, special, consequential, or punitive damages, including without limitation, loss of profits, data, use, goodwill, or other intangible losses, resulting from your use of the App.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">9. No Professional Advice</h3>

                <p class="mb-4">AI Responses provided through the App are not a substitute for professional advice. You must not rely on the AI Responses as a basis for any medical, legal, financial, or other professional decisions. Always consult with a qualified professional for such matters.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">10. Termination</h3>

                <p class="mb-4">The App's developer may, in its sole discretion, terminate or suspend your access to the App at any time, for any reason, including for a breach of these Terms.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">11. Governing Law</h3>

                <p class="mb-4">These Terms shall be governed by and construed in accordance with the laws of the State of Michigan, USA, without regard to its conflict of law principles.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">12. Changes to Terms</h3>

                <p class="mb-4">The App's developer reserves the right to modify these Terms at any time. If we make material changes, we will notify you by updating the date at the top of these Terms and requiring you to accept the new terms before you can continue to use the App.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">13. Contact Information</h3>

                <p class="mb-4">If you have any questions about these Terms, please contact us at: <a href="mailto:support@lmsa.app" class="text-blue-600 dark:text-blue-400 underline">support@lmsa.app</a></p>

                <!-- Scroll indicator for validation -->
                <div id="scroll-indicator" class="mt-6 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg text-yellow-800 dark:text-yellow-200 text-sm">
                    <i class="fas fa-info-circle mr-2"></i>
                    Please scroll to the bottom of the terms to enable the accept button.
                </div>
            </div>

            <!-- Modal Footer - Acceptance Mode -->
            <div id="terms-acceptance-footer" class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button id="accept-terms-btn" disabled class="w-full bg-gray-300 dark:bg-gray-600 text-gray-500 dark:text-gray-400 font-semibold py-3 px-6 rounded-lg cursor-not-allowed transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>
                    I Agree to Terms of Service
                </button>
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-3">
                    You must accept the terms to use LMSA.
                </p>
              </div>

            <!-- Modal Footer - Review Mode -->
            <div id="terms-review-footer" class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 hidden">
                <div id="review-scroll-indicator" class="text-sm text-blue-600 dark:text-blue-400 mb-3 text-center hidden">
                    <i class="fas fa-arrow-down mr-1"></i>
                    Please scroll to the bottom to review all terms
                </div>
                <button id="close-terms-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
                <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-3">
                    You have already accepted these terms. This is for review purposes only.
                </p>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-policy-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] flex flex-col shadow-2xl">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Privacy Policy</h2>
                <p class="text-sm text-gray-600 dark:text-gray-700 mt-1">Effective Date: 11/8/2025</p>
            </div>

            <!-- Privacy Policy Content -->
            <div class="flex-1 overflow-y-auto p-6 text-sm text-gray-700 dark:text-gray-800 leading-relaxed">
                <p class="mb-4">This Privacy Policy describes how the LMSA: Chat with LM Studio mobile application ("App") handles your information. We are committed to protecting your privacy and ensuring that your data is handled in a safe and responsible manner. By using our App, you agree to the collection and use of information in accordance with this policy.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">1. Information We Do Not Collect</h3>

                <p class="mb-4">Your privacy is a core principle of our App's design. The App is built to function entirely on your local network and device. Therefore, we do not collect, store, or transmit any of the following:</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li><strong>Personal Information:</strong> We do not collect your name, email address, phone number, or any other personally identifiable information through the App's functionality.</li>
                    <li><strong>Chat Content:</strong> We do not collect, store, or transmit your chat prompts or the AI responses you receive. All chat history is saved locally on your Android device and is never sent to our servers or any third-party server.</li>
                    <li><strong>AI Model Data:</strong> We do not have access to or collect any information about the AI models you are using in LM Studio on your PC.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">2. Information We Collect: Advertising and Purchases</h3>

                <p class="mb-4">The information we collect depends on whether you are using the free version of the App or have upgraded to the ad-free version.</p>

                <h4 class="font-semibold mt-4 mb-2">For Users of the Free, Ad-Supported Version:</h4>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li><strong>Advertising ID:</strong> To support the development and maintenance of this free App, we use Google AdMob to display advertisements. The App automatically collects and uses your device's Advertising ID (a unique, user-resettable identifier for advertising). This identifier is shared with Google's ad services to serve ads that are more relevant to you.</li>
                    <li><strong>Data Controller for Ads:</strong> Please be aware that Google is the data controller for any information collected through its advertising services. Our use of the Advertising ID is solely for the purpose of enabling these ads.</li>
                </ul>

                <h4 class="font-semibold mt-4 mb-2">For Users Who Purchase the Ad-Free Version:</h4>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li><strong>No Advertising Data:</strong> Once you purchase the ad-free version, all advertisements are removed from the App. As a result, your Advertising ID is not used for advertising purposes within this App.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">3. In-App Purchases and Payments</h3>

                <p class="mb-4">We offer a one-time in-app purchase to remove all advertisements.</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li><strong>Payment Processor:</strong> All payments are processed by Google Play. When you make a purchase, you are providing your information directly to Google, not to us.</li>
                    <li><strong>Information Collected by Google:</strong> To process your payment, Google will collect information such as your name, address, and payment details. This is governed by Google's own privacy policy.</li>
                    <li><strong>Information Received by the App:</strong> The App itself does not receive or store any of your personal payment information. We only receive a confirmation from Google Play that the purchase was successful to unlock the ad-free experience.</li>
                    <li><strong>Developer Access:</strong> As the developer, I may have access to limited transaction information (such as your name and country) through the Google Play Console for the purpose of managing sales, fulfilling orders, and providing customer support.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">4. How We Use Information</h3>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li>For free users, we use the Advertising ID solely for the purpose of displaying advertisements within the App.</li>
                    <li>For paid users, we do not use your information for advertising.</li>
                    <li>We do not use your information for any other purpose.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">5. Your Choices and Controls</h3>

                <p class="mb-4">You have control over the advertising you see.</p>

                <ul class="list-disc pl-6 mb-4 space-y-2">
                    <li><strong>Purchase Ad-Free Version:</strong> You can permanently remove all ads and the associated use of your Advertising ID by purchasing the ad-free upgrade within the App.</li>
                    <li><strong>Opt out of Personalized Ads:</strong> If you continue to use the free version, you can opt out of receiving personalized ads by adjusting the settings on your device. On most Android devices, go to Settings &gt; Google &gt; Ads, and then toggle "Opt out of Ads Personalization".</li>
                    <li><strong>Reset Advertising ID:</strong> You can also reset your Advertising ID at any time in the same settings menu.</li>
                    <li><strong>Google Ads Settings:</strong> For more control over your ad preferences across Google's services, visit <a href="https://adssettings.google.com" class="text-blue-600 dark:text-blue-400 underline">https://adssettings.google.com</a>.</li>
                </ul>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">6. Children's Privacy</h3>

                <p class="mb-4">Our App is not intended for use by anyone under the age of 18, in accordance with our Terms of Service. We do not knowingly collect any information from children under 18. If you are a parent or guardian and believe your child has provided us with information, please contact us immediately.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">7. Data Security</h3>

                <p class="mb-4">We take reasonable precautions to protect the security of the App. Since all your personal data is stored locally on your device, we recommend you secure your device with a passcode, biometrics, or other security measures.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">8. Changes to This Privacy Policy</h3>

                <p class="mb-4">We may update our Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page and updating the "Effective Date" at the top.</p>

                <h3 class="font-semibold text-lg mt-6 mb-3 text-gray-900 dark:text-white">9. Contact Us</h3>

                <p class="mb-4">If you have any questions about this Privacy Policy, please contact us at:</p>

                <p class="mb-4"><strong>Email:</strong> support@lmsa.app</p>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50">
                <button id="privacy-policy-close-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors duration-200">
                    <i class="fas fa-times mr-2"></i>
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container (initially hidden until terms accepted) -->
    <div id="main-app-container" class="hidden" style="min-height: 100vh; min-height: -webkit-fill-available; display: flex; flex-direction: column;">
        <!-- Header - Enhanced with modern styling and effects -->
        <header class="p-4 flex justify-between items-center">
            <div class="flex items-center flex-shrink-0">
                <div class="w-10 h-10 mr-3 relative overflow-hidden rounded-xl bg-gradient-to-br from-blue-500 to-indigo-700 shadow-xl flex items-center justify-center">
                    <img src="icon.png" alt="LMSA Icon" class="w-7 h-7 relative z-10">
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50"></div>
                </div>
                <h1 class="text-2xl font-bold header-title">LMSA</h1>
            </div>
            <div class="flex items-center space-x-1 header-controls">
                <button id="settings-icon-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="2" aria-label="Settings" title="Open settings">
                    <span class="icon-wrapper">
                        <i class="fas fa-cog text-xl header-icon"></i>
                    </span>
                </button>
                <button id="model-toggle-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="3" aria-label="Toggle Model Info" title="Toggle model info display">
                    <span class="icon-wrapper">
                        <i class="fas fa-robot text-xl header-icon"></i>
                    </span>
                </button>
                <button id="refresh-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="4" aria-label="Refresh Model" title="Refresh model from LM Studio">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </span>
                </button>
                <button id="new-chat-header-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="5" aria-label="New Chat" title="Start a new chat">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </span>
                </button>
                <button id="preview-toggle" class="p-2 rounded-md focus:outline-none relative header-btn" data-priority="6" aria-label="Toggle Mobile/Tablet View" title="Toggle between mobile and tablet view">
                    <div class="flex items-center">
                        <span class="icon-wrapper">
                            <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </span>
                        <span class="ml-1 text-xs font-medium hidden md:inline-block">View</span>
                    </div>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full hidden shadow-lg" id="view-mode-indicator"></div>
                </button>
                <button id="sidebar-toggle" class="p-2 rounded-md focus:outline-none header-btn" data-priority="1" aria-label="Toggle Sidebar">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </header>

        <!-- Model display bar with wrapper to prevent background issues -->
        <div id="loaded-model-wrapper">
            <div id="loaded-model" class="font-bold py-2 px-4 text-center"></div>
        </div>

        <!-- Sidebar overlay - for closing sidebar when clicking outside on mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-10 hidden backdrop-blur-sm sidebar-overlay" style="will-change: opacity; transform: none !important;"></div>

        <!-- Sidebar - now positioned fixed outside the flex container -->
        <div id="sidebar" class="w-[280px] z-20 hidden shadow-xl overflow-y-auto" style="color: var(--sidebar-text);">
            <div class="relative flex items-center justify-end p-6 border-b sidebar-header" style="border-color: var(--sidebar-border);">
                <button id="close-sidebar" class="p-2 rounded-full focus:outline-none close-sidebar-btn" style="color: var(--text-muted);" aria-label="Close Sidebar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Main Menu Section -->
            <div class="sidebar-section main-menu-section">
                <button id="new-chat" class="menu-item w-full text-left">
                    <i class="fas fa-plus-circle w-6 mr-3"></i>
                    New Chat
                </button>
            </div>

            <!-- Options Section -->
            <div class="sidebar-section collapsible">
                <button class="section-header w-full text-left flex items-center justify-between py-2 px-3">
                    <div class="flex items-center">
                        <i class="fas fa-cog w-6 mr-3"></i>
                        <span>Options</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="collapsible-content">
                    <!-- Settings -->
                    <button id="settings-btn" class="menu-item w-full text-left">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>

                    <!-- Import/Export -->
                    <button id="import-export-group-btn" class="menu-item w-full text-left flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-exchange-alt"></i>
                            Import/Export
                        </div>
                        <i class="fas fa-caret-down"></i>
                    </button>
                    <div id="import-export-container" class="hidden">
                        <button id="import-chats-btn" class="menu-item w-full text-left">
                            <i class="fas fa-file-import"></i>
                            Import Chats
                        </button>
                        <button id="export-chats-btn" class="menu-item w-full text-left">
                            <i class="fas fa-file-export"></i>
                            Export Chats
                        </button>
                    </div>

                    <!-- Model Settings -->
                    <button id="model-btn" class="menu-item w-full text-left">
                        <i class="fas fa-robot"></i>
                        Models
                    </button>

                    <!-- Saved System Prompts -->
                    <button id="saved-prompts-btn" class="menu-item w-full text-left">
                        <i class="fas fa-save"></i>
                        Saved Prompts
                    </button>

                      <!-- Help & About -->
                    <button id="help-btn" class="menu-item w-full text-left">
                        <i class="fas fa-question-circle"></i>
                        Help
                    </button>
                    <button id="whats-new-btn" class="menu-item w-full text-left">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        What's New
                    </button>
                    <button id="about-btn" class="menu-item w-full text-left">
                        <i class="fas fa-info-circle"></i>
                        About
                    </button>

                    <!-- Restore Purchase -->
                    <button id="restore-purchases-button" class="menu-item w-full text-left" onclick="restorePurchases()">
                        <i class="fas fa-undo"></i>
                        Restore Purchase
                    </button>

                    <!-- Legacy Access -->
                    <button id="legacy-access-btn" class="menu-item w-full text-left">
                        <i class="fas fa-key"></i>
                        Legacy Access
                    </button>

                    <!-- Terms of Service -->
                    <button id="terms-service-btn" class="menu-item w-full text-left">
                        <i class="fas fa-file-contract"></i>
                        Terms of Service
                    </button>

                    <!-- Privacy Policy -->
                    <button id="privacy-policy-btn" class="menu-item w-full text-left">
                        <i class="fas fa-shield-alt"></i>
                        Privacy Policy
                    </button>

                </div>
            </div>

            <!-- Characters Section -->
            <!-- Removed sidebar-section characters-section for mobile side menu as requested -->

            <!-- Chat History Section -->
            <div class="sidebar-section">
                <div class="w-full text-left flex items-center py-2 px-3 mb-2">
                    <i class="fas fa-comments w-6 mr-3 chat-history-icon"></i>
                    <span class="chat-history-title">CHAT HISTORY</span>
                </div>
                <div id="chat-history" class="overflow-y-auto max-h-[calc(100vh-200px)] px-2">
                    <!-- Chat history items will be dynamically added here -->
                </div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Main content -->
            <div class="flex-1 flex flex-col overflow-hidden" style="transform: none !important; display: flex; flex-direction: column; min-height: 0; background-color: var(--bg-primary);">
                <!-- Chat container -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 flex flex-col relative">
                    <div id="welcome-message" class="absolute inset-0 flex items-center justify-center text-center" style="transform: none !important; left: 0; right: 0; color: var(--text-muted);" onscroll="return false;">
                        <div class="welcome-content glass-card p-8 sm:p-10 max-w-md mx-auto">
                            <div class="relative mx-auto mb-4 sm:mb-6 mt-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl flex items-center justify-center icon-container" style="width: 5.5rem; height: 5.5rem; min-height: 5rem; min-width: 5rem; padding: 0.75rem;">
                                <img src="icon.png" alt="LMSA Icon" class="relative z-10 object-contain" style="width: 3.5rem; height: 3.5rem; max-width: 75%; max-height: 75%;">
                                <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50"></div>
                                <div class="absolute -top-8 -left-8 sm:-top-10 sm:-left-10 w-16 h-16 sm:w-20 sm:h-20 bg-white/10 rounded-full blur-xl"></div>
                                <div class="absolute -bottom-8 -right-8 sm:-bottom-10 sm:-right-10 w-16 h-16 sm:w-20 sm:h-20 bg-blue-400/10 rounded-full blur-xl"></div>
                            </div>

                            <h1 class="text-xl sm:text-2xl font-bold mb-2 tracking-tight header-title">LM Studio Assistant</h1>
                            <p class="mb-5 sm:mb-7 opacity-90 leading-relaxed text-sm sm:text-base">
                                LM Studio on your Android.
                            </p>

                            <div class="grid grid-cols-1 gap-4 mb-8">
                                <!-- Settings Button - Professional styling -->
                                <button id="get-started-btn" class="professional-button flex items-center justify-center gap-3 w-full h-[48px]">
                                    <i class="fas fa-cog text-sm"></i>
                                    <span>Settings</span>
                                </button>
                                <!-- Models Button - Professional styling -->
                                <button id="welcome-models-btn" class="professional-button flex items-center justify-center gap-3 w-full h-[48px]">
                                    <i class="fas fa-microchip text-sm"></i>
                                    <span>Models</span>
                                </button>

                                <!-- Secondary buttons in a 2-column grid with professional styling -->
                                <div class="grid grid-cols-2 gap-3 w-full">
                                    <button id="welcome-new-chat-btn" class="professional-button flex items-center justify-center gap-2 w-full h-[48px]">
                                        <i class="fas fa-bookmark text-sm"></i>
                                        <span>Saved</span>
                                    </button>

                                    <button id="welcome-help-btn" class="professional-button flex items-center justify-center gap-2 w-full h-[48px]">
                                        <i class="fas fa-question-circle text-sm"></i>
                                        <span>Help</span>
                                    </button>
                                </div>
                            </div>

                            <div id="welcome-footer" class="mt-8 pt-5 pb-3 border-t border-white/10 text-xs">
                                Version 8.8
                            </div>
                        </div>
                    </div>
                    <div id="messages" class="flex-1"></div>
                    <div id="loading-indicator" class="hidden" style="display: flex; align-items: center; text-align: left; direction: ltr;">
                        <span class="loading-ellipsis" style="display: inline-block; white-space: nowrap; text-align: left; direction: ltr;">...</span>
                    </div>
                </div>

                <!-- Input area -->
                <div style="position: relative; z-index: 10; width: 100%; box-sizing: border-box; margin-top: auto;">

                    <form id="chat-form" class="flex" style="position: relative; background-color: transparent;">
                        <div class="flex-grow relative">
                            <textarea id="user-input" class="w-full focus:outline-none" placeholder="Type your message..." aria-label="Type your message" autocomplete="off" wrap="soft" style="background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border);"></textarea>
                            <div class="absolute" style="top: 50%; right: 0.75rem; transform: translateY(-50%);">
                                <button type="button" id="paperclip-button" class="focus:outline-none p-1" style="color: var(--text-muted);">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-500 text-white focus:outline-none" aria-label="Send message">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane"></i>
                                <span class="ml-2 hidden md:inline">Send</span>
                            </div>
                        </button>
                        <button type="button" id="stop-button" class="bg-red-600 text-white hover:bg-red-700 focus:outline-none hidden">
                            <i class="fas fa-stop mr-1"></i><span>Stop</span>
                        </button>
                        <input type="file" id="file-upload-input" class="hidden" multiple>
                    </form>
                </div>

                <!-- Scroll to bottom button -->
                <button id="scroll-to-bottom" class="hidden" aria-label="Scroll to bottom of chat">
                    <i class="fas fa-arrow-down"></i>
                </button>

                <!-- Empty message modal -->
                <div id="empty-message-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden" aria-labelledby="empty-message-title" role="dialog" aria-modal="true">
                    <div class="bg-darkSecondary p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="empty-message-title" class="modal-title">Empty Message</h3>
                            <button class="close-modal text-gray-400 hover:text-white focus:outline-none">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="mb-6 text-gray-300">Please enter a message or attach a file before sending.</p>
                        <div class="flex justify-end">
                            <button class="close-modal bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
                                OK
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Image Upload Error Modal -->
                <div id="image-upload-error-modal" class="fixed inset-0 bg-black/70 dark:bg-black/70 light:bg-gray-900/50 backdrop-blur-sm items-center justify-center hidden z-[2050]" aria-labelledby="image-upload-error-title" role="dialog" aria-modal="true">
                    <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] dark:from-[#0a192f] dark:to-[#0d1f3d] light:from-[#f8fafc] light:to-[#f1f5f9] p-6 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-blue-900/30 dark:border-blue-900/30 light:border-blue-200 overflow-hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="image-upload-error-title" class="text-xl font-bold flex items-center modal-title text-blue-400 dark:text-blue-400 light:text-blue-600">
                                <i class="fas fa-info-circle mr-3 text-blue-500 dark:text-blue-500 light:text-blue-600"></i>
                                Image Upload Not Supported
                            </h3>
                            <button id="close-image-upload-error-modal" class="text-gray-400 hover:text-white dark:text-gray-400 dark:hover:text-white light:text-gray-600 light:hover:text-gray-800 focus:outline-none rounded-full w-8 h-8 flex items-center justify-center hover:bg-blue-900/20 dark:hover:bg-blue-900/20 light:hover:bg-blue-200/50">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="mb-6">
                            <p class="text-gray-300 dark:text-gray-300 light:text-gray-700 mb-4">The current model doesn't support image attachments. Only vision language models can process images.</p>
                            <p class="text-gray-400 dark:text-gray-400 light:text-gray-600 text-sm">You can still upload text files, documents (PDF, DOCX), and code files with the current model.</p>
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button id="image-upload-error-ok" class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-600 dark:hover:bg-blue-700 light:bg-blue-500 light:hover:bg-blue-600 text-white px-6 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/50">
                                OK
                            </button>
                        </div>
                    </div>
                </div>

                <!-- File removal confirmation modal -->
                <div id="file-removal-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50" aria-labelledby="file-removal-title" role="dialog" aria-modal="true">
                    <div class="modal-content bg-darkSecondary border border-gray-600 rounded-lg p-6 max-w-md mx-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-trash text-red-400"></i>
                            </div>
                            <h3 id="file-removal-title" class="text-lg font-semibold text-white">Remove File</h3>
                        </div>
                        
                        <div class="mb-6">
                            <p class="text-gray-300 mb-2">Are you sure you want to remove this file?</p>
                            <div class="bg-gray-800 rounded-lg p-3 flex items-center">
                                <i id="file-removal-icon" class="fas fa-file text-blue-400 mr-3 hidden"></i>
                                <span id="file-removal-name" class="text-gray-200 font-medium">filename.txt</span>
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="cancel-file-removal" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button id="confirm-file-removal" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <i class="fas fa-trash mr-2"></i>Remove
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete message confirmation modal -->
                <div id="delete-message-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden z-50" aria-labelledby="delete-message-title" role="dialog" aria-modal="true">
                    <div class="modal-content bg-darkSecondary border border-gray-600 rounded-lg p-6 max-w-md mx-4">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-trash text-red-400"></i>
                            </div>
                            <h3 id="delete-message-title" class="text-lg font-semibold text-white">Delete Message</h3>
                        </div>

                        <div class="mb-6">
                            <p class="text-gray-300 mb-2">Are you sure you want to delete this message?</p>
                            <p class="text-gray-400 text-sm">Only this message will be deleted.</p>
                        </div>

                        <div class="flex space-x-3">
                            <button id="cancel-delete-message" class="flex-1 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                                <i class="fas fa-times mr-2"></i>Cancel
                            </button>
                            <button id="confirm-delete-message" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500">
                                <i class="fas fa-trash mr-2"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved System Prompts Modal -->
    <div id="saved-prompts-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 1060; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="saved-prompts-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-8 rounded-2xl w-[600px] max-w-[90%] h-[60vh] shadow-2xl overflow-hidden flex flex-col modal-content border border-blue-400/50 dark:border-blue-400/50 light:border-blue-400/30 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 id="saved-prompts-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200">Saved System Prompts</h2>
                <button id="close-saved-prompts-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-3xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div id="saved-prompts-list" class="flex-1 overflow-y-auto">
                <!-- Saved prompts will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Save System Prompt Modal -->
    <div id="save-prompt-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 1070; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="save-prompt-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-8 rounded-2xl w-[500px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content border border-blue-400/50 dark:border-blue-400/50 light:border-blue-400/30 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 id="save-prompt-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200">Save System Prompt</h2>
                <button id="close-save-prompt-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div class="mb-4">
                <label for="save-prompt-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prompt Name</label>
                <input type="text" id="save-prompt-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter a name for this prompt" maxlength="100">
            </div>
            <div class="mb-6 flex-1 flex flex-col">
                <label for="save-prompt-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prompt Content</label>
                <textarea id="save-prompt-content" class="flex-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter the prompt content"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-save-prompt" class="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                <button id="save-prompt-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Prompt</button>
            </div>
        </div>
    </div>

    <!-- Edit System Prompt Modal -->
    <div id="edit-prompt-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 1070; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="edit-prompt-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-8 rounded-2xl w-[500px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content border border-blue-400/50 dark:border-blue-400/50 light:border-blue-400/30 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 id="edit-prompt-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200">Edit System Prompt</h2>
                <button id="close-edit-prompt-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div class="mb-4">
                <label for="edit-prompt-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prompt Name</label>
                <input type="text" id="edit-prompt-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter a name for this prompt" maxlength="100">
            </div>
            <div class="mb-6 flex-1 flex flex-col">
                <label for="edit-prompt-content" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prompt Content</label>
                <textarea id="edit-prompt-content" class="flex-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter the prompt content"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-edit-prompt" class="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                <button id="save-edit-prompt" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Delete Prompt Confirmation Modal -->
    <div id="delete-prompt-confirmation-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 1070; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="delete-prompt-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-8 rounded-2xl w-[500px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content border border-red-400/50 dark:border-red-400/50 light:border-red-400/30 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-6">
                <h2 id="delete-prompt-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200">Delete Prompt</h2>
                <button id="close-delete-prompt-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div class="mb-6">
                <p id="delete-prompt-message" class="text-gray-700 dark:text-gray-300">Are you sure you want to delete this prompt? This action cannot be undone.</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-delete-prompt" class="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                <button id="confirm-delete-prompt" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Delete</button>
            </div>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" class="fixed inset-0 items-center justify-center hidden modal-container" aria-labelledby="settings-title" role="dialog" aria-modal="true">
        <div class="modal-content">
            <!-- Settings Header -->
            <div class="flex flex-col sticky top-0 z-10 mb-6 pb-1 border-b border-gray-700/30 bg-inherit">
                <div class="flex justify-between items-center mb-2">
                    <h2 id="settings-title" class="text-xl font-bold flex items-center">
                        <i class="fas fa-cog text-blue-400 mr-2"></i>Settings
                    </h2>
                    <button id="close-settings-x" aria-label="Close settings">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Step indicators - visible on all screen sizes -->
                <div class="flex justify-center space-x-3 py-2">
                    <div class="w-8 h-2 rounded-full bg-blue-500" id="step-indicator-1"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600" id="step-indicator-2"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600" id="step-indicator-3"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600" id="step-indicator-4"></div>
                </div>
            </div>

            <!-- Settings Content - Multi-step on mobile -->
            <div id="settings-content-wrapper" class="relative px-1">
                <!-- Step 1: Connection Settings (always visible first) -->
                <div id="settings-step-connection" class="settings-step active" data-step-name="Connection">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-200">
                            <i class="fas fa-server mr-2 text-blue-400"></i>LM Studio Server Connection:</label>
                        <div class="flex space-x-2 ip-port-container">
                            <div class="flex-grow">
                                <label for="server-ip" class="block text-xs text-gray-300 mb-1">IP Address</label>
                                <input type="text" id="server-ip" class="w-full text-gray-100 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-400" placeholder="e.g. 192.168.1.100" pattern="^[0-9.]*$" inputmode="numeric" onkeypress="return event.charCode === 46 || (event.charCode >= 48 && event.charCode <= 57)" autocomplete="off" data-form-type="other">
                            </div>
                            <div class="w-32 port-input-container"> <!-- Increased width from w-28 to w-32 -->
                                <label for="server-port" class="block text-xs text-gray-300 mb-1">Port</label>
                                <input type="text" id="server-port" class="w-full text-gray-100 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-400" placeholder="1234" pattern="^[0-9]*$" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57" autocomplete="off" data-form-type="other">
                            </div>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">The complete URL will be automatically formatted as: http://<span class="text-blue-400">[IP]:[PORT]</span>/v1/chat/completions</p>
                    </div>
                </div>

                <!-- Step 2: System Prompt -->
                <div id="settings-step-prompt" class="settings-step hidden" data-step-name="Prompt">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">
                            <i class="fas fa-comment-dots mr-2 text-blue-400"></i>System Prompt (Optional):</label>

                        <!-- Hidden real textarea that holds the actual value -->
                        <textarea id="system-prompt" class="hidden" rows="4"></textarea>

                        <!-- Display current prompt value (non-interactive) -->
                        <div id="system-prompt-preview" class="border p-3 rounded-lg min-h-[80px] mb-2 whitespace-pre-wrap" style="background-color: var(--settings-input-bg); color: var(--settings-input-text); border-color: var(--settings-input-border);"><span class="italic" id="prompt-placeholder" style="color: var(--text-muted);">Leave empty to pass user messages directly to LM Studio without any system prompt</span></div>

                        <!-- Edit and Save buttons -->
                        <div class="flex gap-2">
                            <button id="edit-system-prompt-btn" class="professional-button flex items-center justify-center gap-3 flex-1 h-[48px]">
                                <i class="fas fa-edit text-sm"></i>
                                <span>Edit</span>
                            </button>
                            <button id="save-system-prompt-btn" class="professional-button flex items-center justify-center gap-3 flex-1 h-[48px]">
                                <i class="fas fa-save text-sm"></i>
                                <span>+ Add</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Options -->
                <div id="settings-step-options" class="settings-step hidden" data-step-name="Options">
                    <div class="mb-4">
                        <label for="temperature" class="block text-sm font-medium mb-1">
                            <i class="fas fa-sliders-h mr-2 text-blue-400"></i>Temperature: <span id="temperature-value">0.3</span></label>
                        <div class="flex items-center">
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.3" class="w-full bg-darkTertiary text-gray-100 rounded-lg appearance-none cursor-pointer" disabled>
                            <button id="temperature-lock" class="ml-2 text-gray-100 focus:outline-none p-2" aria-label="Toggle Temperature Lock" title="Temperature is locked (click to unlock)">
                                <i class="fas fa-lock text-red-400"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="hide-thinking" class="text-sm font-medium">
                                <i class="fas fa-eye-slash mr-2 text-blue-400"></i>Hide Thinking Text</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="hide-thinking">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, hides text between &lt;think&gt; tags in model responses</p>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="auto-generate-titles" class="text-sm font-medium">
                                <i class="fas fa-magic mr-2 text-blue-400"></i>Auto-Generate Chat Titles</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="auto-generate-titles">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, uses the LLM to generate a short title (2-3 words) that describes what the chat is about based on your first message.</p>
                    </div>

                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="auto-scroll" class="text-sm font-medium">
                                <i class="fas fa-arrow-down mr-2 text-blue-400"></i>Auto-Scroll to Bottom</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="auto-scroll">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, automatically scrolls to the bottom of the chat while the LLM is streaming its response.</p>
                    </div>

                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="theme-toggle" class="text-sm font-medium">
                                <i class="fas fa-moon mr-2 text-blue-400"></i>Light Theme</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="theme-toggle">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, switches the app to light theme. When disabled, uses the default dark theme.</p>
                    </div>

                    <div class="mb-5">
                        <label for="tts-voice-select" class="block text-sm font-medium mb-2">
                            <i class="fas fa-microphone mr-2 text-blue-400"></i>TTS Voice</label>
                        <select id="tts-voice-select" class="w-full bg-darkTertiary text-gray-100 rounded-lg px-3 py-2 border border-gray-600 focus:outline-none focus:border-blue-500">
                            <option value="">Loading voices...</option>
                        </select>
                        <p class="text-xs text-gray-400 mt-1">Select the text-to-speech voice for reading AI responses</p>
                    </div>



                </div>

                <!-- Step 4: Actions -->
                <div id="settings-step-actions" class="settings-step hidden" data-step-name="Actions">
                    <div class="mb-4">
                        <h3 class="text-sm font-medium mb-3 text-gray-200">
                            <i class="fas fa-bolt mr-2 text-blue-400"></i>Actions:</h3>
                        <button id="clear-chat" class="settings-action-button">
                            <i class="fas fa-trash-alt text-sm"></i>
                            <span>Clear All Chats</span>
                        </button>

                        <button id="reset-app" class="settings-action-button">
                            <i class="fas fa-exclamation-triangle text-sm"></i>
                            <span>Reset App</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation buttons container (static, above save button) -->
            <div id="settings-navigation-buttons" class="mt-5 mb-2">
                <!-- Connection step buttons -->
                <div class="flex justify-end navigation-buttons" id="connection-step-buttons">
                    <button id="to-prompt-step-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-right text-sm"></i>
                        <span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Prompt step buttons -->
                <div class="justify-between navigation-buttons hidden" id="prompt-step-buttons">
                    <button id="back-to-connection-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-left text-sm"></i>
                        <span class="button-text">Back</span>
                    </button>
                    <button id="to-options-step-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-right text-sm"></i>
                        <span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Options step buttons -->
                <div class="justify-between navigation-buttons hidden" id="options-step-buttons">
                    <button id="back-to-prompt-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-left text-sm"></i>
                        <span class="button-text">Back</span>
                    </button>
                    <button id="to-actions-step-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-right text-sm"></i>
                        <span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Actions step buttons -->
                <div class="justify-between navigation-buttons hidden" id="actions-step-buttons">
                    <button id="back-to-options-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-arrow-left text-sm"></i>
                        <span class="button-text">Back</span>
                    </button>
                    <button id="settings-help-btn" class="professional-button flex items-center justify-center gap-3 w-[48%] h-[48px]">
                        <i class="fas fa-question-circle text-sm"></i>
                        <span class="button-text">Help</span>
                    </button>
                </div>
            </div>

            <!-- Save button (always visible) -->
            <div class="mt-2">
                <button id="close-settings" class="professional-button flex items-center justify-center gap-3 w-full h-[52px]">
                    <i class="fas fa-check text-sm"></i>
                    <span>Apply Changes</span>
                </button>

                <!-- Simple divider -->
                <div class="flex justify-center mt-3">
                    <div class="h-[1px] w-1/2 bg-gray-600/30"></div>
                </div>
            </div>

            <script>
                // Add subtle hover effects for save button
                document.addEventListener('DOMContentLoaded', function() {
                    const saveBtn = document.getElementById('close-settings');

                    if (saveBtn) {
                        saveBtn.addEventListener('mouseover', function() {
                            this.style.boxShadow = '0 6px 10px rgba(0, 0, 0, 0.15)';
                            this.style.background = 'linear-gradient(to right, #047857, #10b981)';
                        });

                        saveBtn.addEventListener('mouseout', function() {
                            this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                            this.style.background = 'linear-gradient(to right, #059669, #10b981)';
                        });
                    }
                });
            </script>

            </div>
    </div>

    <!-- Confirmation modal for delete all chats (deprecated - kept for backward compatibility) -->
    <div id="delete-all-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden" role="dialog" aria-modal="true" style="display: none !important; visibility: hidden;">
        <div class="bg-darkSecondary p-6 rounded-lg w-96 max-w-[90%] shadow-lg">
            <h2 class="text-xl font-bold mb-4 flex items-center text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Delete All
            </h2>
            <p class="text-gray-300 mb-6">Are you sure you want to delete all chats? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-all" class="bg-gray-600 text-white rounded px-4 py-2 hover:bg-gray-700">Cancel</button>
                <button id="confirm-delete-all" class="bg-red-600 text-white rounded px-4 py-2 hover:bg-red-700">Delete All</button>
            </div>
        </div>
    </div>

    <!-- Confirmation modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden" aria-labelledby="confirmation-title" role="dialog" aria-modal="true" onclick="if(event.target === this) { document.getElementById('cancel-action').click(); }">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg mx-auto my-auto" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4 flex items-center modal-title">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>Confirm Action
            </h2>
            <p id="confirmation-message" class="mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-action" class="rounded-lg px-4 py-2 focus:outline-none" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-action" class="bg-red-600 text-white rounded-lg px-4 py-2 hover:bg-red-700 focus:outline-none">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Legacy Access Modal -->
    <div id="legacy-access-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden" aria-labelledby="legacy-access-title" role="dialog" aria-modal="true" onclick="if(event.target === this) { document.getElementById('legacy-access-close-btn').click(); }">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg mx-auto my-auto" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="legacy-access-title" class="text-xl font-bold mb-4 flex items-center modal-title">
                <i class="fas fa-key mr-2 text-blue-500"></i>Legacy Access
            </h2>
            <p class="mb-4 leading-relaxed">
                If you purchased an old version of LMSA, you can receive a free code that will grant you lifetime access to LMSA Premium, removing advertising.
            </p>
            <p class="mb-4 leading-relaxed">
                Please email support@lmsa.app with your order number to receive your free code.
            </p>
            <p class="mb-4 leading-relaxed text-sm">
                <a href="#" id="locate-order-number-link" class="text-blue-400 hover:text-blue-300 underline">Locate order number</a>
            </p>
            <div class="flex justify-end">
                <button id="legacy-access-close-btn" class="rounded-lg px-4 py-2 focus:outline-none" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Clear System Prompt Confirmation Modal -->
    <div id="clear-system-prompt-modal" class="fixed inset-0 bg-black/80 dark:bg-black/80 light:bg-gray-900/50 backdrop-blur-sm items-center justify-center hidden modal-container z-[2100]" aria-labelledby="clear-system-prompt-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-red-950/95 to-red-900/95 dark:from-[#2d0a0a] dark:to-[#3d0d0d] light:from-red-50 light:to-red-100 p-6 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-red-900/30 dark:border-red-900/30 light:border-red-200 overflow-hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="clear-system-prompt-title" class="text-xl font-bold flex items-center">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-red-500/20 dark:bg-red-500/20 light:bg-red-500/10 w-10 h-10 text-red-400 dark:text-red-400 light:text-red-600">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-300 dark:from-red-400 dark:to-red-300 light:from-red-600 light:to-red-700">Clear System Prompt</span>
                </h2>
                <button id="close-clear-system-prompt-modal" class="text-gray-400 hover:text-white dark:text-gray-400 dark:hover:text-white light:text-gray-600 light:hover:text-gray-800 focus:outline-none rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <div class="p-4 rounded-lg bg-red-900/20 dark:bg-red-900/20 light:bg-red-100/80 border border-red-800/30 dark:border-red-800/30 light:border-red-300 mb-4">
                    <p class="text-gray-300 dark:text-gray-300 light:text-black mb-2">Are you sure you want to clear the system prompt?</p>
                    <p class="text-red-300 dark:text-red-300 light:text-black text-sm flex items-start">
                        <i class="fas fa-exclamation-triangle mt-0.5 mr-2 text-red-300 dark:text-red-300 light:text-black"></i>
                        <span>This action will remove all content from the system prompt. This cannot be undone.</span>
                    </p>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="cancel-clear-system-prompt" class="flex-1 py-2.5 px-4 rounded-lg bg-gray-700/50 hover:bg-gray-700 dark:bg-gray-700/50 dark:hover:bg-gray-700 light:bg-black light:hover:bg-gray-800 text-gray-300 hover:text-white dark:text-gray-300 dark:hover:text-white light:text-white light:hover:text-white border border-gray-600/30 hover:border-gray-500/50 dark:border-gray-600/30 dark:hover:border-gray-500/50 light:border-gray-700 light:hover:border-gray-600">
                    <i class="fas fa-times mr-2 text-gray-300 hover:text-white dark:text-gray-300 dark:hover:text-white light:text-white light:hover:text-white"></i>Cancel
                </button>
                <button id="confirm-clear-system-prompt" class="flex-1 py-2.5 px-4 rounded-lg bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 dark:from-red-700 dark:to-red-600 dark:hover:from-red-600 dark:hover:to-red-500 light:from-red-600 light:to-red-500 light:hover:from-red-500 light:hover:to-red-400 text-white shadow-lg hover:shadow-red-500/20">
                    <i class="fas fa-trash-alt mr-2"></i>Clear Prompt
                </button>
            </div>
        </div>
    </div>


    <!-- Help modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden modal-container" aria-labelledby="help-title" role="dialog" aria-modal="true">
        <div class="p-0 rounded-lg w-[800px] max-w-[95%] max-h-[90vh] shadow-lg overflow-hidden flex flex-col modal-content" style="background: var(--modal-bg);">
            <div class="p-6 pb-4 border-b sticky top-0 z-10 flex justify-between" style="border-color: var(--border-color);">
                <h2 id="help-title" class="text-2xl font-bold flex items-center">
                    <div class="w-10 h-10 rounded-full mr-3 flex items-center justify-center" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                        <i class="fas fa-question-circle text-white text-lg"></i>
                    </div>
                    <span class="bg-gradient-to-r from-blue-400 via-purple-400 to-blue-400 bg-clip-text text-transparent">LMSA Help</span>
                </h2>
                <div class="flex items-center h-9">
                    <button id="close-help" class="group w-9 h-9 flex items-center justify-center focus:outline-none">
                        <i class="fas fa-times text-lg" style="color: var(--modal-text);"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-y-auto flex-grow p-6 pt-4" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain; background: var(--modal-bg);" id="help-modal-content">
                <div class="space-y-6">
                    <!-- Table of Contents -->
                    <div class="p-4 rounded-lg" style="background: var(--settings-label-bg); border: 1px solid var(--border-color);">
                        <h3 class="text-lg font-semibold mb-3 flex items-center" style="color: var(--text-primary);"><i class="fas fa-list mr-2" style="color: #3b82f6;"></i>Table of Contents</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <a href="#section-quick-start" class="toc-link flex items-center p-2 rounded transition-colors" style="color: var(--success-color);">
                                <i class="fas fa-rocket mr-2 text-sm"></i>
                                <span>Quick Start</span>
                            </a>
                            <a href="#section-security-privacy" class="toc-link flex items-center p-2 rounded transition-colors" style="color: #06b6d4;">
                                <i class="fas fa-lock mr-2 text-sm"></i>
                                <span>Security & Privacy</span>
                            </a>
                            <a href="#section-ads-privacy" class="toc-link flex items-center p-2 rounded transition-colors" style="color: var(--warning-color);">
                                <i class="fas fa-ad mr-2 text-sm"></i>
                                <span>Ads & Privacy</span>
                            </a>
                            <a href="#section-legacy-access" class="toc-link flex items-center p-2 rounded transition-colors" style="color: #3b82f6;">
                                <i class="fas fa-key mr-2 text-sm"></i>
                                <span>Legacy Access</span>
                            </a>
                            <a href="#section-troubleshooting" class="toc-link flex items-center p-2 rounded transition-colors" style="color: #ef4444;">
                                <i class="fas fa-tools mr-2 text-sm"></i>
                                <span>Troubleshooting</span>
                            </a>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <section id="section-quick-start">
                            <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--success-color);"><i class="fas fa-rocket mr-2"></i>Quick Start</h3>
                            <ul class="list-disc pl-5 space-y-1" style="color: var(--text-primary);">
                                <li><strong>Start the LM Studio server</strong> on your computer (do NOT load a model yet)</li>
                                <li>Enter server URL in <a href="#" id="open-settings-link" class="text-blue-400 hover:text-blue-300">Settings</a> (IP:Port)</li>
                                <li><strong>Load models from LMSA</strong> using the <i class="fas fa-robot text-blue-400"></i> button in the sidebar's Options menu</li>
                                <li>Start chatting!</li>
                            </ul>
                            <div class="mt-2 p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                <p class="font-medium flex items-center" style="color: #ef4444;"><i class="fas fa-exclamation-circle mr-2"></i>IMPORTANT:</p>
                                <p style="color: var(--text-primary);">Enable "CORS" and "Serve on local network" in LM Studio after starting your server. Make sure your device is on the same Wi-Fi as the server computer.</p>
                                <p style="color: var(--text-primary); margin-top: 0.5rem;"><strong>Always load models from within LMSA, not from LM Studio directly.</strong> Loading models directly in LM Studio can cause multiple models to stack in memory instead of being replaced, leading to excessive resource usage on your server computer.</p>
                            </div>

                            <div class="mt-4 p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                <p class="font-medium flex items-center" style="color: #a78bfa;"><i class="fas fa-sync-alt mr-2"></i>Model Switching:</p>
                                <p style="color: var(--text-primary);">You can switch between different models directly in the app:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                    <li>Open the sidebar and tap <strong>Options</strong></li>
                                    <li>Tap the <i class="fas fa-robot text-blue-400"></i> <strong>Models</strong> button</li>
                                    <li>Browse available models on your LM Studio server</li>
                                    <li>Tap <strong>Load</strong> next to your desired model</li>
                                    <li>The app will automatically eject the current model and load the new one</li>
                                </ul>
                            </div>

                            <div class="mt-4 p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                <p class="font-medium flex items-center" style="color: #fbbf24;"><i class="fas fa-star mr-2"></i>Default Model:</p>
                                <p style="color: var(--text-primary);">Save time by setting your favorite model as the default. It will automatically load when you start the app:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                    <li>Open the <i class="fas fa-robot text-blue-400"></i> <strong>Models</strong> menu from the sidebar's Options</li>
                                    <li>Find your preferred model in the list</li>
                                    <li>Tap the <i class="fas fa-star" style="color: #9ca3af;"></i> star icon next to the model</li>
                                    <li>The star will turn <i class="fas fa-star" style="color: #fbbf24;"></i> yellow to confirm it's set as default</li>
                                    <li>Next time you open LMSA, this model will load automatically</li>
                                    <li>To remove the default, simply tap the <i class="fas fa-star" style="color: #fbbf24;"></i> yellow star again</li>
                                </ul>
                            </div>
                        </section>
                        <section id="section-security-privacy">
                            <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--info-color);"><i class="fas fa-lock mr-2"></i>Security & Privacy Notice</h3>
                            <div class="p-3 rounded-lg border" style="background: var(--settings-label-bg); border-color: var(--border-color);">
                                <p style="color: var(--text-primary);">For your privacy and security, all chat messages are stored locally on your device. We do not store any of your conversations on external servers. Please note that:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                    <li>Uninstalling the app will permanently delete all saved chats</li>
                                    <li>Clearing app storage in device settings will erase all chat history</li>
                                    <li>These actions cannot be undone as data is stored only on your device</li>
                                </ul>
                                <div class="mt-3 p-2 rounded" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #06b6d4;"><i class="fas fa-file-export mr-2"></i>Chat Export/Import Feature:</p>
                                    <p style="color: var(--text-primary); margin-bottom: 0.5rem;">You can now backup and restore your conversations using the Export and Import features in the sidebar menu.</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>Use <strong>Export Chats</strong> to save all your conversations to a file</li>
                                        <li>Use <strong>Import Chats</strong> to restore previously exported conversations</li>
                                        <li>You can choose to merge imported chats with existing ones or replace them entirely</li>
                                        <li>Store exported files securely to protect your privacy</li>
                                    </ul>
                                    <div class="p-2 rounded mt-2" style="background: var(--settings-label-bg);">
                                        <p class="font-medium" style="color: var(--button-danger-bg);"><i class="fas fa-exclamation-triangle mr-2"></i>Security Warning:</p>
                                        <p style="color: var(--text-primary);">Exported chat files are stored as unencrypted JSON files. Anyone with access to your device or the exported file can read your conversations in plain text, even without using LMSA.</p>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section id="section-ads-privacy">
                            <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: var(--warning-color);"><i class="fas fa-ad mr-2"></i>Ads & Privacy</h3>
                            <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                <p class="font-medium flex items-center" style="color: var(--success-color);"><i class="fas fa-shield-alt mr-2"></i>Your Conversations Are Private</p>
                                <p style="color: var(--text-primary); margin-top: 0.75rem; margin-bottom: 0.75rem;">While LMSA displays ads to support development, your chat messages remain completely private:</p>
                                <ul class="list-disc pl-5 space-y-2" style="color: var(--text-primary);">
                                    <li><strong>No chat data is sent to us</strong> - The developer cannot see your conversations</li>
                                    <li><strong>No chat data is sent to AdMob</strong> - Google's ad service does not receive your messages</li>
                                    <li><strong>Ads are generic</strong> - They are not based on your chat content</li>
                                    <li><strong>All messages stay local</strong> - Your chats are stored only on your device</li>
                                    <li><strong>Direct LM Studio connection</strong> - Messages go straight from LMSA to your LM Studio server</li>
                                </ul>
                                <p style="color: var(--text-primary); margin-top: 1rem;">The ads help keep LMSA free while respecting your privacy. We believe in transparency and your right to private conversations.</p>

                                <div class="mt-4 p-2 rounded" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #a78bfa;"><i class="fas fa-crown mr-2"></i>LMSA Premium - Remove Ads</p>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem;">Prefer an ad-free experience? Tap the <strong>Remove Ads</strong> button on the main page to upgrade to LMSA Premium with a one-time lifetime purchase that removes all ads from the app forever.</p>
                                </div>

                                <div id="section-legacy-access" class="mt-4 p-2 rounded" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #3b82f6;"><i class="fas fa-key mr-2"></i>Legacy Users</p>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem; margin-bottom: 0.5rem;">If you purchased an old version of LMSA, you can receive a free code that will grant you lifetime access to LMSA Premium, removing advertising.</p>
                                    <p style="color: var(--text-primary); margin-bottom: 0.5rem;">Please email <strong>support@lmsa.app</strong> with your order number to receive your free code.</p>
                                    <p style="color: var(--text-primary);"><a href="#" id="help-locate-order-number-link" class="text-blue-400 hover:text-blue-300 underline">Locate order number</a></p>
                                </div>
                            </div>
                        </section>
                        <section id="section-troubleshooting">
                            <h3 class="text-lg font-semibold mb-2 flex items-center" style="color: #f59e0b;"><i class="fas fa-tools mr-2"></i>Troubleshooting</h3>
                            <p style="color: var(--text-primary); margin-bottom: 1rem;">If you're having trouble connecting LMSA to your LM Studio server, follow these steps:</p>

                            <div class="space-y-4">
                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #3b82f6;"><i class="fas fa-cog mr-2"></i>Verify Server Settings</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>In LM Studio, go to server settings and confirm <strong>"Enable CORS"</strong> is checked</li>
                                        <li>Verify that <strong>"Serve on Local Network"</strong> is enabled in LM Studio settings - this is required for the server to accept connections from devices on your network</li>
                                    </ul>
                                </div>

                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #10b981;"><i class="fas fa-network-wired mr-2"></i>Verify IP Address</p>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem;">The IP address shown in LM Studio may sometimes be incorrect. Manually check your computer's Wi-Fi adapter IP address:</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li><strong>Windows:</strong> Open Command Prompt and type <code>ipconfig</code>, look for "Wireless LAN adapter Wi-Fi" and use the IPv4 Address listed there</li>
                                        <li><strong>Mac:</strong> Go to System Preferences > Network, select Wi-Fi, and note the IP address</li>
                                        <li><strong>Linux:</strong> Open Terminal and type <code>ip addr show</code> or <code>ifconfig</code></li>
                                    </ul>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem;">Enter this IP address from your Wi-Fi adapter into LMSA</p>
                                </div>

                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #a78bfa;"><i class="fas fa-wifi mr-2"></i>Network Configuration</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>Ensure both your computer and Android phone are on the <strong>same network</strong></li>
                                        <li>Avoid guest networks, which often isolate devices from each other</li>
                                        <li>Check if your router has VLAN isolation or AP isolation enabled (disable if present)</li>
                                        <li>Disable VPN on both devices, as VPNs typically isolate local network connections</li>
                                    </ul>
                                </div>

                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #ef4444;"><i class="fas fa-shield-alt mr-2"></i>Firewall Settings</p>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem;">Check Windows Firewall to ensure LM Studio is allowed through:</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>Go to Windows Security > Firewall & network protection > Allow an app through firewall</li>
                                        <li>Verify LM Studio has checkmarks for both <strong>Private and Public networks</strong> (or whichever profile you're using)</li>
                                        <li>If LM Studio isn't listed, click "Allow another app" and add it manually</li>
                                    </ul>
                                </div>

                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #06b6d4;"><i class="fas fa-ethernet mr-2"></i>Port Configuration</p>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>Try using different ports if the default (1234) doesn't work</li>
                                        <li>Common alternatives: <strong>8080, 5000, 3000</strong></li>
                                        <li>Ensure the port you choose isn't blocked by your firewall or used by another application</li>
                                    </ul>
                                </div>

                                <div class="p-3 rounded-lg" style="background: var(--settings-label-bg);">
                                    <p class="font-medium flex items-center" style="color: #f59e0b;"><i class="fas fa-stethoscope mr-2"></i>Test Network Connectivity</p>
                                    <p style="color: var(--text-primary); margin-top: 0.5rem; margin-bottom: 0.5rem;"><strong>From Android to Computer:</strong></p>
                                    <ul class="list-disc pl-5 space-y-1" style="color: var(--text-primary);">
                                        <li>Download a networking app with ping functionality (e.g., PingTools, Network Utilities)</li>
                                        <li>Ping your computer's IP address to verify connectivity</li>
                                    </ul>
                                    <p style="color: var(--text-primary); margin-top: 0.75rem; margin-bottom: 0.5rem;"><strong>From Computer to Android:</strong></p>
                                    <ul class="list-disc pl-5 space-y-1" style="color: var(--text-primary);">
                                        <li>Find your Android phone's IP address in your router's connected devices list or in phone settings</li>
                                        <li>Open Command Prompt (Windows) or Terminal (Mac/Linux) and run <code>tracert [phone-ip]</code> (Windows) or <code>traceroute [phone-ip]</code> (Mac/Linux)</li>
                                        <li>If the traceroute fails, there may be network isolation preventing communication</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <!-- Add margin to create space between scroll container and spacer -->
            <div class="h-4"></div>
            <!-- Static Spacer Divider -->
            <div class="px-6 py-2 flex justify-center" style="background: var(--modal-bg);">
                <div class="w-full max-w-md flex items-center justify-center">
                    <div class="h-[1px] flex-grow bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-60"></div>
                    <div class="mx-4">
                        <div class="w-2 h-2 rounded-full bg-blue-500 opacity-80"></div>
                    </div>
                    <div class="h-[1px] flex-grow bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-60"></div>
                </div>
            </div>
            <!-- Add margin to create space between spacer and buttons -->
            <div class="h-4"></div>
            <div class="p-6 pt-0 space-y-4 sticky bottom-0 z-10" style="background: var(--modal-bg);">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Watch Tutorial Video Button -->
                </div>

                <!-- Scroll to Top Button -->
                <div class="flex justify-center" id="help-scroll-to-top-container" style="display: none;">
                    <button id="help-scroll-to-top" class="professional-button flex items-center justify-center gap-3 w-full md:w-auto md:px-8 h-[48px]">
                        <i class="fas fa-arrow-up text-sm"></i>
                        <span>Scroll to Top</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Support Modal -->
    <div id="contact-form-modal" class="fixed inset-0 bg-black/70 dark:bg-black/70 light:bg-gray-900/50 backdrop-blur-sm items-center justify-center hidden modal-container" aria-labelledby="contact-form-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] dark:from-[#0a192f] dark:to-[#0d1f3d] light:from-[#f8fafc] light:to-[#f1f5f9] p-6 rounded-xl w-full max-w-lg mx-auto max-h-[90vh] shadow-2xl overflow-y-auto modal-content" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain;">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700/60 dark:border-gray-700/60 light:border-gray-200 pb-4 sticky top-0 z-10" style="background: var(--modal-bg);">
                <h2 id="contact-form-title" class="text-2xl font-bold flex items-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                    <div class="mr-3 p-2 bg-blue-500/10 dark:bg-blue-500/10 light:bg-blue-500/20 rounded-full flex items-center justify-center">
                        <i class="fas fa-envelope text-blue-400"></i>
                    </div>
                    Contact Support
                </h2>
                <button id="close-contact-form" class="text-gray-400 dark:hover:text-white light:hover:text-gray-800 focus:outline-none dark:hover:bg-gray-700/50 light:hover:bg-gray-200/50 rounded-full w-9 h-9 flex items-center justify-center group">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Email Support Content -->
            <div class="contact-support-container bg-darkBg-30 dark:bg-darkBg-30 light:bg-gray-100/70 p-6 rounded-lg shadow-inner border border-white/5 dark:border-white/5 light:border-gray-200">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500/20 to-teal-500/20 rounded-full mb-4">
                        <i class="fas fa-headset text-2xl text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-200 dark:text-gray-200 light:text-gray-800 mb-2">Get Technical Support</h3>
                    <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-600 leading-relaxed">
                        Click the button below to open your email app with a pre-filled support request. This helps us assist you more efficiently.
                    </p>
                </div>

                <!-- Email Button -->
                <div class="mb-6">
                    <button id="open-email-support"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600
                        text-white font-medium py-4 px-6 rounded-lg
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900
                        shadow-lg hover:shadow-blue-500/20 relative overflow-hidden group">
                        <span class="relative z-10 flex items-center justify-center">
                            <i class="fas fa-external-link-alt mr-3"></i>
                            <span class="text-lg">Open Email App</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-teal-500 opacity-0 group-hover:opacity-50"></div>
                    </button>
                </div>

                <!-- Support Info -->
                <div class="bg-gradient-to-r from-blue-500/10 to-teal-500/10 rounded-lg p-4 border border-blue-500/20">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-blue-300 mb-2">What happens next?</h4>
                            <ul class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-600 space-y-1">
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Your default email app will open</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Subject and recipient will be pre-filled</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Template with helpful questions included</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Our team typically responds within 24-48 hours</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alternative Contact Info -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400 dark:text-gray-400 light:text-gray-600 mb-2">
                    Email app not working? You can manually email us at:
                </p>
                <a href="mailto:support@lmsa.app"
                   class="text-blue-400 hover:text-blue-300 text-sm font-medium underline decoration-dotted underline-offset-2">
                    support@lmsa.app
                </a>
            </div>
        </div>
    </div>

    <!-- Context menu for LLM-generated text -->
    <div id="context-menu" class="hidden fixed bg-darkSecondary border border-gray-600 rounded-lg shadow-lg z-50">
        <button id="copy-text" class="w-full text-left px-4 py-2 hover:bg-darkTertiary focus:outline-none">
            <i class="fas fa-copy mr-2"></i>Copy
        </button>
        <button id="regenerate-text" class="w-full text-left px-4 py-2 hover:bg-darkTertiary focus:outline-none">
            <i class="fas fa-redo mr-2"></i>Regenerate
        </button>
    </div>

    <!-- Context menu for Send button -->
    <div id="send-context-menu" class="hidden fixed bg-darkSecondary border border-gray-600 rounded-lg shadow-lg z-50">
        <div class="menu-header text-xs">Quick Actions</div>
        <button id="new-topic-menu-button" class="w-full text-left focus:outline-none flex items-center">
            <div class="icon-container text-white p-1.5 rounded-full flex items-center justify-center">
                <i class="fas fa-plus-circle text-sm"></i>
            </div>
            <span class="font-medium ml-3">New Topic</span>
        </button>
        <button id="scroll-to-bottom-menu-button" class="w-full text-left focus:outline-none flex items-center">
            <div class="icon-container text-white p-1.5 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-down text-sm"></i>
            </div>
            <span class="font-medium ml-3">Scroll to Bottom</span>
        </button>
    </div>


    
    <!-- About modal -->
    <div id="about-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm items-center justify-center hidden modal-container z-50" aria-labelledby="about-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] p-0 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-white/10 overflow-hidden" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain;">
            <!-- Header with app icon and title -->
            <div class="relative p-6 pb-4">
                <div class="flex items-center justify-center mb-2">
                    <img src="icon.png" alt="LMSA Icon" class="w-16 h-16 mb-1 filter drop-shadow-lg">
                </div>
                <h2 id="about-title" class="text-2xl font-bold text-center flex items-center justify-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400 mb-1">
                    LMSA
                </h2>
                <button id="close-about" class="absolute right-3 top-3 text-gray-400 hover:text-white focus:outline-none hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
                <div class="version-badge px-4 py-1.5 rounded-full mx-auto w-fit mt-2">
                    <p class="text-sm font-medium text-blue-300 text-center">Version 8.9</p>
                </div>
            </div>

            <!-- Main content with subtle divider -->
            <div class="p-6 pt-4">
                <div class="h-px w-full bg-gradient-to-r from-transparent via-white/20 to-transparent mb-3"></div>

                <!-- Company info with subtle animation -->
                <div class="flex flex-col items-center justify-center">
                    <p class="text-center text-gray-300 flex items-center mb-3">
                        <i class="fas fa-copyright text-blue-400 mr-2 opacity-75"></i>
                        <span>2025 TechRay Apps LLC</span>
                    </p>

                    <!-- Help link with improved styling -->
                    <div class="border-t border-white/10 pt-3 w-full">
                        <p class="text-center text-gray-400 flex items-center justify-center">
                            <i class="fas fa-question-circle text-blue-400 mr-2"></i>
                            Need help?&nbsp;<a href="#" id="open-help-link" class="text-blue-400 hover:text-blue-300 font-medium ml-1.5 underline decoration-dotted underline-offset-2">Open Help Menu</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden modal-container" aria-labelledby="import-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="import-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-file-import mr-2 text-blue-500"></i>Import Chats
            </h2>
            <div class="mb-4">
                <p class="mb-4" style="color: var(--text-primary);">How would you like to import the chats?</p>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="import-option" value="merge" checked class="text-blue-600 focus:ring-blue-500">
                        <span style="color: var(--text-primary);">Merge with existing chats</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="import-option" value="replace" class="text-blue-600 focus:ring-blue-500">
                        <span style="color: var(--text-primary);">Replace all existing chats</span>
                    </label>
                </div>
            </div>
            <div id="import-status" class="mb-4 hidden">
                <div class="p-3 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-700">
                    <p id="import-status-message" class="text-blue-300"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-import" class="rounded-lg px-4 py-2 focus:outline-none" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-import" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Import Success modal -->
    <div id="import-success-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden modal-container" aria-labelledby="import-success-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="import-success-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>Import Successful
            </h2>
            <div class="mb-6">
                <p id="import-success-message" class="text-center text-lg" style="color: var(--text-primary);">Successfully imported chats.</p>
            </div>
            <div class="flex justify-center">
                <button id="close-import-success" class="bg-blue-600 text-white rounded-lg px-6 py-2 hover:bg-blue-700 focus:outline-none">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Export Confirmation modal -->
    <div id="export-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden modal-container" aria-labelledby="export-confirmation-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="export-confirmation-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-file-export mr-2 text-blue-500"></i>Confirm Export
            </h2>
            <p id="export-confirmation-message" class="mb-4">Are you sure you want to export all your chat history? The exported file will contain all your conversations in unencrypted format.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-export" class="rounded-lg px-4 py-2 focus:outline-none" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-export" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none">
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Export Success modal -->
    <div id="export-success-modal" class="fixed inset-0 bg-black bg-opacity-50 items-center justify-center hidden modal-container" aria-labelledby="export-success-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="export-success-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>Export Successful
            </h2>
            <div class="mb-6">
                <p id="export-success-message" class="text-center text-lg" style="color: var(--text-primary);">Successfully exported chats.</p>
            </div>
            <div class="flex justify-center">
                <button id="close-export-success" class="bg-blue-600 text-white rounded-lg px-6 py-2 hover:bg-blue-700 focus:outline-none">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for importing chats -->
    <input type="file" id="import-chats-input" accept=".json" class="hidden">

    <!-- Model modal -->
    <div id="model-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm items-center justify-center hidden modal-container" aria-labelledby="model-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f]/95 via-[#0c1e36]/95 to-[#0a192f]/95 light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-6 rounded-xl w-[800px] max-w-[95%] max-h-[90vh] shadow-2xl overflow-hidden flex flex-col modal-content border border-white/10 light:border-gray-200" style="background: var(--modal-bg);">
            <div class="flex justify-between items-center mb-5 pb-2 border-b border-white/10 dark:border-white/10 light:border-gray-200/60">
                <h2 id="model-title" class="text-xl font-bold flex items-center modal-title">
                    <i class="fas fa-info-circle mr-3 text-blue-400"></i>
                    <span class="text-blue-400 font-extrabold">Model Information</span>
                </h2>
                <button id="close-model" class="text-gray-400 hover:text-white focus:outline-none rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto pr-4 flex-grow">
                <!-- Instructions for mobile users -->
                <div id="mobile-instructions" class="mb-4 p-4 bg-gradient-to-r from-blue-500/10 to-indigo-500/10 rounded-xl border border-blue-500/20 shadow-sm hidden">
                    <div class="flex items-start">
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-blue-400 dark:text-blue-400 light:text-blue-600 mb-1">
                                <i class="fas fa-robot mr-1"></i>Tip
                            </h4>
                            <p class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-600 leading-relaxed">
                                LMSA must load the first model, otherwise it will not replace the loaded model with the one you select, and instead continue stacking models on top of another.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-5 bg-darkTertiary-30 rounded-xl border border-blue-500/30 dark:border-blue-500/30 light:border-blue-400/30 shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-blue-400 dark:text-blue-400 light:text-blue-600 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>Currently Loaded Model
                    </h3>
                    <div id="current-model" class="text-lg font-medium text-white dark:text-white light:text-gray-800 p-4 bg-darkBg-70 dark:bg-darkBg-70 light:bg-white/80 rounded-lg overflow-hidden text-ellipsis border border-white/5 shadow-inner">Loading...</div>
                </div>

                <div>
                    <div id="available-models-list" class="space-y-3">
                        <div class="flex space-x-4">
                            <div class="flex-1 space-y-3 py-1">
                                <div class="h-4 bg-darkTertiary-50 rounded-full w-3/4"></div>
                                <div class="h-4 bg-darkTertiary-50 rounded-full w-1/2"></div>
                                <div class="h-4 bg-darkTertiary-50 rounded-full w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Model Name modal -->
    <div id="full-model-name-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm items-center justify-center hidden modal-container" aria-labelledby="full-model-name-title" role="dialog" aria-modal="true">
        <div class="dark:bg-gradient-to-b dark:from-[#0a192f]/95 dark:via-[#0c1e36]/95 dark:to-[#0a192f]/95 light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-6 rounded-xl max-w-[95%] max-h-[90vh] shadow-2xl overflow-hidden flex flex-col modal-content border border-white/10 dark:border-white/10 light:border-gray-200">
            <div class="flex justify-between items-center mb-5 pb-2 border-b border-white/10 dark:border-white/10 light:border-gray-200/60">
                <h2 id="full-model-name-title" class="text-xl font-bold flex items-center modal-title">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-9 h-9 text-blue-400 shadow-lg">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-blue-400 font-extrabold">Model Name</span>
                    </div>
                </h2>
                <button id="close-full-model-name" class="text-gray-400 hover:text-white focus:outline-none rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto pr-4">
                <div class="p-5 bg-darkTertiary-30 rounded-xl border border-blue-500/30 dark:border-blue-500/30 light:border-blue-400/30 shadow-md">
                    <div id="full-model-name" class="text-lg font-medium text-white dark:text-white light:text-gray-800 p-4 bg-darkBg-70 dark:bg-darkBg-70 light:bg-white/80 rounded-lg border border-white/5 shadow-inner break-all"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Default Model Loaded Success modal -->
    <div id="default-model-loaded-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm items-center justify-center hidden modal-container" aria-labelledby="default-model-loaded-title" role="dialog" aria-modal="true">
        <div class="dark:bg-gradient-to-b dark:from-[#0a192f]/95 dark:via-[#0c1e36]/95 dark:to-[#0a192f]/95 light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-6 rounded-xl w-[500px] max-w-[90%] shadow-2xl modal-content">
            <div class="mb-5">
                <h2 id="default-model-loaded-title" class="text-xl font-bold modal-title">
                    <span class="text-green-400 dark:text-green-400 light:text-green-600 font-extrabold">Default Model Loaded</span>
                </h2>
            </div>
            <div class="p-5 bg-darkTertiary-30 dark:bg-darkTertiary-30 light:bg-green-50 rounded-xl shadow-md">
                <div class="flex items-center mb-3">
                    <i class="fas fa-star text-yellow-400 dark:text-yellow-400 light:text-yellow-500 mr-2"></i>
                    <h3 class="text-lg font-semibold text-green-400 dark:text-green-400 light:text-green-600">Ready to Go!</h3>
                </div>
                <div id="default-model-loaded-name" class="text-lg font-medium text-white dark:text-white light:text-gray-800 p-4 bg-darkBg-70 dark:bg-darkBg-70 light:bg-white rounded-lg shadow-inner break-all"></div>
            </div>
        </div>
    </div>

    <!-- What's New modal -->
    <div id="whats-new-modal" class="fixed inset-0 hidden modal-container" aria-labelledby="whats-new-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f]/95 via-[#0c1e36]/95 to-[#0a192f]/95 p-4 rounded-2xl shadow-2xl modal-content flex flex-col border border-white/10 overflow-hidden" style="box-shadow: 0 20px 60px -15px rgba(0,0,0,0.7), 0 0 30px rgba(31, 66, 135, 0.2), 0 0 0 1px rgba(255,255,255,0.1) inset;">
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-white/15">
                <h2 id="whats-new-title" class="text-xl font-bold flex items-center">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 w-9 h-9 text-darkBg shadow-lg">
                        <i class="fas fa-wand-magic-sparkles text-sm"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-blue-400 font-extrabold">What's New</span>
                        <span class="text-xs text-blue-300/80 font-medium">v<span id="whats-new-version">8.9</span></span>
                    </div>
                </h2>
                <button id="close-whats-new" class="text-gray-400 hover:text-white focus:outline-none rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="features-container overflow-y-auto flex-grow px-1 py-2">
                <div class="space-y-3">
                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-red-500/10 to-orange-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-red-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-user-shield text-red-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Age Gate and Terms Acceptance</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">For enhanced safety and compliance, LMSA now includes an age verification system that requires users to confirm they are 18 years or older before accessing the application.</p>
                                        <p class="mb-3">Additionally, users must now explicitly accept the Terms of Service and Privacy Policy to use the app. These measures ensure responsible usage and protect all users while maintaining transparency about data handling and community guidelines.</p>
                                        <p>This update demonstrates our commitment to creating a safe, secure environment for AI-assisted interactions.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-indigo-500/10 to-purple-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-indigo-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-volume-up text-indigo-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">TTS Audio</h3>
                                        <span class="ml-2 px-1.5 py-0.5 bg-indigo-500/20 text-indigo-300 text-xs rounded-full font-medium">NEW</span>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">You can now tap the speaker icon in the AI response chat bubbles to hear the AI response read out loud. This text-to-speech feature makes it easier to consume AI responses while multitasking or when you prefer audio content.</p>
                                        <p>Perfect for accessibility, hands-free operation, or when you want to listen to responses while doing other tasks.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-blue-500/10 to-cyan-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-key text-blue-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Legacy Access for Previous Purchasers</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-2">If you purchased an old version of LMSA, you can receive a free code that will grant you lifetime access to LMSA Premium, removing advertising.</p>
                                        <p class="mb-2">Please email <strong>support@lmsa.app</strong> with your order number to receive your free code.</p>
                                        <p><a href="#" id="whats-new-locate-order-number-link" class="text-blue-400 hover:text-blue-300 underline">Locate order number</a></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-emerald-500/10 to-teal-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-emerald-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-shield-alt text-emerald-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">IP/Port Verification Checklist</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">Added a verification checklist that appears when changes are detected in the IP and/or port input fields. This helpful reminder ensures you don't forget important CORS and local network setting changes that are required for LMSA to work properly with your LM Studio instance.</p>
                                        <p>The checklist guides you through the essential configuration steps, making setup more reliable and reducing connection issues.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-blue-500/10 to-indigo-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-edit text-blue-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Improved Message Input Field</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">The message input field now automatically adjusts its height to accommodate longer messages, making it much easier to edit and review your text before sending. No more cramped single-line input that cuts off your thoughts!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-green-500/10 to-emerald-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-green-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-comments text-green-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Enhanced Chat Bubble UI</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">Chat bubbles now have a cleaner, more modern look with improved spacing, typography, and visual hierarchy. The overall chat experience feels more polished and professional.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-purple-500/10 to-violet-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-purple-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-exchange-alt text-purple-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Import/Export Bug Fix</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">Fixed a critical issue with the import/export feature that was causing problems for some users. Chat history can now be reliably backed up and restored without data loss.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-orange-500/10 to-red-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-orange-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-sun text-orange-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Light Theme Fixes</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">Resolved display issues in light theme where some interface elements appeared black instead of their proper colors. Light theme now renders correctly across all components.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-cyan-500/10 to-teal-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-cyan-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-arrow-down text-cyan-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Auto-Scroll to Latest Messages</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">Added a new setting in the options menu that automatically scrolls to the bottom (latest/newest part) of the chat history window when the LLM is streaming text. This keeps you focused on the most recent responses without manual scrolling.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-yellow-500/10 to-amber-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-yellow-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-star text-yellow-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title">Default Model Selection</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-3">You can now set a default model that will automatically load whenever LMSA connects to LM Studio! Simply open the models modal and tap the star icon next to any model to set it as your default.</p>
                                        <p class="mb-3">Your default model will be saved and automatically selected every time you launch the app, eliminating the need to manually switch models. If a different model is already loaded when you start LMSA, it will automatically switch to your preferred default model.</p>
                                        <p>This feature provides a more automated experience - just launch the app and your favorite model is ready to go!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="relative">
                <!-- Decorative divider with glow effect -->
                <div class="absolute left-0 right-0 top-0 h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
                <div class="absolute left-0 right-0 top-0 h-px bg-gradient-to-r from-transparent via-blue-500/20 to-transparent blur-sm"></div>

                <!-- Footer content -->
                <div class="flex justify-end items-center pt-3 pb-2 mt-auto bg-gradient-to-b from-[#0a192f]/95 to-[#0c1e36]/95 sticky bottom-0 px-2">
                    <button id="got-it-whats-new" class="relative overflow-hidden text-white rounded-lg focus:outline-none text-sm px-4 py-2" style="background: linear-gradient(135deg, #1e40af, #3b82f6); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15); border: none; font-weight: 600; letter-spacing: 0.02em; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);" onmouseover="this.style.boxShadow='0 6px 12px -1px rgba(37, 99, 235, 0.3), 0 4px 8px -1px rgba(37, 99, 235, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2)'; this.style.background='linear-gradient(135deg, #2563eb, #60a5fa)';" onmouseout="this.style.boxShadow='0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15)'; this.style.background='linear-gradient(135deg, #1e40af, #3b82f6)';">
                        <span class="relative z-10 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>Got it!</span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Native Ad Integration for Android -->
    <script>
        // Function to insert native ads into the chat
        window.insertNativeAd = function(adHtml) {
            try {
                const chatOutput = document.getElementById('chat-output');
                if (!chatOutput) return;

                // Create a container for the native ad
                const adContainer = document.createElement('div');
                adContainer.className = 'native-ad-message-container';
                adContainer.innerHTML = adHtml;

                // Find the last message and insert the ad after it
                const messages = chatOutput.querySelectorAll('.message-container');
                if (messages.length > 0) {
                    const lastMessage = messages[messages.length - 1];
                    lastMessage.parentNode.insertBefore(adContainer, lastMessage.nextSibling);
                } else {
                    chatOutput.appendChild(adContainer);
                }

                // Scroll to show the new ad (smoothly)
                setTimeout(() => {
                    adContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 100);

            } catch (error) {
                console.log('Error inserting native ad:', error);
            }
        };
    </script>

    <!-- TTS Service -->
    <script src="js/tts-service.js"></script>
    
    <!-- Main application script with module imports -->
    <script type="module" src="js/app.js"></script>
    <!-- All other modules are loaded by the main initialization system -->
    <!-- Removed custom marked.js loader as we're loading it earlier -->

    <script>
        // Add preview mode toggle functionality
        document.addEventListener('DOMContentLoaded', function() {

            const previewToggle = document.getElementById('preview-toggle');

            // We'll control button visibility through the updateViewMode function
            // No need to hide it here by default

            // Function to detect if device is a tablet
            function isTablet() {
                // Enhanced tablet detection that handles edge cases better
                // Lowered threshold to 601px to match CSS breakpoint and handle more tablet sizes

                // First check for explicit tablet indicators in user agent
                const isExplicitTablet = /iPad|Tablet/i.test(navigator.userAgent);

                // Check screen dimensions - use 601px to match CSS breakpoint
                // This ensures consistency between CSS and JS logic
                const hasTabletDimensions = window.innerWidth >= 601;

                // Additional check for common tablet aspect ratios and sizes
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const aspectRatio = Math.max(screenWidth, screenHeight) / Math.min(screenWidth, screenHeight);
                
                // Common tablet sizes that might fall in edge cases
                const isCommonTabletSize = (
                    (screenWidth >= 768 && screenWidth <= 1024) || // Standard tablet range
                    (screenWidth >= 600 && screenWidth <= 900 && aspectRatio <= 1.8) || // Wider tablets
                    (screenWidth >= 820 && screenWidth <= 834) // iPad Air/Pro sizes
                );

                // For testing purposes - force tablet mode when URL has ?tablet=true
                const forceTablet = window.location.search.includes('tablet=true');

                // Consider it a tablet if:
                // 1. It's explicitly a tablet, OR
                // 2. It has tablet-like dimensions, OR
                // 3. It matches common tablet sizes, OR
                // 4. Testing mode is enabled
                return isExplicitTablet || hasTabletDimensions || isCommonTabletSize || forceTablet;
            }

            // Function to update view mode based on device and user preference
            function updateViewMode() {
                const userPreference = localStorage.getItem('previewMode');
                const isTabletDevice = isTablet();
                const viewModeIndicator = document.getElementById('view-mode-indicator');

                // Clear any existing class first
                document.body.classList.remove('preview-mode');

                // If user has a saved preference, use that
                if (userPreference === 'true') {
                    // User wants mobile view
                    document.body.classList.add('preview-mode');
                } else if (userPreference === 'false') {
                    // User explicitly wants tablet view
                    // Do nothing, preview-mode is already removed
                } else {
                    // No saved preference - use defaults based on device
                    if (!isTabletDevice) {
                        // For phones - default to mobile view
                        document.body.classList.add('preview-mode');
                    }
                    // For tablets - default to tablet view (no preview-mode class)
                }

                // Control visibility of the preview toggle button
                if (previewToggle) {
                    if (isTabletDevice) {
                        // Show the button only on tablets - use multiple methods to ensure visibility
                        previewToggle.classList.remove('hidden');
                        previewToggle.classList.add('block');
                        previewToggle.style.display = 'block'; // Ensure it's visible with inline style
                        previewToggle.style.visibility = 'visible';
                        previewToggle.style.opacity = '1';

                        // Force the button to be visible by removing any CSS that might hide it
                        setTimeout(() => {
                            // Double-check visibility after a short delay
                            if (previewToggle.offsetParent === null) {
                                // Element is still not visible, try more aggressive approach
                                previewToggle.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                ;
                            }
                        }, 100);

                        // Update the view mode indicator
                        if (viewModeIndicator) {
                            if (document.body.classList.contains('preview-mode')) {
                                // Mobile view - show indicator
                                viewModeIndicator.classList.remove('hidden');
                                previewToggle.setAttribute('title', 'Currently in mobile view - click to switch to tablet view');
                            } else {
                                // Tablet view - hide indicator
                                viewModeIndicator.classList.add('hidden');
                                previewToggle.setAttribute('title', 'Currently in tablet view - click to switch to mobile view');
                            }
                        }
                    } else {
                        // Hide the button on non-tablet devices
                        previewToggle.classList.remove('block');
                        previewToggle.classList.add('hidden');
                        previewToggle.style.display = 'none';
                        previewToggle.style.visibility = 'hidden';
                    }
                }
            }

            // Set up the preview toggle button
            if (previewToggle) {
                previewToggle.addEventListener('click', function() {
                    document.body.classList.toggle('preview-mode');
                    const viewModeIndicator = document.getElementById('view-mode-indicator');

                    // Store preference in localStorage
                    if (document.body.classList.contains('preview-mode')) {
                        localStorage.setItem('previewMode', 'true');
                        if (viewModeIndicator) {
                            viewModeIndicator.classList.remove('hidden');
                            previewToggle.setAttribute('title', 'Currently in mobile view - click to switch to tablet view');
                        }
                    } else {
                        localStorage.setItem('previewMode', 'false');
                        if (viewModeIndicator) {
                            viewModeIndicator.classList.add('hidden');
                            previewToggle.setAttribute('title', 'Currently in tablet view - click to switch to mobile view');
                        }
                    }
                });

                // Initialize view mode
                updateViewMode();

                // Add resize event listener to handle orientation changes and window resizing
                let resizeTimeout;
                window.addEventListener('resize', function() {
                    // Debounce resize events to avoid excessive calls
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(function() {
                        updateViewMode();
                    }, 250);
                });

                // Also listen for orientation change events on mobile devices
                window.addEventListener('orientationchange', function() {
                    // Small delay to ensure dimensions are updated after orientation change
                    setTimeout(function() {
                        updateViewMode();
                    }, 300);
                });

                // Log device detection info for debugging
                const isExplicitTablet = /iPad|Tablet/i.test(navigator.userAgent);
                const hasTabletDimensions = window.innerWidth >= 601;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const aspectRatio = Math.max(screenWidth, screenHeight) / Math.min(screenWidth, screenHeight);
                const isCommonTabletSize = (
                    (screenWidth >= 768 && screenWidth <= 1024) || // Standard tablet range
                    (screenWidth >= 600 && screenWidth <= 900 && aspectRatio <= 1.8) || // Wider tablets
                    (screenWidth >= 820 && screenWidth <= 834) // iPad Air/Pro sizes
                );
                const forceTablet = window.location.search.includes('tablet=true');
                const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                // Check button visibility
                const computedStyle = window.getComputedStyle(previewToggle);
                const isButtonVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden';

                // console.log('TABLET VIEW DEBUGGING:', {
                //     'DEVICE INFO': {
                //         'isTablet (function result)': isTablet(),
                //         'isExplicitTablet (UA)': isExplicitTablet,
                //         'hasTabletDimensions (>= 601px)': hasTabletDimensions,
                //         'isCommonTabletSize': isCommonTabletSize,
                //         'forceTablet (URL param)': forceTablet,
                //         'userAgent': navigator.userAgent,
                //         'screenWidth': screenWidth,
                //         'screenHeight': screenHeight,
                //         'aspectRatio': aspectRatio.toFixed(2),
                //         'hasTouch': hasTouch
                //     },
                //     'VIEW MODE': {
                //         'currentMode': document.body.classList.contains('preview-mode') ? 'MOBILE VIEW' : 'TABLET VIEW',
                //         'previewModeClass': document.body.classList.contains('preview-mode'),
                //         'savedPreference': localStorage.getItem('previewMode')
                //     },
                //     'BUTTON STATE': {
                //         'isVisible (computed)': isButtonVisible,
                //         'display': computedStyle.display,
                //         'visibility': computedStyle.visibility,
                //         'opacity': computedStyle.opacity,
                //         'position': computedStyle.position,
                //         'width': computedStyle.width,
                //         'height': computedStyle.height,
                //         'classes': previewToggle.className,
                //         'inlineStyle': previewToggle.getAttribute('style')
                //     }
                // });

                // Debug indicator removed as it's no longer needed
                // The green/red dot in the top right corner has been removed

                // Update view mode when window is resized
                window.addEventListener('resize', updateViewMode);
            }

            // Set up help modal content scrolling
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = helpModal ? helpModal.querySelector('.help-modal-content') : null;

            if (helpModalContent) {
                // Remove previous custom scrolling events if they exist
                const oldHelpModalContent = helpModalContent.cloneNode(true);
                helpModalContent.parentNode.replaceChild(oldHelpModalContent, helpModalContent);

                // Re-select the element after replacing
                const newHelpModalContent = helpModal.querySelector('.help-modal-content');

                // Add simple touch event listeners with passive: true to ensure smooth scrolling
                newHelpModalContent.addEventListener('touchstart', function(e) {
                    // Just let the browser handle it
                }, { passive: true });

                newHelpModalContent.addEventListener('touchmove', function(e) {
                    // Just let the browser handle it
                }, { passive: true });

                newHelpModalContent.addEventListener('touchend', function(e) {
                    // Just let the browser handle it
                }, { passive: true });
            }

            // Enable drag to scroll functionality for other modal content (excluding whats new modal)
            const scrollableElements = document.querySelectorAll('.drag-scrollable:not(#help-modal .help-modal-content):not(#whats-new-modal .modal-content):not(#whats-new-modal .features-container), .touch-scroll:not(#whats-new-modal .features-container)');

            scrollableElements.forEach(scrollable => {
                let isDown = false;
                let startY;
                let scrollTop;

                // Check if target is a form element that needs normal interaction
                function isFormElement(target) {
                    const tag = target.tagName.toLowerCase();
                    return tag === 'input' || tag === 'textarea' || tag === 'select' ||
                           tag === 'button' || tag === 'a' ||
                           target.closest('input') || target.closest('textarea') ||
                           target.closest('select') || target.closest('button') ||
                           target.closest('a');
                }

                // Mouse events
                scrollable.addEventListener('mousedown', (e) => {
                    if (isFormElement(e.target)) {
                        return; // Allow normal interaction with form elements
                    }

                    isDown = true;
                    scrollable.style.cursor = 'grabbing';
                    startY = e.pageY - scrollable.offsetTop;
                    scrollTop = scrollable.scrollTop;
                    e.preventDefault();
                });

                scrollable.addEventListener('mouseleave', () => {
                    isDown = false;
                    scrollable.style.cursor = 'grab';
                });

                scrollable.addEventListener('mouseup', () => {
                    isDown = false;
                    scrollable.style.cursor = 'grab';
                });

                scrollable.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const y = e.pageY - scrollable.offsetTop;
                    const walk = (y - startY) * 2; // Scroll speed multiplier
                    scrollable.scrollTop = scrollTop - walk;
                });

                // Touch events with improved handling
                scrollable.addEventListener('touchstart', (e) => {
                    if (isFormElement(e.target)) {
                        return; // Allow normal interaction with form elements
                    }

                    // Store the initial touch position and scroll position
                    isDown = true;
                    const touch = e.touches[0];
                    startY = touch.pageY;
                    scrollTop = scrollable.scrollTop;
                }, { passive: true });

                scrollable.addEventListener('touchend', () => {
                    isDown = false;
                }, { passive: true });

                scrollable.addEventListener('touchmove', (e) => {
                    if (!isDown) return;

                    // Calculate distance moved
                    const touch = e.touches[0];
                    const y = touch.pageY;
                    const distance = startY - y;

                    // Apply the scroll
                    scrollable.scrollTop = scrollTop + distance;

                    // Update start position for next move
                    startY = y;
                    scrollTop = scrollable.scrollTop;

                    // Don't prevent default touch scrolling behavior
                }, { passive: true });
            });
        });
    </script>

    <!-- System prompt edit overlay (fixed position, will be shown/hidden with JavaScript) -->
    <div id="system-prompt-overlay" class="fixed inset-0 system-prompt-z-2000 hidden modal-container" style="display: none; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="system-prompt-overlay-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-8 rounded-2xl w-[700px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content border border-blue-400/50 dark:border-blue-400/50 light:border-blue-400/30 backdrop-blur-sm system-prompt-z-2001">
            <div class="flex justify-between items-center mb-6">
                <h2 id="system-prompt-overlay-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200">
                    <i class="fas fa-edit mr-3 text-blue-400"></i>Edit System Prompt
                </h2>
                <button id="close-system-prompt-overlay" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl font-bold" aria-label="Close modal">&times;</button>
            </div>
            <div class="mb-6 flex-1 flex flex-col">
                <textarea id="system-prompt-editor" class="flex-1 w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Enter your system prompt here..."></textarea>
            </div>
            <div class="flex justify-between items-center">
                <button id="clear-system-prompt-btn" class="px-4 py-2 text-red-600 dark:text-red-400 border border-red-300 dark:border-red-600 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                    <i class="fas fa-trash-alt mr-2"></i>Clear
                </button>
                <div class="flex space-x-3">
                    <button id="cancel-system-prompt-edit" class="px-4 py-2 text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cancel</button>
                    <button id="save-system-prompt-edit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- main.js is imported by app.js -->

    <script>
        // Apply touch event handlers to all modal content containers (except whats new modal)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-content, .overflow-y-auto').forEach(container => {
                // Skip whats new modal as it has its own specialized handling
                if (container && !container.closest('#whats-new-modal')) {
                    // Force enable touch scrolling with inline styles
                    container.style.webkitOverflowScrolling = 'touch';
                    container.style.overflowY = 'auto';
                    container.style.touchAction = 'pan-y';
                    container.style.overscrollBehavior = 'contain';

                    // Add touch event listeners with passive flag to ensure scrolling works
                    container.addEventListener('touchstart', function(e) {
                        // Let browser handle it natively
                    }, { passive: true });

                    container.addEventListener('touchmove', function(e) {
                        // Let browser handle it natively
                    }, { passive: true });
                }
            });
        });
    </script>

    <!-- Optimized touch handling script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the modal elements
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = helpModal ? helpModal.querySelector('.modal-content') : null;

            if (helpModalContent) {
                // Force browser-native scrolling behavior for touch devices
                helpModalContent.style.webkitOverflowScrolling = 'touch';
                helpModalContent.style.msOverflowStyle = '-ms-autohiding-scrollbar';
                helpModalContent.style.overflowY = 'auto';
                helpModalContent.style.touchAction = 'pan-y';
                helpModalContent.style.overscrollBehavior = 'contain';

                // Remove any drag scroll handling that might interfere with native scrolling
                helpModalContent.classList.remove('drag-scrollable');

                // Ensure all touch events are passive, which helps improve scrolling performance
                // by telling the browser we won't be calling preventDefault()
                const passiveHandler = function(e) { /* Let the browser handle it */ };
                helpModalContent.addEventListener('touchstart', passiveHandler, { passive: true });
                helpModalContent.addEventListener('touchmove', passiveHandler, { passive: true });
                helpModalContent.addEventListener('touchend', passiveHandler, { passive: true });

                // Prevent any parent elements from trapping touch events
                helpModal.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }

            // Apply the same fixes to all modal content (except whats new modal which has its own handling)
            document.querySelectorAll('.modal-content').forEach(modal => {
                if (modal !== helpModalContent && !modal.closest('#whats-new-modal')) {
                    // Force browser-native scrolling behavior
                    modal.style.webkitOverflowScrolling = 'touch';
                    modal.style.overflowY = 'auto';
                    modal.style.touchAction = 'pan-y';
                    modal.style.overscrollBehavior = 'contain';

                    // Ensure all touch events are passive
                    const passiveHandler = function(e) { /* Let the browser handle it */ };
                    modal.addEventListener('touchstart', passiveHandler, { passive: true });
                    modal.addEventListener('touchmove', passiveHandler, { passive: true });
                    modal.addEventListener('touchend', passiveHandler, { passive: true });
                }
            });
        });
    </script>

    <!-- Fix for global touch handling -->
    <script>
        // This script disables any document-level handlers that might interfere with scrolling
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure document-level touch events don't block scrolling in modals
            document.addEventListener('touchmove', function(e) {
                // Check if touch is within a modal
                if (e.target.closest('.modal-content') || e.target.closest('.overflow-y-auto')) {
                    // Don't interfere with modal touch events
                    e.stopPropagation();
                }
            }, { passive: true });

            // Disable any document-level default handlers that might block scrolling
            const modalContainers = document.querySelectorAll('.modal-container');
            modalContainers.forEach(container => {
                container.addEventListener('touchmove', function(e) {
                    // Check if touch is within content
                    if (!e.target.closest('.modal-content')) {
                        // If outside content, let it propagate
                        return;
                    }
                    // Otherwise stop it to prevent unintended behavior
                    e.stopPropagation();
                }, { passive: true });
            });
        });
    </script>

    <!-- Model loading modal -->
    <div id="model-loading-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 2200;" aria-labelledby="model-loading-title" role="dialog" aria-modal="true">
        <div class="relative dark:bg-gradient-to-b dark:from-[#1e293b] dark:via-[#334155] dark:to-[#1e293b] light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-10 rounded-2xl w-[550px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content border border-blue-400/50 dark:border-blue-400/50 light:border-blue-400/30 backdrop-blur-sm">
            <!-- Animated background gradient -->
            <div class="absolute inset-0 bg-gradient-to-br from-blue-500/10 via-transparent to-purple-500/10 rounded-2xl"></div>
            
            <!-- Decorative border glow -->
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-blue-500/30 via-purple-500/20 to-blue-500/30"></div>
            
            <div class="relative z-10 flex flex-col items-center justify-center text-center">
                <!-- Enhanced title with better typography -->
                <div class="mb-4">
                    <h2 id="model-loading-title" class="text-2xl font-bold mb-2 text-blue-400 dark:text-blue-400 light:text-blue-600">
                        <i class="fas fa-robot mr-3"></i>Loading Model
                    </h2>
                    <div class="w-20 h-0.5 bg-gradient-to-r from-blue-500 to-purple-500 mx-auto rounded-full"></div>
                </div>

                <!-- Enhanced message with better spacing -->
                <p id="model-loading-message" class="text-gray-300 dark:text-gray-300 light:text-gray-600 mb-4 font-medium text-lg">
                    Please wait while the model is being loaded...
                </p>

                <!-- Enhanced model name display -->
                <div class="model-name-container mb-6">
                    <p id="model-loading-name" class="text-blue-300 dark:text-blue-300 light:text-blue-600 text-sm font-mono bg-gradient-to-r from-blue-500/10 to-purple-500/10 dark:from-blue-500/10 dark:to-purple-500/10 light:from-blue-100 light:to-purple-100 px-4 py-2 rounded-xl border border-blue-500/20 dark:border-blue-500/20 light:border-blue-400/30 shadow-inner backdrop-blur-sm">
                    <!-- Model name will be inserted here -->
                    </p>
                </div>

                <!-- Enhanced info section with better styling -->
                <div class="mt-6 flex items-center justify-center px-4 py-2 bg-gradient-to-r from-blue-500/5 to-purple-500/5 rounded-xl border border-blue-500/10 dark:border-blue-500/10 light:border-blue-400/20">
                    <div class="flex items-center text-sm text-gray-400 dark:text-gray-400 light:text-gray-500">
                        <span>This may take a few moments depending on model size</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Model Name modal -->

    <!-- IP/Port Settings Confirmation Modal -->
    <div id="ip-port-confirmation-modal" class="fixed inset-0 items-center justify-center hidden modal-container" style="z-index: 2300; background: var(--modal-overlay); backdrop-filter: blur(12px) saturate(180%); -webkit-backdrop-filter: blur(12px) saturate(180%);" aria-labelledby="ip-port-confirmation-title" role="dialog" aria-modal="true">
        <div class="relative p-8 rounded-2xl w-[600px] max-w-[90%] shadow-2xl overflow-hidden flex flex-col modal-content" style="background: var(--modal-bg); border: 1px solid var(--border-color); box-shadow: 0 25px 50px -12px var(--modal-overlay), 0 0 0 1px var(--border-color) inset, 0 1px 3px 0 var(--border-color) inset;">
            <!-- Animated background gradient -->
            <div class="absolute inset-0 bg-gradient-to-br from-orange-500/10 via-transparent to-yellow-500/10 rounded-2xl"></div>
            
            <!-- Decorative border glow -->
            <div class="absolute inset-0 rounded-2xl bg-gradient-to-r from-orange-500/30 via-yellow-500/20 to-orange-500/30 opacity-20"></div>
            
            <div class="relative z-10">
                <!-- Enhanced title with warning icon -->
                <div class="mb-6 text-center">
                    <h2 id="ip-port-confirmation-title" class="text-2xl font-bold mb-2" style="color: #f97316;">
                        <i class="fas fa-exclamation-triangle mr-3"></i>Network Settings Checklist
                    </h2>
                    <div class="w-20 h-0.5 bg-gradient-to-r from-orange-500 to-yellow-500 mx-auto rounded-full"></div>
                </div>

                <!-- Main message -->
                <div class="mb-6">
                    <p class="text-center mb-4 font-medium" style="color: var(--text-primary);">
                        You've changed your IP address and/or port settings. Before applying these changes, please ensure you've completed the following steps:
                    </p>
                </div>

                <!-- Checklist -->
                <div class="mb-8 space-y-4">
                    <h3 class="text-lg font-semibold mb-4" style="color: var(--text-primary);">
                        <i class="fas fa-list-check mr-2" style="color: #f97316;"></i>Required Setup Steps:
                    </h3>
                    <div class="flex items-center space-x-3 p-3 rounded-lg" style="background: var(--settings-label-bg); border: 1px solid var(--border-color);">
                        <input type="checkbox" id="cors-check" class="focus:ring-orange-500 focus:ring-2">
                        <label for="cors-check" class="text-sm cursor-pointer" style="color: var(--text-primary);">
                            <span class="font-medium" style="color: #f97316;">CORS Enabled:</span> Did you enable CORS in LM Studio server on your computer?
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 rounded-lg" style="background: var(--settings-label-bg); border: 1px solid var(--border-color);">
                        <input type="checkbox" id="local-network-check" class="focus:ring-orange-500 focus:ring-2">
                        <label for="local-network-check" class="text-sm cursor-pointer" style="color: var(--text-primary);">
                            <span class="font-medium" style="color: #f97316;">Local Network:</span> Did you enable the "Serve on Local Network" setting in LM Studio server settings on your computer?
                        </label>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-3 rounded-lg" style="background: var(--settings-label-bg); border: 1px solid var(--border-color);">
                        <input type="checkbox" id="wifi-check" class="focus:ring-orange-500 focus:ring-2">
                        <label for="wifi-check" class="text-sm cursor-pointer" style="color: var(--text-primary);">
                            <span class="font-medium" style="color: #f97316;">Same WiFi Network:</span> Is your mobile device connected to the same WiFi network as the computer running LM Studio server?
                        </label>
                    </div>
                    
                    <!-- Progress Tracker -->
                    <div id="checklist-progress-tracker" class="mt-4 text-center">
                        <span id="progress-text" class="font-bold text-lg" style="color: var(--text-primary);">Progress: <span id="progress-count" style="color: #f97316;">0/3</span></span>
                    </div>
                </div>



                <!-- Action buttons -->
                <div class="flex space-x-3">
                    <button id="ip-port-cancel-btn" class="flex-1 px-4 py-3 rounded-lg font-medium transition-colors duration-200 focus:outline-none focus:ring-2" style="background: var(--settings-label-bg); color: var(--text-primary); border: 1px solid var(--border-color); box-shadow: 0 2px 4px var(--modal-overlay);">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="ip-port-confirm-btn" class="flex-1 px-4 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-orange-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled style="box-shadow: 0 4px 6px var(--modal-overlay), 0 2px 4px var(--modal-overlay), 0 0 1px var(--border-color) inset;">
                        <i class="fas fa-check mr-2"></i>Apply Changes
                    </button>
                </div>
            </div>
        </div>
      </div>

    <!-- Table of Contents Smooth Scroll Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get all TOC links
            const tocLinks = document.querySelectorAll('.toc-link');
            const helpModalContent = document.getElementById('help-modal-content');
            const scrollToTopBtn = document.getElementById('help-scroll-to-top');

            // Table of Contents smooth scrolling
            tocLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Get the target section ID from the href
                    const targetId = this.getAttribute('href').substring(1);
                    const targetSection = document.getElementById(targetId);

                    if (targetSection && helpModalContent) {
                        // Calculate the position to scroll to
                        // We need to account for the section's offset within the scrollable container
                        const containerRect = helpModalContent.getBoundingClientRect();
                        const targetRect = targetSection.getBoundingClientRect();
                        const scrollTop = helpModalContent.scrollTop;

                        // Calculate the final scroll position (with some offset for better visibility)
                        const targetScrollPosition = scrollTop + (targetRect.top - containerRect.top) - 20;

                        // Smooth scroll to the target
                        helpModalContent.scrollTo({
                            top: targetScrollPosition,
                            behavior: 'smooth'
                        });

                        // Clear highlighting from all TOC links first
                        tocLinks.forEach(otherLink => {
                            otherLink.style.backgroundColor = '';
                        });

                        // Add visual feedback for the clicked link
                        this.style.transition = 'all 0.1s ease';
                        this.style.backgroundColor = 'rgba(59, 130, 246, 0.3)';

                        setTimeout(() => {
                            this.style.backgroundColor = '';
                        }, 200);
                    }
                });

                // Add touch feedback for better mobile experience
                link.addEventListener('touchstart', function() {
                    this.style.backgroundColor = 'rgba(59, 130, 246, 0.2)';
                }, { passive: true });

                link.addEventListener('touchend', function() {
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 200);
                }, { passive: true });
            });

            // Scroll to Top Button functionality
            const scrollToTopContainer = document.getElementById('help-scroll-to-top-container');

            if (scrollToTopBtn && helpModalContent && scrollToTopContainer) {
                // Show/hide button based on scroll position
                // Require scrolling down at least 600px (significant amount) before showing
                helpModalContent.addEventListener('scroll', function() {
                    if (this.scrollTop > 600) {
                        scrollToTopContainer.style.display = 'flex';
                        scrollToTopContainer.classList.add('show');
                    } else {
                        scrollToTopContainer.classList.remove('show');
                        // Delay hiding to allow fade out animation
                        setTimeout(() => {
                            if (!scrollToTopContainer.classList.contains('show')) {
                                scrollToTopContainer.style.display = 'none';
                            }
                        }, 300);
                    }
                }, { passive: true });

                // Scroll to top when button is clicked
                scrollToTopBtn.addEventListener('click', function() {
                    helpModalContent.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }
        });
    </script>

</body>
</html>
<script>
function restorePurchases() {
    // Check if the AndroidBilling interface is available
    if (window.AndroidBilling && typeof window.AndroidBilling.restorePurchases === 'function') {
        console.log('Calling AndroidBilling.restorePurchases()');
        window.AndroidBilling.restorePurchases();
        // You can optionally show a message to the user, like an alert.
        alert('Attempting to restore purchases. If you have a valid purchase, your premium status will be updated shortly.');
    } else {
        console.log('Billing interface not available. This is not an Android app environment.');
        alert('This feature is only available in the Android app.');
    }
}

// Updated UI function to manage premium status
function updateUiForPremium(isPremium) {
    // Function kept for compatibility with native Android code
    // No UI updates needed since app is now ad-free for everyone
}
</script>