<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, height=device-height, viewport-fit=cover">
    <meta name="description" content="LM Studio Assistant - A modern interface for AI chat interactions">
    <meta name="theme-color" content="#0f172a">
    <!-- Performance optimization meta tags -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="renderer" content="webkit">
    <meta name="color-scheme" content="dark light">
    <title>LMSA â€¢ AI Assistant</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts with optimized loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <!-- Fallback for browsers that don't support JS-based font loading -->
    <noscript>
        <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    </noscript>
    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/theme-variables.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="css/settings-modal.css">
    <link rel="stylesheet" href="css/system-prompt-overlay.css">
    <link rel="stylesheet" href="css/code-blocks.css">
    <link rel="stylesheet" href="css/modern-ui.css">
    <link rel="stylesheet" href="css/character-modal.css">
    <link rel="stylesheet" href="css/character-gallery.css">
    <link rel="stylesheet" href="css/continue-with-character.css">
    <link rel="stylesheet" href="css/performance-optimizations.css">
    <!-- Font Awesome with optimized loading -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    <!-- Load libraries BEFORE Monaco's RequireJS loader to prevent AMD conflicts -->
    <script src="https://cdn.jsdelivr.net/npm/marked@4.2.12/marked.min.js"></script>
    <!-- JSZip Library for DOCX file processing - moved before Monaco -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous"></script>
    <!-- Monaco Editor with CDN configuration -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/editor/editor.main.min.css">
    <script>
        // Track Monaco loading
        window.monacoLoadStartTime = Date.now();
        window.monacoLoaded = false;
        window.monacoHasErrors = false;

        // Configure Monaco's loader to use CDN paths
        window.MonacoEnvironment = {
            getWorkerUrl: function(workerId, label) {
                return `https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/base/worker/workerMain.min.js`;
            },
            baseUrl: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min'
        };

        // Simple fallback code highlighting function using pre/code
        window.renderCodeWithFallback = function(container, code, language) {
            // Skip if this container is already initialized or being initialized with Monaco
            if (container.getAttribute('data-monaco-initialized') === 'true' ||
                container.getAttribute('data-monaco-initializing') === 'true') {
                console.log('Skipping fallback renderer for container that is already being handled by Monaco');
                return;
            }

            // Clean up any existing content
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            // Create simple pre/code elements
            const pre = document.createElement('pre');
            pre.className = 'fallback-code';
            pre.style.position = 'relative';

            const codeEl = document.createElement('code');
            if (language) {
                codeEl.className = `language-${language}`;
            }
            codeEl.textContent = code;

            // Add copy button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'fallback-copy-btn';
            copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
            copyBtn.style.position = 'absolute';
            copyBtn.style.top = '5px';
            copyBtn.style.right = '5px';
            copyBtn.style.zIndex = '10';
            copyBtn.style.padding = '5px';
            copyBtn.style.background = 'rgba(30, 30, 30, 0.8)';
            copyBtn.style.border = 'none';
            copyBtn.style.borderRadius = '3px';
            copyBtn.style.cursor = 'pointer';

            copyBtn.addEventListener('click', function() {
                const originalHTML = copyBtn.innerHTML;

                // Use the improved copyToClipboard function if available, otherwise fallback
                const copyFunction = window.copyToClipboard || function(text) {
                    return navigator.clipboard.writeText(text);
                };

                copyFunction(code)
                    .then(() => {
                        // Show copied indication
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('Failed to copy code:', error);
                        copyBtn.innerHTML = '<i class="fas fa-times"></i>';
                        setTimeout(() => {
                            copyBtn.innerHTML = originalHTML;
                        }, 2000);
                    });
            });

            pre.appendChild(codeEl);
            pre.appendChild(copyBtn);
            container.appendChild(pre);

            // Mark this container as using fallback
            container.setAttribute('data-using-fallback', 'true');

            return pre;
        };

        // Define the processPendingMonacoEditors function
        window.processPendingMonacoEditors = function() {
            if (!window.pendingMonacoEditors || window.pendingMonacoEditors.length === 0) return;

            // Check if Monaco failed to load
            if (!window.monaco) {
                console.warn('Monaco not available - using fallback renderer');
                window.monacoHasErrors = true;

                // Use fallback renderer for all pending editors
                window.pendingMonacoEditors.forEach(item => {
                    if (!item || !item.container) return;

                    // Skip if this container is already initialized or being initialized with Monaco
                    if (item.container.getAttribute('data-monaco-initialized') === 'true' ||
                        item.container.getAttribute('data-using-fallback') === 'true') {
                        return;
                    }

                    try {
                        // Remove any existing fallback elements to avoid duplication
                        if (item.fallbackElement && item.fallbackElement.parentNode === item.container) {
                            item.container.removeChild(item.fallbackElement);
                        }

                        // Also check for any other fallback elements that might have been added
                        const existingFallback = item.container.querySelector('.fallback-code');
                        if (existingFallback) {
                            item.container.removeChild(existingFallback);
                        }

                        // Use our fallback renderer
                        window.renderCodeWithFallback(item.container, item.content, item.language);
                    } catch (error) {
                        console.error('Error rendering fallback:', error);
                    }
                });

                // Clear pending editors
                const processedCount = window.pendingMonacoEditors.length;
                window.pendingMonacoEditors = [];
                console.log(`Processed ${processedCount} code blocks with fallback renderer`);
                return;
            }

            console.log(`Processing ${window.pendingMonacoEditors.length} pending Monaco editors`);

            // Process in batches for better performance
            const processBatch = (startIdx, batchSize) => {
                const endIdx = Math.min(startIdx + batchSize, window.pendingMonacoEditors.length);

                for (let i = startIdx; i < endIdx; i++) {
                    const item = window.pendingMonacoEditors[i];
                    if (!item || !item.container || !item.editorContainer) continue;

                    try {
                        // Skip if this container is already initialized or being initialized
                        if (item.container.getAttribute('data-monaco-initialized') === 'true') {
                            continue;
                        }

                        // Mark as being initialized to prevent duplicate initialization
                        item.container.setAttribute('data-monaco-initializing', 'true');

                        // Remove any fallback elements
                        if (item.fallbackElement && item.fallbackElement.parentNode === item.container) {
                            item.container.removeChild(item.fallbackElement);
                        }

                        // Also check for any other fallback elements that might have been added
                        const existingFallback = item.container.querySelector('.fallback-code');
                        if (existingFallback) {
                            item.container.removeChild(existingFallback);
                        }

                        // Create Monaco editor
                        const editor = monaco.editor.create(item.editorContainer, {
                            value: item.content,
                            language: item.language,
                            readOnly: true,
                            theme: 'vs-dark',
                            minimap: { enabled: false },
                            scrollBeyondLastLine: false,
                            wordWrap: 'on',
                            automaticLayout: true,
                            lineNumbers: 'on',
                            contextmenu: true,
                            renderWhitespace: 'none',
                            renderControlCharacters: false,
                        });

                        // Mark as initialized to prevent duplicate initialization
                        item.container.setAttribute('data-monaco-initialized', 'true');
                        item.container.removeAttribute('data-monaco-initializing');

                        // Add copy action
                        editor.addAction({
                            id: 'copy-code',
                            label: 'Copy Code',
                            contextMenuGroupId: 'clipboard',
                            run: function() {
                                // Use the improved copyToClipboard function if available, otherwise fallback
                                const copyFunction = window.copyToClipboard || function(text) {
                                    return navigator.clipboard.writeText(text);
                                };

                                copyFunction(editor.getValue())
                                    .then(() => {
                                        item.container.setAttribute('data-copied', 'true');
                                        setTimeout(() => {
                                            item.container.removeAttribute('data-copied');
                                        }, 2000);
                                    })
                                    .catch((error) => {
                                        console.error('Failed to copy code:', error);
                                    });
                            }
                        });

                        // Add scroll arrows
                        const monacoContainer = item.container;
                        addScrollArrows(monacoContainer, editor);

                        // Add copy button
                        addCopyButton(monacoContainer, editor);
                    } catch (error) {
                        console.error('Error initializing Monaco editor:', error);

                        // Remove the initialization flags since Monaco failed
                        item.container.removeAttribute('data-monaco-initialized');
                        item.container.removeAttribute('data-monaco-initializing');

                        // Use fallback on error only if not already using fallback
                        if (item.container.getAttribute('data-using-fallback') !== 'true') {
                            try {
                                // Clear any partial Monaco initialization
                                while (item.container.firstChild) {
                                    item.container.removeChild(item.container.firstChild);
                                }

                                window.renderCodeWithFallback(item.container, item.content, item.language);
                            } catch (fallbackError) {
                                console.error('Fallback renderer also failed:', fallbackError);
                            }
                        }
                    }
                }

                // Process next batch if there are more editors
                if (endIdx < window.pendingMonacoEditors.length) {
                    setTimeout(() => {
                        processBatch(endIdx, batchSize);
                    }, 0);
                } else {
                    // All editors processed, clear the array
                    const processedCount = window.pendingMonacoEditors.length;
                    window.pendingMonacoEditors = [];
                    console.log(`Processed all ${processedCount} Monaco editors`);
                }
            };

            // Helper to add scroll arrows
            function addScrollArrows(container, editor) {
                // Only add arrows if not already present
                if (container.querySelector('.monaco-scroll-arrow-up')) return;

                const upArrow = document.createElement('button');
                upArrow.className = 'monaco-scroll-arrow monaco-scroll-arrow-up';
                upArrow.innerHTML = '<i class="fas fa-chevron-up"></i>';
                upArrow.setAttribute('aria-label', 'Scroll up');
                upArrow.addEventListener('click', () => {
                    const scrollPosition = editor.getScrollTop();
                    const lineHeight = editor.getOption(monaco.editor.EditorOption.lineHeight);
                    const scrollAmount = lineHeight * 5;
                    editor.setScrollTop(Math.max(0, scrollPosition - scrollAmount));
                });
                container.appendChild(upArrow);

                const downArrow = document.createElement('button');
                downArrow.className = 'monaco-scroll-arrow monaco-scroll-arrow-down';
                downArrow.innerHTML = '<i class="fas fa-chevron-down"></i>';
                downArrow.setAttribute('aria-label', 'Scroll down');
                downArrow.addEventListener('click', () => {
                    const scrollPosition = editor.getScrollTop();
                    const lineHeight = editor.getOption(monaco.editor.EditorOption.lineHeight);
                    const scrollAmount = lineHeight * 5;
                    editor.setScrollTop(scrollPosition + scrollAmount);
                });
                container.appendChild(downArrow);
            }

            // Helper to add copy button
            function addCopyButton(container, editor) {
                // Remove any existing copy button to avoid duplicates
                const existingButton = container.querySelector('.copy-button');
                if (existingButton) {
                    existingButton.remove();
                }

                // Create a new copy button
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                copyButton.setAttribute('aria-label', 'Copy code');
                copyButton.setAttribute('title', 'Copy code to clipboard');

                // Make sure the button is visible and clickable
                copyButton.style.position = 'absolute';
                copyButton.style.top = '0.5rem';
                copyButton.style.right = '0.5rem';
                copyButton.style.zIndex = '30';
                copyButton.style.pointerEvents = 'auto';

                // Add click event to copy only the code in the editor
                copyButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent event bubbling
                    e.preventDefault(); // Prevent default behavior

                    // Get the code from the editor
                    const code = editor.getValue();

                    // Copy the code to clipboard
                    // Use the improved copyToClipboard function if available, otherwise fallback
                    const copyFunction = window.copyToClipboard || function(text) {
                        return navigator.clipboard.writeText(text);
                    };

                    copyFunction(code)
                        .then(() => {
                            // Visual feedback for successful copy
                            container.setAttribute('data-copied', 'true');
                            copyButton.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                container.removeAttribute('data-copied');
                                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                            }, 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy code:', err);
                            copyButton.innerHTML = '<i class="fas fa-times"></i>';
                            setTimeout(() => {
                                copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                            }, 2000);
                        });
                });

                // Add the button to the container
                container.appendChild(copyButton);

                // Log that the button was added
                console.log('Copy button added to Monaco editor');
            }

            // Start processing with the first batch
            processBatch(0, 5);
        };

        // Load Monaco editor asynchronously
        document.addEventListener('DOMContentLoaded', function() {
            // Set a flag that Monaco is loading
            window.monacoLoading = true;

            // Initialize empty array for pending editors
            window.pendingMonacoEditors = window.pendingMonacoEditors || [];

            // Add global error handler for script loading
            window.addEventListener('error', function(e) {
                if (e.filename && e.filename.includes('monaco')) {
                    console.error('Monaco load error:', e);
                    window.monacoHasErrors = true;

                    // If we have pending editors and Monaco failed, use fallback
                    if (window.pendingMonacoEditors && window.pendingMonacoEditors.length > 0) {
                        window.processPendingMonacoEditors();
                    }
                }
            }, true);

            // Try to load Monaco
            try {
                // Load Monaco's loader first
                const loaderScript = document.createElement('script');
                loaderScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs/loader.min.js';

                loaderScript.onload = function() {
                    try {
                        // Now properly configure require
                        require.config({
                            paths: {
                                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.39.0/min/vs'
                            }
                        });

                        // Load editor main module
                        require(['vs/editor/editor.main'], function() {
                            window.monacoLoading = false;
                            window.monacoLoaded = true;
                            console.log('Monaco editor loaded successfully');

                            // Process any pending editors
                            if (window.processPendingMonacoEditors) {
                                window.processPendingMonacoEditors();
                            }
                        }, function(error) {
                            console.error('Failed to load Monaco:', error);
                            window.monacoHasErrors = true;
                            window.monacoLoading = false;

                            // Use fallback renderer if Monaco fails to load
                            if (window.pendingMonacoEditors && window.pendingMonacoEditors.length > 0) {
                                window.processPendingMonacoEditors();
                            }
                        });
                    } catch (error) {
                        console.error('Error configuring Monaco:', error);
                        window.monacoHasErrors = true;
                        window.monacoLoading = false;
                    }
                };

                loaderScript.onerror = function(error) {
                    console.error('Failed to load Monaco loader script:', error);
                    window.monacoHasErrors = true;
                    window.monacoLoading = false;

                    // Use fallback renderer if Monaco loader fails
                    if (window.pendingMonacoEditors && window.pendingMonacoEditors.length > 0) {
                        window.processPendingMonacoEditors();
                    }
                };

                document.head.appendChild(loaderScript);
            } catch (error) {
                console.error('Critical error loading Monaco:', error);
                window.monacoHasErrors = true;
                window.monacoLoading = false;
            }

            // Set up a fallback in case Monaco doesn't load
            setTimeout(function() {
                if (!window.monaco && window.pendingMonacoEditors && window.pendingMonacoEditors.length > 0) {
                    console.log('Monaco failed to load within timeout, using fallback renderer');
                    window.monacoHasErrors = true;
                    window.monacoLoading = false;
                    window.processPendingMonacoEditors();
                }
            }, 8000); // 8 second timeout
        });
    </script>

    <script>
        // Initialize pending Monaco editors when Monaco is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Check if Monaco is already loaded
            if (window.monaco) {
                window.processPendingMonacoEditors();
            }

            // Set up an observer to detect when monaco becomes available
            let monacoCheckInterval = setInterval(function() {
                if (window.monaco) {
                    clearInterval(monacoCheckInterval);
                    window.processPendingMonacoEditors();
                }
            }, 50); // Faster check interval
        });
    </script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        darkBg: '#121212',
                        darkSecondary: '#1e1e1e',
                        darkTertiary: '#2c2c2c',
                    },
                },
            },
        }
    </script>
    <style>
        /* Custom animation for the contact form modal */
        @keyframes modalFadeIn {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes modalFadeOut {
            from { opacity: 1; transform: scale(1) translateY(0); }
            to { opacity: 0; transform: scale(0.95) translateY(10px); }
        }

        .animate-modal-in {
            animation: modalFadeIn 0.3s ease-out forwards;
        }

        .animate-modal-out {
            animation: modalFadeOut 0.3s ease-in forwards;
        }

        /* Subtle pulsing animation for the envelope icon */
        @keyframes subtlePulse {
            0%, 100% { opacity: 0.9; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        .animate-pulse-subtle {
            animation: subtlePulse 2s ease-in-out infinite;
        }

        /* Wobble animation for the paper plane icon */
        @keyframes wobble {
            0%, 100% { transform: translateX(0); }
            15% { transform: translateX(-5px) rotate(-5deg); }
            30% { transform: translateX(3px) rotate(3deg); }
            45% { transform: translateX(-3px) rotate(-2deg); }
            60% { transform: translateX(2px) rotate(1deg); }
            75% { transform: translateX(-1px) rotate(-1deg); }
        }

        .group-hover\:animate-wobble:hover {
            animation: wobble 0.8s ease-in-out;
        }

        #contact-form-modal .modal-content {
            animation: modalFadeIn 0.3s ease-out forwards;
        }

        #contact-form-modal .modal-content.animate-modal-out {
            animation: modalFadeOut 0.3s ease-in forwards;
        }

        /* Improved styling for the form container */
        .contact-form-container {
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        /* Pulse animation for the close button on hover */
        #close-contact-form:hover {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Button animations */
        #rate-app-link.active-scale,
        #official-website-link.active-scale {
            transform: scale(0.95);
            opacity: 0.9;
        }

        #rate-app-link,
        #official-website-link {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            overflow: hidden;
        }

        /* Pulsing effect for the rating button */

        /* Slow spin animation for icons */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes shimmerButton {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }

        /* Input glow animation - glows twice */
        @keyframes inputGlow {
            0% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.3); }
            25% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8), 0 0 25px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.3); }
            75% { box-shadow: 0 0 15px rgba(59, 130, 246, 0.8), 0 0 25px rgba(59, 130, 246, 0.5); }
            100% { box-shadow: 0 0 5px rgba(59, 130, 246, 0.5), 0 0 10px rgba(59, 130, 246, 0.3); }
        }

        .input-glow {
            animation: inputGlow 2.5s ease-in-out;
            border-color: #3b82f6 !important;
            outline: none;
        }

        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }
        @keyframes ratingPulse {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }

        #rate-app-link {
            animation: ratingPulse 2s infinite;
        }

        #rate-app-link:hover {
            animation: none;
            box-shadow: 0 10px 20px -10px rgba(234, 88, 12, 0.6);
            transform: translateY(-3px);
        }

        #rate-app-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: translateX(-100%);
        }

        #rate-app-link:hover::before {
            animation: shimmerButton 1s forwards;
        }

        @keyframes shimmerButton {
            to { transform: translateX(100%); }
        }

        /* Hide scrollbars but keep content scrollable */
        .overflow-y-auto::-webkit-scrollbar {
            display: none;
        }

        /* Exception for settings modal content wrapper - show scrollbar */
        #settings-content-wrapper::-webkit-scrollbar {
            display: block !important;
            width: 8px;
        }

        /* Help modal specific scrollbar styles */
        #help-modal .help-modal-content::-webkit-scrollbar {
            display: block !important;
            width: 8px;
        }

        #help-modal .help-modal-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        #help-modal .help-modal-content::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 4px;
            border: 2px solid var(--scrollbar-track);
        }

        #help-modal .help-modal-content::-webkit-scrollbar-thumb:hover,
        #help-modal .help-modal-content::-webkit-scrollbar-thumb:active {
            background-color: var(--scrollbar-thumb-hover);
        }
    </style>
</head>
<body class="dark custom-dark-mode" style="min-height: 100vh; min-height: -webkit-fill-available; display: flex; flex-direction: column;">
    <div class="flex flex-col h-screen" style="min-height: 100vh; min-height: -webkit-fill-available;">
        <!-- Header - Enhanced with modern styling and effects -->
        <header class="p-4 flex justify-between items-center animate-fade-in">
            <div class="flex items-center flex-shrink-0">
                <div class="w-10 h-10 mr-3 relative overflow-hidden rounded-xl bg-gradient-to-br from-blue-500 to-indigo-700 shadow-xl flex items-center justify-center">
                    <img src="icon.png" alt="LMSA Icon" class="w-7 h-7 relative z-10">
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50"></div>
                </div>
                <h1 class="text-2xl font-bold header-title">LMSA</h1>
            </div>
            <div class="flex items-center space-x-1 header-controls">
                <button id="settings-icon-button" class="p-2 rounded-md focus:outline-none transition-all duration-300 header-btn" data-priority="2" aria-label="Settings" title="Open settings">
                    <span class="icon-wrapper">
                        <i class="fas fa-cog text-xl header-icon"></i>
                    </span>
                </button>
                <button id="model-toggle-button" class="p-2 rounded-md focus:outline-none transition-all duration-300 header-btn" data-priority="3" aria-label="Toggle Model Info" title="Toggle model info display">
                    <span class="icon-wrapper">
                        <i class="fas fa-robot text-xl header-icon"></i>
                    </span>
                </button>
                <button id="help-icon-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="4" aria-label="Help" title="Open help">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 1 1 0-18 9 9 0 0 1 0 18z"></path>
                        </svg>
                    </span>
                </button>
                <button id="refresh-button" class="p-2 rounded-md focus:outline-none header-btn" data-priority="5" aria-label="Refresh Model" title="Refresh model from LM Studio">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </span>
                </button>
                <button id="preview-toggle" class="p-2 rounded-md focus:outline-none relative header-btn" data-priority="6" aria-label="Toggle Mobile/Tablet View" title="Toggle between mobile and tablet view">
                    <div class="flex items-center">
                        <span class="icon-wrapper">
                            <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </span>
                        <span class="ml-1 text-xs font-medium hidden md:inline-block">View</span>
                    </div>
                    <div class="absolute -top-1 -right-1 w-3 h-3 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full hidden shadow-lg" id="view-mode-indicator"></div>
                </button>
                <button id="sidebar-toggle" class="p-2 rounded-md focus:outline-none header-btn" data-priority="1" aria-label="Toggle Sidebar">
                    <span class="icon-wrapper">
                        <svg class="w-5 h-5 header-icon" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </header>

        <!-- Model display bar with wrapper to prevent background issues -->
        <div id="loaded-model-wrapper">
            <div id="loaded-model" class="font-bold py-2 px-4 text-center animate-fade-in"></div>
        </div>

        <!-- Sidebar overlay - for closing sidebar when clicking outside on mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-10 hidden backdrop-blur-sm sidebar-overlay" style="will-change: opacity; transform: none !important;"></div>

        <!-- Sidebar - now positioned fixed outside the flex container -->
        <div id="sidebar" class="w-[280px] z-20 hidden shadow-xl overflow-y-auto" style="color: var(--sidebar-text);">
            <div class="relative flex items-center justify-end p-6 border-b sidebar-header" style="border-color: var(--sidebar-border);">
                <button id="close-sidebar" class="p-2 rounded-full focus:outline-none transition-all duration-200 close-sidebar-btn" style="color: var(--text-muted);" aria-label="Close Sidebar">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Main Menu Section -->
            <div class="sidebar-section main-menu-section">
                <button id="new-chat" class="menu-item w-full text-left">
                    <i class="fas fa-plus-circle w-6 mr-3"></i>
                    New Chat
                </button>
            </div>

            <!-- Options Section -->
            <div class="sidebar-section collapsible">
                <button class="section-header w-full text-left flex items-center justify-between py-2 px-3">
                    <div class="flex items-center">
                        <i class="fas fa-cog w-6 mr-3"></i>
                        <span>Options</span>
                    </div>
                    <i class="fas fa-chevron-down transition-transform duration-200"></i>
                </button>
                <div class="collapsible-content">
                    <!-- Settings -->
                    <button id="settings-btn" class="menu-item w-full text-left">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>

                    <!-- Import/Export -->
                    <button id="import-export-group-btn" class="menu-item w-full text-left flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-exchange-alt"></i>
                            Import/Export
                        </div>
                        <i class="fas fa-caret-down transition-transform duration-200"></i>
                    </button>
                    <div id="import-export-container" class="hidden">
                        <button id="import-chats-btn" class="menu-item w-full text-left">
                            <i class="fas fa-file-import"></i>
                            Import Chats
                        </button>
                        <button id="export-chats-btn" class="menu-item w-full text-left">
                            <i class="fas fa-file-export"></i>
                            Export Chats
                        </button>
                    </div>

                    <!-- Model Settings -->
                    <button id="model-btn" class="menu-item w-full text-left">
                        <i class="fas fa-robot"></i>
                        Models
                    </button>

                    <!-- Characters -->
                    <button id="characters-btn" class="menu-item w-full text-left">
                        <i class="fas fa-user-circle"></i>
                        Characters
                    </button>
                    <button id="create-character-btn" class="menu-item w-full text-left">
                        <i class="fas fa-user-plus"></i>
                        Create Character
                    </button>

                      <!-- Help & About -->
                    <button id="help-btn" class="menu-item w-full text-left">
                        <i class="fas fa-question-circle"></i>
                        Help
                    </button>
                    <button id="whats-new-btn" class="menu-item w-full text-left">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        What's New
                    </button>
                    <button id="about-btn" class="menu-item w-full text-left">
                        <i class="fas fa-info-circle"></i>
                        About
                    </button>
                    

                </div>
            </div>

            <!-- Chat History Section -->
            <div class="sidebar-section">
                <div class="w-full text-left flex items-center py-2 px-3 mb-2">
                    <i class="fas fa-comments w-6 mr-3 chat-history-icon"></i>
                    <span class="chat-history-title">CHAT HISTORY</span>
                </div>
                <div id="chat-history" class="overflow-y-auto max-h-[calc(100vh-200px)] px-2">
                    <!-- Chat history items will be dynamically added here -->
                </div>
            </div>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <!-- Main content -->
            <div class="flex-1 flex flex-col overflow-hidden" style="transform: none !important; display: flex; flex-direction: column; min-height: 0; background-color: var(--bg-primary);">
                <!-- Chat container -->
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 flex flex-col relative">
                    <div id="welcome-message" class="absolute inset-0 flex items-center justify-center text-center animate-fade-in" style="transform: none !important; left: 0; right: 0; color: var(--text-muted);" onscroll="return false;">
                        <div class="welcome-content glass-card p-8 sm:p-10 max-w-md mx-auto transform transition-all">
                            <div class="relative mx-auto mb-4 sm:mb-6 mt-2 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-xl flex items-center justify-center icon-container" style="width: 5.5rem; height: 5.5rem; min-height: 5rem; min-width: 5rem; padding: 0.75rem;">
                                <img src="icon.png" alt="LMSA Icon" class="relative z-10 object-contain" style="width: 3.5rem; height: 3.5rem; max-width: 75%; max-height: 75%;">
                                <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent opacity-50"></div>
                                <div class="absolute -top-8 -left-8 sm:-top-10 sm:-left-10 w-16 h-16 sm:w-20 sm:h-20 bg-white/10 rounded-full blur-xl"></div>
                                <div class="absolute -bottom-8 -right-8 sm:-bottom-10 sm:-right-10 w-16 h-16 sm:w-20 sm:h-20 bg-blue-400/10 rounded-full blur-xl"></div>
                            </div>

                            <h1 class="text-xl sm:text-2xl font-bold mb-2 tracking-tight header-title">LM Studio Assistant</h1>
                            <p class="mb-5 sm:mb-7 opacity-90 leading-relaxed text-sm sm:text-base">
                                LM Studio on your Android.
                            </p>

                            <div class="grid grid-cols-1 gap-4 mb-8">
                                <!-- Settings Button - Professional styling -->
                                <button id="get-started-btn" class="professional-button flex items-center justify-center gap-3 w-full h-[48px]">
                                    <i class="fas fa-cog text-sm"></i>
                                    <span>Settings</span>
                                </button>

                                <!-- Character Gallery Button - Professional styling -->
                                <button id="welcome-character-gallery-btn" class="professional-button flex items-center justify-center gap-3 w-full h-[48px]">
                                    <i class="fas fa-users text-sm"></i>
                                    <span>Characters</span>
                                </button>

                                <!-- Models Button - Professional styling -->
                                <button id="welcome-models-btn" class="professional-button flex items-center justify-center gap-3 w-full h-[48px]">
                                    <i class="fas fa-microchip text-sm"></i>
                                    <span>Models</span>
                                </button>

                                <!-- Secondary buttons in a 2-column grid with professional styling -->
                                <div class="grid grid-cols-2 gap-3 w-full">
                                    <button id="welcome-new-chat-btn" class="professional-button flex items-center justify-center gap-2 w-full h-[48px]">
                                        <i class="fas fa-bookmark text-sm"></i>
                                        <span>Saved</span>
                                    </button>

                                    <button id="welcome-help-btn" class="professional-button flex items-center justify-center gap-2 w-full h-[48px]">
                                        <i class="fas fa-question-circle text-sm"></i>
                                        <span>Help</span>
                                    </button>
                                </div>
                            </div>

                            <div id="welcome-theme-toggle" class="flex flex-col items-center justify-center">
                                <div class="text-sm mb-2 font-medium" style="color: var(--text-secondary);">Appearance</div>
                                <div class="flex items-center bg-opacity-20 rounded-full px-4 py-2 welcome-toggle-container" style="background-color: var(--settings-label-bg);">
                                    <label for="welcome-toggle" class="flex items-center cursor-pointer">
                                        <i class="fas fa-moon mr-2 text-blue-400 dark-icon"></i>
                                        <div class="toggle-container mx-2">
                                            <input type="checkbox" id="welcome-toggle" class="hidden">
                                            <div class="toggle-switch"></div>
                                            <div class="toggle-dot"></div>
                                        </div>
                                        <i class="fas fa-sun ml-2 text-yellow-400 light-icon"></i>
                                    </label>
                                </div>
                            </div>

                            <div id="welcome-footer" class="mt-8 pt-5 pb-3 border-t border-white/10 text-xs">
                                <p class="opacity-60 dark-footer-text pt-1 pb-1">Developed with <i class="fas fa-heart text-red-500 mx-1"></i> for local AI enthusiasts</p>
                            </div>
                        </div>
                    </div>
                    <div id="messages" class="flex-1"></div>
                    <div id="loading-indicator" class="hidden" style="display: flex; align-items: center; text-align: left; direction: ltr;">
                        <span class="loading-ellipsis" style="display: inline-block; white-space: nowrap; text-align: left; direction: ltr;">...</span>
                    </div>
                </div>

                <!-- Input area -->
                <div class="border-t animate-fade-in" style="position: relative; z-index: 10; border-color: var(--border-color); width: 100%; box-sizing: border-box; margin-top: auto;">
                    <!-- Active Character Display -->
                    <div id="active-character-display" class="hidden">
                        <!-- Character badge will be dynamically added here -->
                    </div>

                    <form id="chat-form" class="flex" style="position: relative; background-color: var(--bg-secondary);">
                        <div class="flex-grow relative">
                            <input type="text" id="user-input" class="w-full focus:outline-none" placeholder="Type your message..." aria-label="Type your message" autocomplete="off" style="background-color: var(--input-bg); color: var(--input-text); border: 1px solid var(--input-border);" oninput="this.scrollLeft = this.scrollWidth">
                            <div class="absolute top-1/2 transform -translate-y-1/2">
                                <button type="button" id="paperclip-button" class="focus:outline-none transition-all duration-300 ease-in-out p-1" style="color: var(--text-muted);">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-500 text-white focus:outline-none transition-all duration-300 ease-in-out" aria-label="Send message">
                            <div class="flex items-center">
                                <i class="fas fa-paper-plane"></i>
                                <span class="ml-2 hidden md:inline">Send</span>
                            </div>
                        </button>
                        <button type="button" id="stop-button" class="bg-red-600 text-white hover:bg-red-700 focus:outline-none transition-all duration-300 ease-in-out hidden">
                            <i class="fas fa-stop mr-1"></i><span>Stop</span>
                        </button>
                        <input type="file" id="file-upload-input" class="hidden" multiple accept=".txt,.pdf,.json,.csv,.tsv,.xml,.html,.log,.md,.yaml,.yml,.jsonl,.jsonlines,.c,.cpp,.h,.hpp,.py,.js,.ts,.jsx,.tsx,.sh,.ps1,.docx">
                    </form>
                </div>

                <!-- Empty message modal -->
                <div id="empty-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" aria-labelledby="empty-message-title" role="dialog" aria-modal="true">
                    <div class="modal-content">
                        <div class="modal-header">
                            <i class="fas fa-exclamation-circle"></i>
                            <h3 id="empty-message-title" class="modal-title">Empty Message</h3>
                        </div>
                        <div class="modal-body">
                            Please enter a message before sending.
                        </div>
                        <div class="modal-footer">
                            <button class="close-modal" aria-label="Close modal">
                                <i class="fas fa-times mr-2"></i>Close
                            </button>
                            <div class="modal-body">
                                Please enter a message before sending.
                            </div>
                            <div class="modal-footer">
                                <button class="close-modal" aria-label="Close modal">
                                    <i class="fas fa-times mr-2"></i>Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal" class="fixed inset-0 flex items-center justify-center hidden modal-container" aria-labelledby="settings-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content border border-white/10">
            <!-- Settings Header -->
            <div class="flex flex-col sticky top-0 z-10 mb-6 pb-1 border-b border-gray-700/30 bg-inherit">
                <div class="flex justify-between items-center mb-2">
                    <h2 id="settings-title" class="text-xl font-bold flex items-center">
                        <i class="fas fa-cog text-blue-400 mr-2"></i>Settings
                    </h2>
                    <button id="close-settings-x" class="text-gray-400 hover:text-white focus:outline-none transition-all duration-300 ease-in-out rounded-full hover:bg-gray-800/50 w-8 h-8 flex items-center justify-center" aria-label="Close settings">
                        <i class="fas fa-times text-lg"></i>
                    </button>
                </div>

                <!-- Mobile step indicators - moved to their own row -->
                <div class="flex justify-center space-x-3 py-2 lg:hidden">
                    <div class="w-8 h-2 rounded-full bg-blue-500 transition-all duration-300" id="step-indicator-1"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600 transition-all duration-300" id="step-indicator-2"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600 transition-all duration-300" id="step-indicator-3"></div>
                    <div class="w-8 h-2 rounded-full bg-gray-600 transition-all duration-300" id="step-indicator-4"></div>
                </div>
            </div>

            <!-- Settings Content - Multi-step on mobile -->
            <div id="settings-content-wrapper" class="relative px-1">
                <!-- Step 1: Connection Settings (always visible first) -->
                <div id="settings-step-connection" class="settings-step active" data-step-name="Connection">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1 text-gray-200">
                            <i class="fas fa-server mr-2 text-blue-400"></i>LM Studio Server Connection:</label>
                        <div class="flex space-x-2 ip-port-container">
                            <div class="flex-grow">
                                <label for="server-ip" class="block text-xs text-gray-300 mb-1">IP Address</label>
                                <input type="text" id="server-ip" class="w-full text-gray-100 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-400" placeholder="e.g. 192.168.1.100" pattern="^[0-9.]*$" inputmode="numeric" onkeypress="return event.charCode === 46 || (event.charCode >= 48 && event.charCode <= 57)" autocomplete="off" data-form-type="other">
                            </div>
                            <div class="w-32 port-input-container"> <!-- Increased width from w-28 to w-32 -->
                                <label for="server-port" class="block text-xs text-gray-300 mb-1">Port</label>
                                <input type="text" id="server-port" class="w-full text-gray-100 border border-gray-600 rounded px-3 py-2 focus:outline-none focus:border-blue-400" placeholder="1234" pattern="^[0-9]*$" inputmode="numeric" onkeypress="return event.charCode >= 48 && event.charCode <= 57" autocomplete="off" data-form-type="other">
                            </div>
                        </div>
                        <p class="text-xs text-gray-300 mt-1">The complete URL will be automatically formatted as: http://<span class="text-blue-400">[IP]:[PORT]</span>/v1/chat/completions</p>
                    </div>
                </div>

                <!-- Step 2: System Prompt -->
                <div id="settings-step-prompt" class="settings-step hidden" data-step-name="Prompt">
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-1">
                            <i class="fas fa-comment-dots mr-2 text-blue-400"></i>System Prompt (Optional):</label>

                        <!-- Hidden real textarea that holds the actual value -->
                        <textarea id="system-prompt" class="hidden" rows="4"></textarea>

                        <!-- Display current prompt value (non-interactive) -->
                        <div id="system-prompt-preview" class="border p-3 rounded-lg min-h-[80px] mb-2 whitespace-pre-wrap" style="background-color: var(--settings-input-bg); color: var(--settings-input-text); border-color: var(--settings-input-border);"><span class="italic" id="prompt-placeholder" style="color: var(--text-muted);">Leave empty to pass user messages directly to LM Studio without any system prompt</span></div>

                        <!-- Edit button -->
                        <button id="edit-system-prompt-btn" class="w-full text-white rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out" style="background: linear-gradient(135deg, #1e40af, #3b82f6); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15); border: none; font-weight: 600; letter-spacing: 0.02em; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(37, 99, 235, 0.3), 0 4px 8px -1px rgba(37, 99, 235, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2)'; this.style.background='linear-gradient(135deg, #2563eb, #60a5fa)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15)'; this.style.background='linear-gradient(135deg, #1e40af, #3b82f6)';">
                            <i class="fas fa-edit mr-2" style="position: relative;"></i><span style="position: relative;">Edit System Prompt</span>
                        </button>
                    </div>
                </div>

                <!-- Step 3: Options -->
                <div id="settings-step-options" class="settings-step hidden" data-step-name="Options">
                    <div class="mb-4">
                        <label for="temperature" class="block text-sm font-medium mb-1">
                            <i class="fas fa-sliders-h mr-2 text-blue-400"></i>Temperature: <span id="temperature-value">0.3</span></label>
                        <div class="flex items-center">
                            <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.3" class="w-full bg-darkTertiary text-gray-100 rounded-lg appearance-none cursor-pointer" disabled>
                            <button id="temperature-lock" class="ml-2 text-gray-100 focus:outline-none p-2 transition-all duration-300" aria-label="Toggle Temperature Lock" title="Temperature is locked (click to unlock)">
                                <i class="fas fa-lock text-red-400"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="hide-thinking" class="text-sm font-medium">
                                <i class="fas fa-eye-slash mr-2 text-blue-400"></i>Hide Thinking Text</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="hide-thinking">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, hides text between &lt;think&gt; tags in model responses</p>
                    </div>
                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="auto-generate-titles" class="text-sm font-medium">
                                <i class="fas fa-magic mr-2 text-blue-400"></i>Auto-Generate Chat Titles</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="auto-generate-titles">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, uses the LLM to generate a short title (2-3 words) that describes what the chat is about based on your first message.</p>
                    </div>

                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="theme-toggle" class="text-sm font-medium">
                                <i class="fas fa-moon mr-2 text-blue-400"></i>Light Theme</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="theme-toggle">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, switches the app to light theme. When disabled, uses the default dark theme.</p>
                    </div>

                    <div class="mb-5">
                        <div class="flex justify-between items-center mb-2">
                            <label for="disable-auto-scroll" class="text-sm font-medium">
                                <i class="fas fa-arrows-alt-v mr-2 text-blue-400"></i>Disable Auto-Scroll</label>
                            <div class="toggle-container">
                                <input type="checkbox" id="disable-auto-scroll">
                                <div class="toggle-switch"></div>
                                <div class="toggle-dot"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">When enabled, disables automatic scrolling to the bottom of the chat when new messages arrive.</p>
                    </div>



                </div>

                <!-- Step 4: Actions -->
                <div id="settings-step-actions" class="settings-step hidden" data-step-name="Actions">
                    <div class="mb-4">
                        <h3 class="text-sm font-medium mb-3 text-gray-200">
                            <i class="fas fa-bolt mr-2 text-blue-400"></i>Actions:</h3>
                        <button id="clear-chat" class="w-full text-white rounded-lg px-4 py-2 focus:outline-none mb-4 transition-all duration-300 ease-in-out" style="background: linear-gradient(135deg, #dc2626, #ef4444); box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2), 0 2px 4px -1px rgba(220, 38, 38, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15); border: none; font-weight: 600; letter-spacing: 0.02em; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(220, 38, 38, 0.3), 0 4px 8px -1px rgba(220, 38, 38, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2)'; this.style.background='linear-gradient(135deg, #b91c1c, #f87171)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(220, 38, 38, 0.2), 0 2px 4px -1px rgba(220, 38, 38, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15)'; this.style.background='linear-gradient(135deg, #dc2626, #ef4444)';">
                            <i class="fas fa-trash-alt mr-2" style="position: relative;"></i><span style="position: relative;">Clear All Chats</span>
                        </button>
                        <button id="reset-app" class="w-full text-white rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out" style="background: linear-gradient(135deg, #991b1b, #b91c1c); box-shadow: 0 4px 6px -1px rgba(153, 27, 27, 0.2), 0 2px 4px -1px rgba(153, 27, 27, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15); border: none; font-weight: 600; letter-spacing: 0.02em; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(153, 27, 27, 0.3), 0 4px 8px -1px rgba(153, 27, 27, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2)'; this.style.background='linear-gradient(135deg, #7f1d1d, #dc2626)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(153, 27, 27, 0.2), 0 2px 4px -1px rgba(153, 27, 27, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15)'; this.style.background='linear-gradient(135deg, #991b1b, #b91c1c)';">
                            <i class="fas fa-exclamation-triangle mr-2" style="position: relative;"></i><span style="position: relative;">Reset App</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Navigation buttons container (static, above save button) -->
            <div id="settings-navigation-buttons" class="lg:hidden mt-5 mb-2">
                <!-- Connection step buttons -->
                <div class="flex justify-end navigation-buttons" id="connection-step-buttons">
                    <button id="to-prompt-step-btn" class="w-[48%] text-white rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out flex items-center justify-center" style="background: linear-gradient(135deg, #1e40af, #3b82f6); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1); border: none; font-weight: 600;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(37, 99, 235, 0.3), 0 4px 8px -1px rgba(37, 99, 235, 0.2)'; this.style.background='linear-gradient(135deg, #2563eb, #60a5fa)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1)'; this.style.background='linear-gradient(135deg, #1e40af, #3b82f6)';">
                        <i class="fas fa-arrow-right mr-2"></i><span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Prompt step buttons -->
                <div class="flex justify-between navigation-buttons hidden" id="prompt-step-buttons">
                    <button id="back-to-connection-btn" class="w-[48%] bg-gray-600 text-white rounded-lg px-4 py-2 hover:bg-gray-700 focus:outline-none transition-all duration-300 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i><span class="button-text">Back</span>
                    </button>
                    <button id="to-options-step-btn" class="w-[48%] bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                        <i class="fas fa-arrow-right mr-2"></i><span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Options step buttons -->
                <div class="flex justify-between navigation-buttons hidden" id="options-step-buttons">
                    <button id="back-to-prompt-btn" class="w-[48%] bg-gray-600 text-white rounded-lg px-4 py-2 hover:bg-gray-700 focus:outline-none transition-all duration-300 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i><span class="button-text">Back</span>
                    </button>
                    <button id="to-actions-step-btn" class="w-[48%] bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                        <i class="fas fa-arrow-right mr-2"></i><span class="button-text">Next</span>
                    </button>
                </div>

                <!-- Actions step buttons -->
                <div class="flex justify-between navigation-buttons hidden" id="actions-step-buttons">
                    <button id="back-to-options-btn" class="w-[48%] bg-gray-600 text-white rounded-lg px-4 py-2 hover:bg-gray-700 focus:outline-none transition-all duration-300 ease-in-out">
                        <i class="fas fa-arrow-left mr-2"></i><span class="button-text">Back</span>
                    </button>
                    <button id="settings-help-btn" class="w-[48%] text-white rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out flex items-center justify-center" style="background: linear-gradient(135deg, #ff8a00, #e63c00); box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.2), 0 2px 4px -1px rgba(249, 115, 22, 0.1); border: none; font-weight: 600;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(249, 115, 22, 0.3), 0 4px 8px -1px rgba(249, 115, 22, 0.2)'; this.style.background='linear-gradient(135deg, #ff9d33, #ff5722)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(249, 115, 22, 0.2), 0 2px 4px -1px rgba(249, 115, 22, 0.1)'; this.style.background='linear-gradient(135deg, #ff8a00, #e63c00)';">
                        <i class="fas fa-question-circle mr-2"></i><span class="button-text">Help</span>
                    </button>
                </div>
            </div>

            <!-- Elegant separator between navigation buttons and save button -->
            <div class="flex justify-center items-center my-3 lg:hidden">
                <div class="h-[1px] w-1/3 bg-gradient-to-r from-transparent via-gray-500/40 to-transparent" style="background: linear-gradient(to right, transparent, var(--border-color), transparent);"></div>
                <div class="mx-2">
                    <div class="w-1.5 h-1.5 rounded-full bg-blue-500/60" style="background: var(--toggle-active-bg); box-shadow: 0 0 5px var(--toggle-active-bg);"></div>
                </div>
                <div class="h-[1px] w-1/3 bg-gradient-to-r from-transparent via-gray-500/40 to-transparent" style="background: linear-gradient(to right, transparent, var(--border-color), transparent);"></div>
            </div>

            <!-- Save button (always visible) -->
            <div class="mt-1">
                <button id="close-settings" class="w-full text-white rounded-lg px-4 py-3 focus:outline-none transition-all duration-300 ease-in-out flex items-center justify-center" style="background: linear-gradient(to right, #059669, #10b981); border: none; font-weight: 600; letter-spacing: 0.01em; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); position: relative;">
                    <i class="fas fa-check mr-2"></i>
                    <span>Apply Changes</span>
                </button>

                <!-- Simple divider -->
                <div class="flex justify-center mt-3">
                    <div class="h-[1px] w-1/2 bg-gray-600/30"></div>
                </div>
            </div>

            <script>
                // Add subtle hover effects for save button
                document.addEventListener('DOMContentLoaded', function() {
                    const saveBtn = document.getElementById('close-settings');

                    if (saveBtn) {
                        saveBtn.addEventListener('mouseover', function() {
                            this.style.transform = 'translateY(-2px)';
                            this.style.boxShadow = '0 6px 10px rgba(0, 0, 0, 0.15)';
                            this.style.background = 'linear-gradient(to right, #047857, #10b981)';
                        });

                        saveBtn.addEventListener('mouseout', function() {
                            this.style.transform = 'translateY(0)';
                            this.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                            this.style.background = 'linear-gradient(to right, #059669, #10b981)';
                        });
                    }
                });
            </script>

            <!-- Desktop view - all settings at once (only for large screens) -->
            <div class="hidden lg:block mt-4">
                <!-- This content is only for desktop and will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation modal for delete all chats (deprecated - kept for backward compatibility) -->
    <div id="delete-all-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" role="dialog" aria-modal="true" style="display: none !important; visibility: hidden;">
        <div class="bg-darkSecondary p-6 rounded-lg w-96 max-w-[90%] shadow-lg">
            <h2 class="text-xl font-bold mb-4 flex items-center text-red-500">
                <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Delete All
            </h2>
            <p class="text-gray-300 mb-6">Are you sure you want to delete all chats? This action cannot be undone.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-all" class="bg-gray-600 text-white rounded px-4 py-2 hover:bg-gray-700 transition-colors duration-300">Cancel</button>
                <button id="confirm-delete-all" class="bg-red-600 text-white rounded px-4 py-2 hover:bg-red-700 transition-colors duration-300">Delete All</button>
            </div>
        </div>
    </div>

    <!-- Confirmation modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden animate-fade-in" aria-labelledby="confirmation-title" role="dialog" aria-modal="true" onclick="if(event.target === this) { document.getElementById('cancel-action').click(); }">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg mx-auto my-auto" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="confirmation-title" class="text-xl font-bold mb-4 flex items-center modal-title">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-500"></i>Confirm Action
            </h2>
            <p id="confirmation-message" class="mb-4"></p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-action" class="rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-action" class="bg-red-600 text-white rounded-lg px-4 py-2 hover:bg-red-700 focus:outline-none transition-all duration-300 ease-in-out">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Clear System Prompt Confirmation Modal -->
    <div id="clear-system-prompt-modal" class="fixed inset-0 bg-black/80 dark:bg-black/80 light:bg-gray-900/50 backdrop-blur-sm flex items-center justify-center hidden modal-container z-[2100]" aria-labelledby="clear-system-prompt-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-red-950/95 to-red-900/95 dark:from-[#2d0a0a] dark:to-[#3d0d0d] light:from-red-50 light:to-red-100 p-6 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-red-900/30 dark:border-red-900/30 light:border-red-200 overflow-hidden animate-modal-in">
            <div class="flex justify-between items-center mb-4">
                <h2 id="clear-system-prompt-title" class="text-xl font-bold flex items-center">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-red-500/20 dark:bg-red-500/20 light:bg-red-500/10 w-10 h-10 text-red-400 dark:text-red-400 light:text-red-600">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-300 dark:from-red-400 dark:to-red-300 light:from-red-600 light:to-red-700">Clear System Prompt</span>
                </h2>
                <button id="close-clear-system-prompt-modal" class="text-gray-400 hover:text-white dark:text-gray-400 dark:hover:text-white light:text-gray-600 light:hover:text-gray-800 focus:outline-none transition-all duration-300 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <div class="p-4 rounded-lg bg-red-900/20 dark:bg-red-900/20 light:bg-red-100/80 border border-red-800/30 dark:border-red-800/30 light:border-red-300 mb-4">
                    <p class="text-gray-300 dark:text-gray-300 light:text-black mb-2">Are you sure you want to clear the system prompt?</p>
                    <p class="text-red-300 dark:text-red-300 light:text-black text-sm flex items-start">
                        <i class="fas fa-exclamation-triangle mt-0.5 mr-2 text-red-300 dark:text-red-300 light:text-black"></i>
                        <span>This action will remove all content from the system prompt. This cannot be undone.</span>
                    </p>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="cancel-clear-system-prompt" class="flex-1 py-2.5 px-4 rounded-lg transition-all duration-300 bg-gray-700/50 hover:bg-gray-700 dark:bg-gray-700/50 dark:hover:bg-gray-700 light:bg-black light:hover:bg-gray-800 text-gray-300 hover:text-white dark:text-gray-300 dark:hover:text-white light:text-white light:hover:text-white border border-gray-600/30 hover:border-gray-500/50 dark:border-gray-600/30 dark:hover:border-gray-500/50 light:border-gray-700 light:hover:border-gray-600">
                    <i class="fas fa-times mr-2 text-gray-300 hover:text-white dark:text-gray-300 dark:hover:text-white light:text-white light:hover:text-white"></i>Cancel
                </button>
                <button id="confirm-clear-system-prompt" class="flex-1 py-2.5 px-4 rounded-lg transition-all duration-300 bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 dark:from-red-700 dark:to-red-600 dark:hover:from-red-600 dark:hover:to-red-500 light:from-red-600 light:to-red-500 light:hover:from-red-500 light:hover:to-red-400 text-white shadow-lg hover:shadow-red-500/20 transform hover:-translate-y-0.5">
                    <i class="fas fa-trash-alt mr-2"></i>Clear Prompt
                </button>
            </div>
        </div>
    </div>

    <!-- Character Continuation Modal -->
    <div id="character-continuation-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden modal-container z-50" aria-labelledby="character-continuation-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] p-6 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-blue-900/30 overflow-hidden animate-modal-in">
            <div class="flex justify-between items-center mb-4">
                <h2 id="character-continuation-title" class="text-xl font-bold flex items-center modal-title">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-10 h-10 text-blue-400">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <span>Continue with Character?</span>
                </h2>
                <button id="close-character-continuation-modal" class="text-gray-400 hover:text-white focus:outline-none transition-colors duration-300 hover:bg-gray-700/50 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <div id="character-continuation-info" class="flex items-center mb-4 bg-blue-900/20 p-3 rounded-lg border border-blue-800/30">
                    <div id="character-continuation-avatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center mr-3 overflow-hidden">
                        <!-- Character image will be inserted here dynamically -->
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div class="flex-1">
                        <div id="character-continuation-name" class="font-semibold text-lg"></div>
                        <div id="character-continuation-description" class="text-sm text-gray-300 line-clamp-2"></div>
                    </div>
                </div>
                <p class="text-gray-300">Would you like to continue using this character in your new chat?</p>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="new-chat-without-character" class="flex-1 rounded-lg px-4 py-3 focus:outline-none transition-all duration-300 ease-in-out text-center" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    <i class="fas fa-times-circle mr-2"></i>New Chat
                </button>
                <button id="continue-with-character-btn" class="flex-1 bg-blue-600 text-white rounded-lg px-4 py-3 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out text-center">
                    <i class="fas fa-check-circle mr-2"></i>Continue with Character
                </button>
            </div>
        </div>
    </div>

    <!-- Help modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal-container" aria-labelledby="help-title" role="dialog" aria-modal="true">
        <div class="p-0 rounded-lg w-[800px] max-w-[95%] max-h-[90vh] shadow-lg overflow-hidden flex flex-col modal-content" style="background: var(--modal-bg);">
            <div class="p-6 pb-4 border-b border-gray-700 sticky top-0 z-10 flex justify-between" style="background: var(--modal-bg);">
                <h2 id="help-title" class="text-2xl font-bold flex items-center modal-title">
                    <i class="fas fa-question-circle mr-2 text-blue-500"></i>LMSA Help
                </h2>
                <div class="flex items-center h-9">
                    <button id="close-help" class="group w-9 h-9 flex items-center justify-center transition-colors duration-300 focus:outline-none">
                        <i class="fas fa-times text-lg group-hover:rotate-90 transition-transform duration-300" style="color: var(--modal-text);"></i>
                    </button>
                </div>
            </div>
            <div class="overflow-y-auto flex-grow p-6 pt-4" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain; background: var(--modal-bg);">
                <div class="space-y-6">
                    <div class="space-y-4">
                        <section>
                            <h3 class="text-lg font-semibold mb-2 text-blue-400">Quick Start</h3>
                            <ul class="list-disc pl-5 space-y-1" style="color: var(--text-primary);">
                                <li>Load model in LM Studio & start server</li>
                                <li>Enter server URL in <a href="#" id="open-settings-link" class="text-blue-400 hover:text-blue-300">Settings</a> (IP:Port)</li>
                                <li>Switch models directly in the app using the <i class="fas fa-robot text-blue-400"></i> button in the sidebar's Options menu</li>
                                <li>Start chatting!</li>
                            </ul>
                            <div class="mt-2 p-3 rounded-lg border" style="background: var(--settings-label-bg); border-color: var(--button-primary-bg);">
                                <p class="font-medium" style="color: var(--button-primary-bg);">IMPORTANT:</p>
                                <p style="color: var(--text-primary);">Enable "CORS" and "Serve on local network" in LM Studio after starting your server. Make sure your device is on the same Wi-Fi as the server computer.</p>
                            </div>

                            <div class="mt-4 p-3 rounded-lg border" style="background: var(--settings-label-bg); border-color: var(--info-color);">
                                <p class="font-medium flex items-center" style="color: var(--info-color);"><i class="fas fa-info-circle mr-2"></i>Model Switching:</p>
                                <p style="color: var(--text-primary);">You can switch between different models directly in the app:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                    <li>Open the sidebar and tap <strong>Options</strong></li>
                                    <li>Tap the <i class="fas fa-robot text-blue-400"></i> <strong>Models</strong> button</li>
                                    <li>Browse available models on your LM Studio server</li>
                                    <li>Tap <strong>Load</strong> next to your desired model</li>
                                    <li>The app will automatically eject the current model and load the new one</li>
                                </ul>
                            </div>
                        </section>
                        <section>
                            <h3 class="text-lg font-semibold mb-2 text-blue-400">Security & Privacy Notice</h3>
                            <div class="p-3 rounded-lg border" style="background: var(--settings-label-bg); border-color: var(--border-color);">
                                <p style="color: var(--text-primary);">For your privacy and security, all chat messages are stored locally on your device. We do not store any of your conversations on external servers. Please note that:</p>
                                <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                    <li>Uninstalling the app will permanently delete all saved chats</li>
                                    <li>Clearing app storage in device settings will erase all chat history</li>
                                    <li>These actions cannot be undone as data is stored only on your device</li>
                                </ul>
                                <div class="mt-3 p-2 rounded border" style="background: var(--settings-label-bg); border-color: var(--button-primary-bg);">
                                    <p style="color: var(--button-primary-bg);"><i class="fas fa-file-export mr-2"></i>Chat Export/Import Feature:</p>
                                    <p style="color: var(--text-primary); margin-bottom: 0.5rem;">You can now backup and restore your conversations using the Export and Import features in the sidebar menu.</p>
                                    <div class="p-2 rounded border mb-2" style="background: var(--settings-label-bg); border-color: var(--button-danger-bg);">
                                        <p class="font-medium" style="color: var(--button-danger-bg);"><i class="fas fa-exclamation-triangle mr-2"></i>Security Warning:</p>
                                        <p style="color: var(--text-primary);">Exported chat files are stored as unencrypted JSON files. Anyone with access to your device or the exported file can read your conversations in plain text, even without using LMSA.</p>
                                    </div>
                                    <ul class="list-disc pl-5 mt-2 space-y-1" style="color: var(--text-primary);">
                                        <li>Use <strong>Export Chats</strong> to save all your conversations to a file</li>
                                        <li>Use <strong>Import Chats</strong> to restore previously exported conversations</li>
                                        <li>You can choose to merge imported chats with existing ones or replace them entirely</li>
                                        <li>Store exported files securely to protect your privacy</li>
                                    </ul>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
            <!-- Add margin to create space between scroll container and spacer -->
            <div class="h-4"></div>
            <!-- Static Spacer Divider -->
            <div class="px-6 py-2 flex justify-center" style="background: var(--modal-bg);">
                <div class="w-full max-w-md flex items-center justify-center">
                    <div class="h-[1px] flex-grow bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-60"></div>
                    <div class="mx-4">
                        <div class="w-2 h-2 rounded-full bg-blue-500 opacity-80"></div>
                    </div>
                    <div class="h-[1px] flex-grow bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-60"></div>
                </div>
            </div>
            <!-- Add margin to create space between spacer and buttons -->
            <div class="h-4"></div>
            <div class="p-6 pt-0 space-y-4 sticky bottom-0 z-10" style="background: var(--modal-bg);">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Watch Tutorial Video Button - Refined professional video player design without progress bar -->
                    <button id="tutorial-video-btn" class="group relative flex-1 flex items-center justify-center text-white px-6 py-3.5 transition-all duration-300 ease-in-out overflow-hidden rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <!-- Professional gradient background -->
                        <div class="absolute inset-0 bg-gradient-to-r from-red-700 via-red-600 to-red-700">
                            <!-- Subtle pattern overlay -->
                            <div class="absolute inset-0 opacity-8 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cGF0aCBkPSJNMCAwaDcwdjcwSDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMCAwaDM1djM1SDBWMHoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMiIvPjxwYXRoIGQ9Ik0zNSAzNWgzNXYzNUgzNVYzNXoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMiIvPjwvc3ZnPg==')}"></div>
                        </div>
                        <!-- Professional play icon container -->
                        <div class="absolute left-4 top-1/2 transform -translate-y-1/2 w-8 h-8 rounded-full bg-white bg-opacity-20 flex items-center justify-center group-hover:bg-opacity-30 transition-all duration-300">
                            <div class="w-0 h-0 border-t-[6px] border-t-transparent border-l-[10px] border-l-white border-b-[6px] border-b-transparent group-hover:scale-110 transition-transform ml-0.5"></div>
                        </div>
                        <!-- Button content -->
                        <span class="relative flex items-center justify-center z-10 pl-6">
                            <i class="fab fa-youtube mr-2.5 text-lg text-white group-hover:text-red-200 transition-colors duration-300"></i>
                            <span class="font-medium tracking-wide">Watch Tutorial Video</span>
                        </span>
                        <!-- Enhanced hover state -->
                        <div class="absolute inset-x-0 bottom-0 h-0.5 bg-red-300 opacity-0 group-hover:opacity-90 transition-opacity duration-300"></div>
                    </button>

                    <!-- Support Articles Button - Refined professional document design -->
                    <button id="support-articles-btn" class="group relative flex-1 flex items-center justify-center text-white px-6 py-3.5 transition-all duration-300 ease-in-out overflow-hidden rounded-xl shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50">
                        <!-- Professional gradient background -->
                        <div class="absolute inset-0 bg-gradient-to-r from-emerald-700 via-emerald-600 to-emerald-700">
                            <!-- Subtle pattern overlay -->
                            <div class="absolute inset-0 opacity-8 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSI3MCIgdmlld0JveD0iMCAwIDcwIDcwIj48cGF0aCBkPSJNMCAwaDcwdjcwSDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMCAwaDM1djM1SDBWMHoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMiIvPjxwYXRoIGQ9Ik0zNSAzNWgzNXYzNUgzNVYzNXoiIGZpbGw9IiNmZmYiIGZpbGwtb3BhY2l0eT0iMC4wMiIvPjwvc3ZnPg==')}"></div>
                        </div>
                        <!-- Refined document elements -->
                        <div class="absolute left-0 top-0 bottom-0 w-0.5 bg-emerald-300 opacity-80"></div>
                        <div class="absolute top-0 left-0 w-2 h-full bg-gradient-to-b from-emerald-500/20 via-emerald-500/10 to-emerald-500/20"></div>
                        <!-- Document styling simplified to match tutorial button height -->
                        <!-- Button content -->
                        <span class="relative flex items-center justify-center z-10">
                            <i class="fas fa-book mr-2.5 text-lg text-white group-hover:text-emerald-200 transition-colors duration-300"></i>
                            <span class="font-medium tracking-wide">Support Articles</span>
                        </span>
                        <!-- Enhanced hover state -->
                        <div class="absolute inset-x-0 bottom-0 h-0.5 bg-emerald-300 opacity-0 group-hover:opacity-90 transition-opacity duration-300"></div>
                    </button>
                </div>


                <div class="text-center mt-4">
                    <a href="#" id="need-more-help-link" class="transition-colors duration-200 text-sm font-medium" style="color: var(--text-primary);">Need more help?</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Support Modal -->
    <div id="contact-form-modal" class="fixed inset-0 bg-black/70 dark:bg-black/70 light:bg-gray-900/50 backdrop-blur-sm flex items-center justify-center hidden modal-container animate-fade-in" aria-labelledby="contact-form-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] dark:from-[#0a192f] dark:to-[#0d1f3d] light:from-[#f8fafc] light:to-[#f1f5f9] p-6 rounded-xl w-full max-w-lg mx-auto max-h-[90vh] shadow-2xl overflow-y-auto modal-content animate-modal-in" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain;">
            <div class="flex justify-between items-center mb-6 border-b border-gray-700/60 dark:border-gray-700/60 light:border-gray-200 pb-4 sticky top-0 bg-gradient-to-b from-[#0a192f] to-[#0a192f] dark:from-[#0a192f] dark:to-[#0a192f] light:from-[#f8fafc] light:to-[#f8fafc] z-10">
                <h2 id="contact-form-title" class="text-2xl font-bold flex items-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400">
                    <div class="mr-3 p-2 bg-blue-500/10 dark:bg-blue-500/10 light:bg-blue-500/20 rounded-full flex items-center justify-center animate-pulse-subtle">
                        <i class="fas fa-envelope text-blue-400"></i>
                    </div>
                    Contact Support
                </h2>
                <button id="close-contact-form" class="text-gray-400 dark:hover:text-white light:hover:text-gray-800 focus:outline-none transition-all duration-300 dark:hover:bg-gray-700/50 light:hover:bg-gray-200/50 rounded-full w-9 h-9 flex items-center justify-center group">
                    <i class="fas fa-times transform group-hover:rotate-90 transition-transform duration-300"></i>
                </button>
            </div>

            <!-- Email Support Content -->
            <div class="contact-support-container bg-darkBg/30 dark:bg-darkBg/30 light:bg-gray-100/70 p-6 rounded-lg shadow-inner border border-white/5 dark:border-white/5 light:border-gray-200">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500/20 to-teal-500/20 rounded-full mb-4">
                        <i class="fas fa-headset text-2xl text-blue-400"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-200 dark:text-gray-200 light:text-gray-800 mb-2">Get Technical Support</h3>
                    <p class="text-sm text-gray-400 dark:text-gray-400 light:text-gray-600 leading-relaxed">
                        Click the button below to open your email app with a pre-filled support request. This helps us assist you more efficiently.
                    </p>
                </div>

                <!-- Email Button -->
                <div class="mb-6">
                    <button id="open-email-support"
                        class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600
                        text-white font-medium py-4 px-6 rounded-lg transition-all duration-300
                        focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900
                        shadow-lg hover:shadow-blue-500/20 transform hover:-translate-y-0.5 relative overflow-hidden group">
                        <span class="relative z-10 flex items-center justify-center">
                            <i class="fas fa-external-link-alt mr-3 group-hover:animate-pulse"></i>
                            <span class="text-lg">Open Email App</span>
                        </span>
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-500 to-teal-500 opacity-0 group-hover:opacity-50 transition-opacity duration-300"></div>
                    </button>
                </div>

                <!-- Support Info -->
                <div class="bg-gradient-to-r from-blue-500/10 to-teal-500/10 rounded-lg p-4 border border-blue-500/20">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-blue-300 mb-2">What happens next?</h4>
                            <ul class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-600 space-y-1">
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Your default email app will open</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Subject and recipient will be pre-filled</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Template with helpful questions included</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-check text-green-400 mr-2 mt-0.5 text-xs"></i>
                                    <span>Our team typically responds within 24-48 hours</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alternative Contact Info -->
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-400 dark:text-gray-400 light:text-gray-600 mb-2">
                    Email app not working? You can manually email us at:
                </p>
                <a href="mailto:help@techray.on.spiceworks.com"
                   class="text-blue-400 hover:text-blue-300 text-sm font-medium transition-colors duration-200 underline decoration-dotted underline-offset-2">
                    help@techray.on.spiceworks.com
                </a>
            </div>
        </div>
    </div>

    <!-- Context menu for LLM-generated text -->
    <div id="context-menu" class="hidden fixed bg-darkSecondary border border-gray-600 rounded-lg shadow-lg z-50">
        <button id="copy-text" class="w-full text-left px-4 py-2 hover:bg-darkTertiary focus:outline-none">
            <i class="fas fa-copy mr-2"></i>Copy
        </button>
        <button id="regenerate-text" class="w-full text-left px-4 py-2 hover:bg-darkTertiary focus:outline-none">
            <i class="fas fa-redo mr-2"></i>Regenerate
        </button>
    </div>

    <!-- Context menu for Send button -->
    <div id="send-context-menu" class="hidden fixed bg-darkSecondary border border-gray-600 rounded-lg shadow-lg z-50">
        <div class="menu-header text-xs">Quick Actions</div>
        <button id="new-topic-menu-button" class="w-full text-left focus:outline-none flex items-center">
            <div class="icon-container text-white p-1.5 rounded-full flex items-center justify-center">
                <i class="fas fa-plus-circle text-sm"></i>
            </div>
            <span class="font-medium ml-3">New Topic</span>
        </button>
        <button id="scroll-to-bottom-menu-button" class="w-full text-left focus:outline-none flex items-center">
            <div class="icon-container text-white p-1.5 rounded-full flex items-center justify-center">
                <i class="fas fa-arrow-down text-sm"></i>
            </div>
            <span class="font-medium ml-3">Scroll to Bottom</span>
        </button>
    </div>


    
    <!-- About modal -->
    <div id="about-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden modal-container z-50" aria-labelledby="about-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#0a192f] to-[#0d1f3d] p-0 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-white/10 overflow-hidden animate-modal-in" style="-webkit-overflow-scrolling: touch; touch-action: auto; overscroll-behavior: contain;">
            <!-- Header with app icon and title -->
            <div class="relative p-6 pb-4 bg-gradient-to-r from-[#0c1d36] to-[#102240]">
                <div class="flex items-center justify-center mb-2">
                    <img src="icon.png" alt="LMSA Icon" class="w-16 h-16 mb-1 filter drop-shadow-lg animate-pulse-subtle">
                </div>
                <h2 id="about-title" class="text-2xl font-bold text-center flex items-center justify-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-400 mb-1">
                    LMSA
                </h2>
                <button id="close-about" class="absolute right-3 top-3 text-gray-400 hover:text-white focus:outline-none transition-all duration-300 hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
                <div class="version-badge bg-white/10 px-4 py-1.5 rounded-full mx-auto w-fit mt-2">
                    <p class="text-sm font-medium text-blue-300">Version 5.0</p>
                </div>
            </div>

            <!-- Main content with subtle divider -->
            <div class="p-6 pt-4">
                <div class="h-px w-full bg-gradient-to-r from-transparent via-white/20 to-transparent mb-5"></div>

                <!-- Company info with subtle animation -->
                <div class="flex flex-col items-center justify-center mb-6">
                    <p class="text-center text-gray-300 mb-4 flex items-center">
                        <i class="fas fa-copyright text-blue-400 mr-2 opacity-75"></i>
                        <span>2025 TechRay Apps LLC</span>
                    </p>

                    <!-- Links section with improved styling -->
                    <div class="space-y-3 w-full">
                        <a href="#" id="official-website-link" class="inline-flex items-center justify-center w-full bg-gradient-to-r from-blue-600 to-teal-500 hover:from-blue-700 hover:to-teal-600 text-white px-4 py-2.5 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-[1.02] shadow-lg hover:shadow-blue-500/30 text-sm font-medium group">
                            <i class="fas fa-globe text-blue-200 mr-2.5 group-hover:animate-spin-slow"></i>
                            <span>Visit Official Website</span>
                            <i class="fas fa-external-link-alt text-xs ml-2 opacity-75"></i>
                        </a>

                        <a href="#" id="rate-app-link" class="inline-flex items-center justify-center w-full bg-gradient-to-r from-orange-600 to-amber-500 hover:from-orange-700 hover:to-amber-600 text-white px-4 py-2.5 rounded-lg transition-all duration-300 ease-in-out transform hover:scale-[1.02] shadow-lg hover:shadow-orange-500/30 text-sm font-medium group">
                            <i class="fas fa-star text-yellow-300 mr-2.5 group-hover:animate-wobble"></i>
                            <span>Rate us on Google Play</span>
                            <i class="fab fa-google-play ml-2.5"></i>
                        </a>
                    </div>

                    <!-- Help link with improved styling -->
                    <div class="mt-5 pt-4 border-t border-white/10 w-full">
                        <p class="text-center text-gray-400 flex items-center justify-center">
                            <i class="fas fa-question-circle text-blue-400 mr-2"></i>
                            Need help? <a href="#" id="open-help-link" class="text-blue-400 hover:text-blue-300 font-medium transition-colors duration-200 ml-1.5 underline decoration-dotted underline-offset-2">Open Help Menu</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import modal -->
    <div id="import-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal-container" aria-labelledby="import-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="import-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-file-import mr-2 text-blue-500"></i>Import Chats
            </h2>
            <div class="mb-4">
                <p class="mb-4" style="color: var(--text-primary);">How would you like to import the chats?</p>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="import-option" value="merge" checked class="text-blue-600 focus:ring-blue-500">
                        <span style="color: var(--text-primary);">Merge with existing chats</span>
                    </label>
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="radio" name="import-option" value="replace" class="text-blue-600 focus:ring-blue-500">
                        <span style="color: var(--text-primary);">Replace all existing chats</span>
                    </label>
                </div>
            </div>
            <div id="import-status" class="mb-4 hidden">
                <div class="p-3 bg-blue-900 bg-opacity-30 rounded-lg border border-blue-700">
                    <p id="import-status-message" class="text-blue-300"></p>
                </div>
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-import" class="rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-import" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Import Success modal -->
    <div id="import-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal-container" aria-labelledby="import-success-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="import-success-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>Import Successful
            </h2>
            <div class="mb-6">
                <p id="import-success-message" class="text-center text-lg" style="color: var(--text-primary);">Successfully imported chats.</p>
            </div>
            <div class="flex justify-center">
                <button id="close-import-success" class="bg-blue-600 text-white rounded-lg px-6 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Export Confirmation modal -->
    <div id="export-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal-container" aria-labelledby="export-confirmation-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="export-confirmation-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-file-export mr-2 text-blue-500"></i>Confirm Export
            </h2>
            <p id="export-confirmation-message" class="mb-4">Are you sure you want to export all your chat history? The exported file will contain all your conversations in unencrypted format.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-export" class="rounded-lg px-4 py-2 focus:outline-none transition-all duration-300 ease-in-out" style="background-color: var(--bg-tertiary); color: var(--text-primary);">
                    Cancel
                </button>
                <button id="confirm-export" class="bg-blue-600 text-white rounded-lg px-4 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Export Success modal -->
    <div id="export-success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden modal-container" aria-labelledby="export-success-title" role="dialog" aria-modal="true">
        <div class="p-6 rounded-lg w-96 max-w-[90%] shadow-lg modal-content" style="background-color: var(--bg-secondary); color: var(--text-primary);">
            <h2 id="export-success-title" class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>Export Successful
            </h2>
            <div class="mb-6">
                <p id="export-success-message" class="text-center text-lg" style="color: var(--text-primary);">Successfully exported chats.</p>
            </div>
            <div class="flex justify-center">
                <button id="close-export-success" class="bg-blue-600 text-white rounded-lg px-6 py-2 hover:bg-blue-700 focus:outline-none transition-all duration-300 ease-in-out">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden file input for importing chats -->
    <input type="file" id="import-chats-input" accept=".json" class="hidden">

    <!-- Model modal -->
    <div id="model-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center hidden modal-container" aria-labelledby="model-title" role="dialog" aria-modal="true">
        <div class="dark:bg-gradient-to-b dark:from-[#0a192f]/95 dark:via-[#0c1e36]/95 dark:to-[#0a192f]/95 light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-6 rounded-xl w-[800px] max-w-[95%] max-h-[90vh] shadow-2xl overflow-hidden flex flex-col modal-content border border-white/10 dark:border-white/10 light:border-gray-200">
            <div class="flex justify-between items-center mb-5 pb-2 border-b border-white/10 dark:border-white/10 light:border-gray-200/60">
                <h2 id="model-title" class="text-xl font-bold flex items-center modal-title">
                    <div id="model-header-icon" class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-9 h-9 text-blue-400 shadow-lg transition-all duration-300">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-blue-400 font-extrabold">Model Information</span>
                    </div>
                </h2>
                <button id="close-model" class="text-gray-400 hover:text-white focus:outline-none transition-all duration-300 rounded-full w-8 h-8 flex items-center justify-center hover:rotate-90 transform">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto pr-4 flex-grow">
                <!-- Instructions for mobile users -->
                <div id="mobile-instructions" class="mb-4 p-4 bg-gradient-to-r from-blue-500/10 to-indigo-500/10 rounded-xl border border-blue-500/20 shadow-sm hidden">
                    <div class="flex items-start">
                        <div class="icon-wrapper mr-3 flex-shrink-0 flex items-center justify-center rounded-full bg-blue-500/20 w-8 h-8 text-blue-400 shadow-sm">
                            <i class="fas fa-info-circle text-sm"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-semibold text-blue-400 dark:text-blue-400 light:text-blue-600 mb-1">
                                <i class="fas fa-robot mr-1"></i>Model Information
                            </h4>
                            <p class="text-xs text-gray-300 dark:text-gray-300 light:text-gray-600 leading-relaxed">
                                Model names now wrap to multiple lines for better readability. Tap the model name itself to view the complete model name in a popup.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="mb-6 p-5 bg-darkTertiary/30 rounded-xl border border-blue-500/30 dark:border-blue-500/30 light:border-blue-400/30 shadow-md">
                    <h3 class="text-lg font-semibold mb-2 text-blue-400 dark:text-blue-400 light:text-blue-600 flex items-center">
                        <i class="fas fa-check-circle mr-2"></i>Currently Loaded Model
                    </h3>
                    <div id="current-model" class="text-lg font-medium text-white dark:text-white light:text-gray-800 p-4 bg-darkBg/70 dark:bg-darkBg/70 light:bg-white/80 rounded-lg overflow-hidden text-ellipsis border border-white/5 shadow-inner">Loading...</div>
                </div>

                <div>
                    <div id="available-models-list" class="space-y-3">
                        <div class="animate-pulse flex space-x-4">
                            <div class="flex-1 space-y-3 py-1">
                                <div class="h-4 bg-darkTertiary/50 rounded-full w-3/4"></div>
                                <div class="h-4 bg-darkTertiary/50 rounded-full w-1/2"></div>
                                <div class="h-4 bg-darkTertiary/50 rounded-full w-5/6"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Model Name modal -->
    <div id="full-model-name-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center hidden modal-container" aria-labelledby="full-model-name-title" role="dialog" aria-modal="true">
        <div class="dark:bg-gradient-to-b dark:from-[#0a192f]/95 dark:via-[#0c1e36]/95 dark:to-[#0a192f]/95 light:bg-gradient-to-b light:from-[#f8fafc] light:via-[#f1f5f9] light:to-[#f8fafc] p-6 rounded-xl max-w-[95%] max-h-[90vh] shadow-2xl overflow-hidden flex flex-col modal-content border border-white/10 dark:border-white/10 light:border-gray-200">
            <div class="flex justify-between items-center mb-5 pb-2 border-b border-white/10 dark:border-white/10 light:border-gray-200/60">
                <h2 id="full-model-name-title" class="text-xl font-bold flex items-center modal-title">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-9 h-9 text-blue-400 shadow-lg">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-blue-400 font-extrabold">Model Name</span>
                    </div>
                </h2>
                <button id="close-full-model-name" class="text-gray-400 hover:text-white focus:outline-none transition-all duration-300 rounded-full w-8 h-8 flex items-center justify-center hover:rotate-90 transform">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto pr-4">
                <div class="p-5 bg-darkTertiary/30 rounded-xl border border-blue-500/30 dark:border-blue-500/30 light:border-blue-400/30 shadow-md">
                    <div id="full-model-name" class="text-lg font-medium text-white dark:text-white light:text-gray-800 p-4 bg-darkBg/70 dark:bg-darkBg/70 light:bg-white/80 rounded-lg border border-white/5 shadow-inner break-all"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- What's New modal -->
    <div id="whats-new-modal" class="fixed inset-0 bg-black/85 backdrop-blur-md flex items-center justify-center hidden modal-container" aria-labelledby="whats-new-title" role="dialog" aria-modal="true" style="padding: 1.5rem;">
        <div class="bg-gradient-to-b from-[#0a192f]/95 via-[#0c1e36]/95 to-[#0a192f]/95 p-4 rounded-2xl shadow-2xl modal-content flex flex-col border border-white/10 overflow-hidden" style="box-shadow: 0 20px 60px -15px rgba(0,0,0,0.7), 0 0 30px rgba(31, 66, 135, 0.2), 0 0 0 1px rgba(255,255,255,0.1) inset;">
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-white/15">
                <h2 id="whats-new-title" class="text-xl font-bold flex items-center">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-gradient-to-br from-yellow-400 to-orange-500 w-9 h-9 text-darkBg shadow-lg animate-pulse-subtle">
                        <i class="fas fa-wand-magic-sparkles text-sm"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="text-blue-400 font-extrabold">What's New</span>
                        <span class="text-xs text-blue-300/80 font-medium">v<span id="whats-new-version">5.0</span></span>
                    </div>
                </h2>
                <button id="close-whats-new" class="text-gray-400 hover:text-white focus:outline-none transition-all duration-300 rounded-full w-8 h-8 flex items-center justify-center hover:rotate-90 transform">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="features-container overflow-y-auto flex-grow px-1 py-2">
                <div class="space-y-3">
                    <div class="feature-item">
                        <div class="relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-24 h-24 -mt-8 -mr-8 bg-gradient-to-br from-blue-500/10 to-blue-700/5 rounded-full blur-xl"></div>
                            <div class="flex items-start relative z-10">
                                <div class="feature-icon-wrapper mr-3 flex items-center justify-center rounded-full bg-blue-500/20 w-10 h-10 shadow-sm">
                                    <i class="fas fa-heart text-blue-400"></i>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center">
                                        <h3 class="feature-title whitespace-nowrap">LMSA is Now Free!</h3>
                                    </div>
                                    <div class="feature-description">
                                        <p class="mb-4"><strong>Dear LMSA Users,</strong></p>
                                        <p class="mb-3">We're excited to announce that LMSA, your front end for LM Studio, is now completely free for everyone.</p>
                                        <p class="mb-3">To keep LMSA accessible and to support ongoing development, we've introduced ads into the app. This change allows us to continue improving LMSA and providing new features, while making sure it remains free to use.</p>
                                        <p class="mb-3"><strong>Important:</strong> Being ad-supported does not mean we track you. Your chats will continue to be completely private and will never be monitored or sent to any server. Your privacy remains our top priority.</p>
                                        <p class="mb-3">Thank you for your understanding and continued support.</p>
                                        <p><strong>The LMSA Team</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="relative">
                <!-- Decorative divider with glow effect -->
                <div class="absolute left-0 right-0 top-0 h-px bg-gradient-to-r from-transparent via-blue-500/50 to-transparent"></div>
                <div class="absolute left-0 right-0 top-0 h-px bg-gradient-to-r from-transparent via-blue-500/20 to-transparent blur-sm"></div>

                <!-- Footer content -->
                <div class="flex justify-between items-center pt-3 pb-2 mt-auto bg-gradient-to-b from-[#0a192f]/95 to-[#0c1e36]/95 sticky bottom-0 px-2">
                    <label class="flex items-center space-x-2 cursor-pointer text-sm text-gray-300 hover:text-white transition-colors duration-300 group">
                        <div class="toggle-container relative w-11 h-6 rounded-full bg-gray-700/50 border border-gray-600/50 flex items-center transition-all duration-300 group-hover:border-blue-400/30 group-hover:bg-gray-700/70">
                            <input type="checkbox" id="dont-show-again" class="sr-only">
                            <div class="toggle-switch absolute inset-0 rounded-full"></div>
                            <div class="toggle-dot absolute left-0.5 top-0.5 bg-gray-400 w-5 h-5 rounded-full transition-all duration-300 group-hover:bg-gray-300"></div>
                            <div class="toggle-dot-active absolute left-0.5 top-0.5 bg-gradient-to-r from-blue-400 to-blue-500 w-5 h-5 rounded-full opacity-0 transition-all duration-300 shadow-md"></div>
                        </div>
                        <span class="text-xs sm:text-sm">Don't show again</span>
                    </label>
                    <button id="got-it-whats-new" class="relative overflow-hidden text-white rounded-lg focus:outline-none transition-all duration-300 ease-in-out text-sm px-4 py-2" style="background: linear-gradient(135deg, #1e40af, #3b82f6); box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15); border: none; font-weight: 600; letter-spacing: 0.02em; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px -1px rgba(37, 99, 235, 0.3), 0 4px 8px -1px rgba(37, 99, 235, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.2)'; this.style.background='linear-gradient(135deg, #2563eb, #60a5fa)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -1px rgba(37, 99, 235, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.15)'; this.style.background='linear-gradient(135deg, #1e40af, #3b82f6)';">
                        <span class="relative z-10 flex items-center">
                            <i class="fas fa-check-circle mr-2"></i>
                            <span>Got it!</span>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Modal -->
    <div id="character-modal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center hidden modal-container" aria-labelledby="character-title" role="dialog" aria-modal="true">
        <div class="character-modal">
            <div class="character-modal-header">
                <h2 id="character-title" class="character-modal-title">Create Character</h2>
                <button id="close-character" class="character-modal-close" aria-label="Close character modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="character-modal-body">
                <form id="character-form">
                    <div class="flex flex-col lg:flex-row gap-5">
                        <!-- Left column - Basic info -->
                        <div class="flex-1">
                            <div class="character-form-group">
                                <label for="character-name" class="character-form-label">Character Name <span class="text-red-500">*</span></label>
                                <input type="text" id="character-name" class="character-form-input" placeholder="Enter character name" required>
                            </div>

                            <div class="character-form-group">
                                <label for="character-description" class="character-form-label">Character Description</label>
                                <textarea id="character-description" class="character-form-input character-form-textarea" placeholder="Brief description of your character"></textarea>
                                <div class="text-xs text-gray-400 mt-1">Describe what makes this character unique</div>
                            </div>
                        </div>

                        <!-- Right column - Image -->
                        <div class="w-full lg:w-1/3 flex flex-col">
                            <div class="character-form-group">
                                <label class="character-form-label">Character Image</label>
                                <div class="character-image-container flex flex-col items-center justify-center bg-black/20 rounded-xl border border-white/10 p-3 min-h-[200px]">
                                    <img id="character-preview-image" class="character-preview hidden max-w-full max-h-[200px] object-contain" alt="Character preview">
                                    <div id="character-image-placeholder" class="character-image-placeholder flex flex-col items-center justify-center w-full h-full min-h-[150px] gap-3">
                                        <i class="fas fa-user-circle text-5xl text-gray-400"></i>
                                        <p class="text-sm text-gray-400 text-center">Upload an image for your character</p>
                                    </div>
                                </div>
                                <label for="character-image-upload" class="character-upload-btn w-full justify-center mt-3">
                                    <i class="fas fa-image"></i> Upload Image
                                </label>
                                <input type="file" id="character-image-upload" class="hidden" accept="image/*">
                            </div>
                        </div>
                    </div>

                    <!-- Character Personality and Scenario -->
                    <div class="character-form-group">
                        <label for="character-personality" class="character-form-label">Character Personality</label>
                        <textarea id="character-personality" class="character-form-input character-form-textarea" placeholder="Describe personality traits, behavior patterns, and mannerisms"></textarea>
                        <div class="text-xs text-gray-400 mt-1">How does your character behave, talk, and interact with others?</div>
                    </div>

                    <div class="character-form-group">
                        <label for="character-scenario" class="character-form-label">Character Scenario</label>
                        <textarea id="character-scenario" class="character-form-input character-form-textarea" placeholder="Describe the character's background, setting, or situation"></textarea>
                        <div class="text-xs text-gray-400 mt-1">What is the character's backstory or the current situation they're in?</div>
                    </div>

                    <!-- Import Character Card -->
                    <div class="character-form-group mt-6 border-t border-white/10 pt-5">
                        <label class="character-form-label flex items-center">
                            <i class="fas fa-file-import mr-2 text-blue-400"></i>
                            Import Character Card
                        </label>
                        <div class="flex items-center gap-4">
                            <label for="character-card-upload" class="character-upload-btn flex-1">
                                <i class="fas fa-file-import"></i> Import Character Card
                            </label>
                            <input type="file" id="character-card-upload" class="hidden" accept=".json">
                        </div>
                        <p class="text-xs text-gray-400 mt-2">Upload a JSON character card file to import character data</p>
                    </div>
                </form>
            </div>
            <div class="character-modal-footer">
                <button id="delete-character" class="character-delete-btn hidden">
                    <i class="fas fa-trash-alt mr-2"></i> Delete
                </button>
                <button id="save-character" class="character-save-btn" form="character-form">
                    <i class="fas fa-save mr-2"></i> Save Character
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Character Confirmation Modal -->
    <div id="delete-character-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center hidden modal-container z-[100]" aria-labelledby="delete-character-title" role="dialog" aria-modal="true">
        <div class="bg-gradient-to-b from-[#2d0a0a] to-[#3d0d0d] p-6 rounded-xl w-[420px] max-w-[90%] shadow-2xl modal-content border border-red-900/30 overflow-hidden animate-modal-in">
            <div class="flex justify-between items-center mb-4">
                <h2 id="delete-character-title" class="text-xl font-bold flex items-center">
                    <div class="icon-wrapper mr-3 flex items-center justify-center rounded-full bg-red-500/20 w-10 h-10 text-red-400">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-red-300">Delete Character</span>
                </h2>
                <button id="close-delete-character-modal" class="text-gray-400 hover:text-white focus:outline-none transition-all duration-300 rounded-full w-8 h-8 flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-6">
                <div class="p-4 rounded-lg bg-red-900/20 border border-red-800/30 mb-4">
                    <p class="text-gray-300 mb-2">Are you sure you want to delete this character?</p>
                    <p class="text-red-300 text-sm flex items-start">
                        <i class="fas fa-exclamation-triangle mt-0.5 mr-2"></i>
                        <span>This action cannot be undone. The character will be permanently removed.</span>
                    </p>
                </div>

                <div class="character-preview-container flex items-center p-3 rounded-lg bg-black/30 border border-white/5">
                    <div id="delete-character-avatar" class="character-avatar w-12 h-12 rounded-full mr-4 flex-shrink-0 bg-gray-700 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user text-gray-400"></i>
                    </div>
                    <div>
                        <div id="delete-character-name" class="font-medium text-lg text-white"></div>
                        <div id="delete-character-description" class="text-sm text-gray-400"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between space-x-4">
                <button id="cancel-delete-character" class="flex-1 py-2.5 px-4 rounded-lg transition-all duration-300 bg-gray-700/50 hover:bg-gray-700 text-gray-300 hover:text-white border border-gray-600/30 hover:border-gray-500/50">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="confirm-delete-character" class="flex-1 py-2.5 px-4 rounded-lg transition-all duration-300 bg-gradient-to-r from-red-700 to-red-600 hover:from-red-600 hover:to-red-500 text-white shadow-lg hover:shadow-red-500/20 transform hover:-translate-y-0.5">
                    <i class="fas fa-trash-alt mr-2"></i>Delete Character
                </button>
            </div>
        </div>
    </div>

    <!-- Character Gallery Container -->
    <div id="character-gallery-container" class="character-gallery-container">
        <div class="character-gallery-header">
            <div class="character-gallery-title">
                <i class="fas fa-user-circle"></i>
                Character Gallery
            </div>
            <div class="character-gallery-actions">
                <button id="character-gallery-create-btn" class="character-gallery-create-btn">
                    <i class="fas fa-plus"></i>
                    Create Character
                </button>
                <button id="character-gallery-import-btn" class="character-gallery-import-btn">
                    <i class="fas fa-file-import"></i>
                    Import Character
                </button>
                <button id="character-gallery-back-btn" class="character-gallery-back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
            </div>
            <input type="file" id="character-gallery-import-input" class="hidden" accept=".json">
        </div>
        <div class="character-gallery-content">
            <div id="character-gallery-empty" class="character-gallery-empty">
                <div class="character-gallery-empty-container">
                    <div class="character-gallery-empty-icon-container">
                        <i class="fas fa-user-slash"></i>
                    </div>
                    <p>No characters created</p>
                    <p class="character-gallery-empty-description">Create your first AI character to start personalized conversations</p>
                    <button id="character-gallery-empty-create-btn" class="modern-button-primary">
                        <i class="fas fa-plus"></i>
                        Create a Character
                    </button>
                </div>
            </div>
            <div id="character-gallery-grid" class="character-gallery-grid">
                <!-- Character cards will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Main application script with module imports -->
    <script type="module" src="app.js"></script>
    <script type="module" src="about.js"></script>
    <script type="module" src="help.js"></script>
    <script type="module" src="empty-message-modal.js"></script>
    <script type="module" src="delete-all-chats.js"></script>
    <script type="module" src="confirmation-modal-fix.js"></script>
    <script type="module" src="character-continuation-modal.js"></script>
    <script type="module" src="external-site-confirmation-modal.js"></script>
    <script type="module" src="js/character-gallery.js"></script>
    <!-- Removed custom marked.js loader as we're loading it earlier -->

    <script>
        // Add preview mode toggle functionality
        document.addEventListener('DOMContentLoaded', function() {

            const previewToggle = document.getElementById('preview-toggle');

            // We'll control button visibility through the updateViewMode function
            // No need to hide it here by default

            // Function to detect if device is a tablet
            function isTablet() {
                // Enhanced tablet detection that handles edge cases better
                // Lowered threshold to 601px to match CSS breakpoint and handle more tablet sizes

                // First check for explicit tablet indicators in user agent
                const isExplicitTablet = /iPad|Tablet/i.test(navigator.userAgent);

                // Check screen dimensions - use 601px to match CSS breakpoint
                // This ensures consistency between CSS and JS logic
                const hasTabletDimensions = window.innerWidth >= 601;

                // Additional check for common tablet aspect ratios and sizes
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const aspectRatio = Math.max(screenWidth, screenHeight) / Math.min(screenWidth, screenHeight);
                
                // Common tablet sizes that might fall in edge cases
                const isCommonTabletSize = (
                    (screenWidth >= 768 && screenWidth <= 1024) || // Standard tablet range
                    (screenWidth >= 600 && screenWidth <= 900 && aspectRatio <= 1.8) || // Wider tablets
                    (screenWidth >= 820 && screenWidth <= 834) // iPad Air/Pro sizes
                );

                // For testing purposes - force tablet mode when URL has ?tablet=true
                const forceTablet = window.location.search.includes('tablet=true');

                // Consider it a tablet if:
                // 1. It's explicitly a tablet, OR
                // 2. It has tablet-like dimensions, OR
                // 3. It matches common tablet sizes, OR
                // 4. Testing mode is enabled
                return isExplicitTablet || hasTabletDimensions || isCommonTabletSize || forceTablet;
            }

            // Function to update view mode based on device and user preference
            function updateViewMode() {
                const userPreference = localStorage.getItem('previewMode');
                const isTabletDevice = isTablet();
                const viewModeIndicator = document.getElementById('view-mode-indicator');

                // Clear any existing class first
                document.body.classList.remove('preview-mode');

                // If user has a saved preference, use that
                if (userPreference === 'true') {
                    // User wants mobile view
                    document.body.classList.add('preview-mode');
                } else if (userPreference === 'false') {
                    // User explicitly wants tablet view
                    // Do nothing, preview-mode is already removed
                } else {
                    // No saved preference - use defaults based on device
                    if (!isTabletDevice) {
                        // For phones - default to mobile view
                        document.body.classList.add('preview-mode');
                    }
                    // For tablets - default to tablet view (no preview-mode class)
                }

                // Control visibility of the preview toggle button
                if (previewToggle) {
                    if (isTabletDevice) {
                        // Show the button only on tablets - use multiple methods to ensure visibility
                        previewToggle.classList.remove('hidden');
                        previewToggle.classList.add('block');
                        previewToggle.style.display = 'block'; // Ensure it's visible with inline style
                        previewToggle.style.visibility = 'visible';
                        previewToggle.style.opacity = '1';

                        // Force the button to be visible by removing any CSS that might hide it
                        setTimeout(() => {
                            // Double-check visibility after a short delay
                            if (previewToggle.offsetParent === null) {
                                // Element is still not visible, try more aggressive approach
                                previewToggle.setAttribute('style', 'display: block !important; visibility: visible !important; opacity: 1 !important;');
                                console.log('Applied emergency visibility fix to tablet view button');
                            }
                        }, 100);

                        // Update the view mode indicator
                        if (viewModeIndicator) {
                            if (document.body.classList.contains('preview-mode')) {
                                // Mobile view - show indicator
                                viewModeIndicator.classList.remove('hidden');
                                previewToggle.setAttribute('title', 'Currently in mobile view - click to switch to tablet view');
                            } else {
                                // Tablet view - hide indicator
                                viewModeIndicator.classList.add('hidden');
                                previewToggle.setAttribute('title', 'Currently in tablet view - click to switch to mobile view');
                            }
                        }
                    } else {
                        // Hide the button on non-tablet devices
                        previewToggle.classList.remove('block');
                        previewToggle.classList.add('hidden');
                        previewToggle.style.display = 'none';
                        previewToggle.style.visibility = 'hidden';
                    }
                }
            }

            // Set up the preview toggle button
            if (previewToggle) {
                previewToggle.addEventListener('click', function() {
                    document.body.classList.toggle('preview-mode');
                    const viewModeIndicator = document.getElementById('view-mode-indicator');

                    // Store preference in localStorage
                    if (document.body.classList.contains('preview-mode')) {
                        localStorage.setItem('previewMode', 'true');
                        if (viewModeIndicator) {
                            viewModeIndicator.classList.remove('hidden');
                            previewToggle.setAttribute('title', 'Currently in mobile view - click to switch to tablet view');
                        }
                    } else {
                        localStorage.setItem('previewMode', 'false');
                        if (viewModeIndicator) {
                            viewModeIndicator.classList.add('hidden');
                            previewToggle.setAttribute('title', 'Currently in tablet view - click to switch to mobile view');
                        }
                    }
                });

                // Initialize view mode
                updateViewMode();

                // Add resize event listener to handle orientation changes and window resizing
                let resizeTimeout;
                window.addEventListener('resize', function() {
                    // Debounce resize events to avoid excessive calls
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(function() {
                        console.log('Window resized, updating view mode...');
                        updateViewMode();
                    }, 250);
                });

                // Also listen for orientation change events on mobile devices
                window.addEventListener('orientationchange', function() {
                    // Small delay to ensure dimensions are updated after orientation change
                    setTimeout(function() {
                        console.log('Orientation changed, updating view mode...');
                        updateViewMode();
                    }, 300);
                });

                // Log device detection info for debugging
                const isExplicitTablet = /iPad|Tablet/i.test(navigator.userAgent);
                const hasTabletDimensions = window.innerWidth >= 601;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;
                const aspectRatio = Math.max(screenWidth, screenHeight) / Math.min(screenWidth, screenHeight);
                const isCommonTabletSize = (
                    (screenWidth >= 768 && screenWidth <= 1024) || // Standard tablet range
                    (screenWidth >= 600 && screenWidth <= 900 && aspectRatio <= 1.8) || // Wider tablets
                    (screenWidth >= 820 && screenWidth <= 834) // iPad Air/Pro sizes
                );
                const forceTablet = window.location.search.includes('tablet=true');
                const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

                // Check button visibility
                const computedStyle = window.getComputedStyle(previewToggle);
                const isButtonVisible = computedStyle.display !== 'none' && computedStyle.visibility !== 'hidden';

                console.log('TABLET VIEW DEBUGGING:', {
                    'DEVICE INFO': {
                        'isTablet (function result)': isTablet(),
                        'isExplicitTablet (UA)': isExplicitTablet,
                        'hasTabletDimensions (>= 601px)': hasTabletDimensions,
                        'isCommonTabletSize': isCommonTabletSize,
                        'forceTablet (URL param)': forceTablet,
                        'userAgent': navigator.userAgent,
                        'screenWidth': screenWidth,
                        'screenHeight': screenHeight,
                        'aspectRatio': aspectRatio.toFixed(2),
                        'hasTouch': hasTouch
                    },
                    'VIEW MODE': {
                        'currentMode': document.body.classList.contains('preview-mode') ? 'MOBILE VIEW' : 'TABLET VIEW',
                        'previewModeClass': document.body.classList.contains('preview-mode'),
                        'savedPreference': localStorage.getItem('previewMode')
                    },
                    'BUTTON STATE': {
                        'isVisible (computed)': isButtonVisible,
                        'display': computedStyle.display,
                        'visibility': computedStyle.visibility,
                        'opacity': computedStyle.opacity,
                        'position': computedStyle.position,
                        'width': computedStyle.width,
                        'height': computedStyle.height,
                        'classes': previewToggle.className,
                        'inlineStyle': previewToggle.getAttribute('style')
                    }
                });

                // Debug indicator removed as it's no longer needed
                // The green/red dot in the top right corner has been removed

                // Update view mode when window is resized
                window.addEventListener('resize', updateViewMode);
            }

            // Set up help modal content scrolling
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = helpModal ? helpModal.querySelector('.help-modal-content') : null;

            if (helpModalContent) {
                // Remove previous custom scrolling events if they exist
                const oldHelpModalContent = helpModalContent.cloneNode(true);
                helpModalContent.parentNode.replaceChild(oldHelpModalContent, helpModalContent);

                // Re-select the element after replacing
                const newHelpModalContent = helpModal.querySelector('.help-modal-content');

                // Add simple touch event listeners with passive: true to ensure smooth scrolling
                newHelpModalContent.addEventListener('touchstart', function(e) {
                    // Just let the browser handle it
                }, { passive: true });

                newHelpModalContent.addEventListener('touchmove', function(e) {
                    // Just let the browser handle it
                }, { passive: true });

                newHelpModalContent.addEventListener('touchend', function(e) {
                    // Just let the browser handle it
                }, { passive: true });
            }

            // Enable drag to scroll functionality for other modal content (excluding whats new modal)
            const scrollableElements = document.querySelectorAll('.drag-scrollable:not(#help-modal .help-modal-content):not(#whats-new-modal .modal-content):not(#whats-new-modal .features-container), .touch-scroll:not(#whats-new-modal .features-container)');

            scrollableElements.forEach(scrollable => {
                let isDown = false;
                let startY;
                let scrollTop;

                // Check if target is a form element that needs normal interaction
                function isFormElement(target) {
                    const tag = target.tagName.toLowerCase();
                    return tag === 'input' || tag === 'textarea' || tag === 'select' ||
                           tag === 'button' || tag === 'a' ||
                           target.closest('input') || target.closest('textarea') ||
                           target.closest('select') || target.closest('button') ||
                           target.closest('a');
                }

                // Mouse events
                scrollable.addEventListener('mousedown', (e) => {
                    if (isFormElement(e.target)) {
                        return; // Allow normal interaction with form elements
                    }

                    isDown = true;
                    scrollable.style.cursor = 'grabbing';
                    startY = e.pageY - scrollable.offsetTop;
                    scrollTop = scrollable.scrollTop;
                    e.preventDefault();
                });

                scrollable.addEventListener('mouseleave', () => {
                    isDown = false;
                    scrollable.style.cursor = 'grab';
                });

                scrollable.addEventListener('mouseup', () => {
                    isDown = false;
                    scrollable.style.cursor = 'grab';
                });

                scrollable.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const y = e.pageY - scrollable.offsetTop;
                    const walk = (y - startY) * 2; // Scroll speed multiplier
                    scrollable.scrollTop = scrollTop - walk;
                });

                // Touch events with improved handling
                scrollable.addEventListener('touchstart', (e) => {
                    if (isFormElement(e.target)) {
                        return; // Allow normal interaction with form elements
                    }

                    // Store the initial touch position and scroll position
                    isDown = true;
                    const touch = e.touches[0];
                    startY = touch.pageY;
                    scrollTop = scrollable.scrollTop;
                }, { passive: true });

                scrollable.addEventListener('touchend', () => {
                    isDown = false;
                }, { passive: true });

                scrollable.addEventListener('touchmove', (e) => {
                    if (!isDown) return;

                    // Calculate distance moved
                    const touch = e.touches[0];
                    const y = touch.pageY;
                    const distance = startY - y;

                    // Apply the scroll
                    scrollable.scrollTop = scrollTop + distance;

                    // Update start position for next move
                    startY = y;
                    scrollTop = scrollable.scrollTop;

                    // Don't prevent default touch scrolling behavior
                }, { passive: true });
            });
        });
    </script>

    <!-- System prompt edit overlay (fixed position, will be shown/hidden with JavaScript) -->
    <div id="system-prompt-overlay" class="fixed inset-0 z-[2000] hidden" style="display: none;">
        <div class="bg-darkSecondary relative z-[2001]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">Edit System Prompt</h2>
            </div>
            <textarea id="system-prompt-editor" class="w-full mb-4" placeholder="Enter your system prompt here..."></textarea>
            <div class="flex justify-between items-center">
                <button id="clear-system-prompt-btn" class="text-red-400 hover:text-red-300 focus:outline-none transition-all duration-300 ease-in-out px-3 py-2 rounded-lg hover:bg-red-900/20 border border-red-800/30 hover:border-red-700/50">
                    <i class="fas fa-trash-alt mr-2"></i>Clear
                </button>
                <div class="flex space-x-4">
                    <button id="cancel-system-prompt-edit">Cancel</button>
                    <button id="save-system-prompt-edit">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>

    <script>
        // Apply touch event handlers to all modal content containers (except whats new modal)
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.modal-content, .overflow-y-auto').forEach(container => {
                // Skip whats new modal as it has its own specialized handling
                if (container && !container.closest('#whats-new-modal')) {
                    // Force enable touch scrolling with inline styles
                    container.style.webkitOverflowScrolling = 'touch';
                    container.style.overflowY = 'auto';
                    container.style.touchAction = 'pan-y';
                    container.style.overscrollBehavior = 'contain';

                    // Add touch event listeners with passive flag to ensure scrolling works
                    container.addEventListener('touchstart', function(e) {
                        // Let browser handle it natively
                    }, { passive: true });

                    container.addEventListener('touchmove', function(e) {
                        // Let browser handle it natively
                    }, { passive: true });
                }
            });
        });
    </script>

    <!-- Optimized touch handling script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get the modal elements
            const helpModal = document.getElementById('help-modal');
            const helpModalContent = helpModal ? helpModal.querySelector('.modal-content') : null;

            if (helpModalContent) {
                // Force browser-native scrolling behavior for touch devices
                helpModalContent.style.webkitOverflowScrolling = 'touch';
                helpModalContent.style.msOverflowStyle = '-ms-autohiding-scrollbar';
                helpModalContent.style.overflowY = 'auto';
                helpModalContent.style.touchAction = 'pan-y';
                helpModalContent.style.overscrollBehavior = 'contain';

                // Remove any drag scroll handling that might interfere with native scrolling
                helpModalContent.classList.remove('drag-scrollable');

                // Ensure all touch events are passive, which helps improve scrolling performance
                // by telling the browser we won't be calling preventDefault()
                const passiveHandler = function(e) { /* Let the browser handle it */ };
                helpModalContent.addEventListener('touchstart', passiveHandler, { passive: true });
                helpModalContent.addEventListener('touchmove', passiveHandler, { passive: true });
                helpModalContent.addEventListener('touchend', passiveHandler, { passive: true });

                // Prevent any parent elements from trapping touch events
                helpModal.addEventListener('touchmove', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }

            // Apply the same fixes to all modal content (except whats new modal which has its own handling)
            document.querySelectorAll('.modal-content').forEach(modal => {
                if (modal !== helpModalContent && !modal.closest('#whats-new-modal')) {
                    // Force browser-native scrolling behavior
                    modal.style.webkitOverflowScrolling = 'touch';
                    modal.style.overflowY = 'auto';
                    modal.style.touchAction = 'pan-y';
                    modal.style.overscrollBehavior = 'contain';

                    // Ensure all touch events are passive
                    const passiveHandler = function(e) { /* Let the browser handle it */ };
                    modal.addEventListener('touchstart', passiveHandler, { passive: true });
                    modal.addEventListener('touchmove', passiveHandler, { passive: true });
                    modal.addEventListener('touchend', passiveHandler, { passive: true });
                }
            });
        });
    </script>

    <!-- Fix for global touch handling -->
    <script>
        // This script disables any document-level handlers that might interfere with scrolling
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure document-level touch events don't block scrolling in modals
            document.addEventListener('touchmove', function(e) {
                // Check if touch is within a modal
                if (e.target.closest('.modal-content') || e.target.closest('.overflow-y-auto')) {
                    // Don't interfere with modal touch events
                    e.stopPropagation();
                }
            }, { passive: true });

            // Disable any document-level default handlers that might block scrolling
            const modalContainers = document.querySelectorAll('.modal-container');
            modalContainers.forEach(container => {
                container.addEventListener('touchmove', function(e) {
                    // Check if touch is within content
                    if (!e.target.closest('.modal-content')) {
                        // If outside content, let it propagate
                        return;
                    }
                    // Otherwise stop it to prevent unintended behavior
                    e.stopPropagation();
                }, { passive: true });
            });
        });
    </script>
</body>
</html>
